`+t)}function Bd(n,e,t,r,s,c){if(n.listenerCount("wsClientError")){let u=new Error(s);Error.captureStackTrace(u,Bd),n.emit("wsClientError",u,t,e)}else Ev(t,r,s,c)}});var S5e,E5e,T5e,tX,C5e,rX,nX=xe(()=>{S5e=Xt(zY(),1),E5e=Xt(LR(),1),T5e=Xt(jR(),1),tX=Xt(U_(),1),C5e=Xt(eX(),1),rX=tX.default});var I5e,W,Ks=xe(()=>{"use strict";T_();kQ();nX();Li();qu.webSocketConstructor=rX;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");I5e=new Fl({connectionString:process.env.DATABASE_URL}),W=I_({client:I5e,schema:b_})});var Cv={};jr(Cv,{decrypt:()=>k5e,encrypt:()=>P5e});function P5e(n){let e=Tv.default.randomBytes(16),t=Tv.default.createCipheriv("aes-256-gcm",sX,e),r=Buffer.concat([t.update(n,"utf8"),t.final()]),s=t.getAuthTag();return Buffer.concat([e,s,r]).toString("base64")}function k5e(n){let e=Buffer.from(n,"base64"),t=e.subarray(0,16),r=e.subarray(16,32),s=e.subarray(32),c=Tv.default.createDecipheriv("aes-256-gcm",sX,t);return c.setAuthTag(r),c.update(s).toString("utf8")+c.final("utf8")}var Tv,iX,sX,Iv=xe(()=>{"use strict";Tv=Xt(require("crypto"),1),iX=process.env.ENCRYPTION_KEY;if(!iX)throw new Error("ENCRYPTION_KEY environment variable is required in production");sX=Tv.default.createHash("sha256").update(iX||"dev-only-key-not-for-production-use").digest()});var WR,q,Jo=xe(()=>{"use strict";Li();Ks();Ji();WR=class{async getUser(e){let[t]=await W.select().from(St).where(se(St.id,e));return t||void 0}async getUserByEmail(e){let[t]=await W.select().from(St).where(se(St.email,e));return t||void 0}async getUserByReferralCode(e){let[t]=await W.select().from(St).where(se(St.referralCode,e));return t||void 0}async createUser(e){let[t]=await W.insert(St).values(e).returning();return t}async getAllAffiliates(){return W.select().from(St).where(se(St.role,"affiliate")).orderBy(ut(St.createdAt))}async updateUserPassword(e,t){let[r]=await W.update(St).set({passwordHash:t}).where(se(St.id,e)).returning();return r||void 0}async updateUserReferralCode(e,t){let[r]=await W.update(St).set({referralCode:t}).where(se(St.id,e)).returning();return r||void 0}async deleteUser(e){await W.delete(St).where(se(St.id,e))}async createAffiliateApplication(e){let[t]=await W.insert(Ca).values(e).returning();return t}async getAffiliateApplication(e){let[t]=await W.select().from(Ca).where(se(Ca.id,e));return t||void 0}async getAllAffiliateApplications(){return W.select().from(Ca).orderBy(ut(Ca.createdAt))}async getAffiliateApplicationsByAssignee(e){return W.select().from(Ca).where(se(Ca.assignedTo,e)).orderBy(ut(Ca.createdAt))}async updateAffiliateApplication(e,t){let[r]=await W.update(Ca).set({...t,updatedAt:new Date}).where(se(Ca.id,e)).returning();return r||void 0}async createHelpRequest(e){let[t]=await W.insert(Ia).values(e).returning();return t}async getHelpRequest(e){let[t]=await W.select().from(Ia).where(se(Ia.id,e));return t||void 0}async getAllHelpRequests(){return W.select().from(Ia).orderBy(ut(Ia.createdAt))}async getHelpRequestsByAssignee(e){return W.select().from(Ia).where(se(Ia.assignedTo,e)).orderBy(ut(Ia.createdAt))}async updateHelpRequest(e,t){let[r]=await W.update(Ia).set({...t,updatedAt:new Date}).where(se(Ia.id,e)).returning();return r||void 0}async createStartupGrant(e){let[t]=await W.insert(Pa).values(e).returning();return t}async getStartupGrant(e){let[t]=await W.select().from(Pa).where(se(Pa.id,e));return t||void 0}async getAllStartupGrants(){return W.select().from(Pa).orderBy(ut(Pa.createdAt))}async getStartupGrantsByAssignee(e){return W.select().from(Pa).where(se(Pa.assignedTo,e)).orderBy(ut(Pa.createdAt))}async updateStartupGrant(e,t){let[r]=await W.update(Pa).set({...t,updatedAt:new Date}).where(se(Pa.id,e)).returning();return r||void 0}async createFurnitureAssistance(e){let[t]=await W.insert(ka).values(e).returning();return t}async getFurnitureAssistance(e){let[t]=await W.select().from(ka).where(se(ka.id,e));return t||void 0}async getAllFurnitureAssistance(){return W.select().from(ka).orderBy(ut(ka.createdAt))}async getFurnitureAssistanceByAssignee(e){return W.select().from(ka).where(se(ka.assignedTo,e)).orderBy(ut(ka.createdAt))}async updateFurnitureAssistance(e,t){let[r]=await W.update(ka).set({...t,updatedAt:new Date}).where(se(ka.id,e)).returning();return r||void 0}async createInvestorSubmission(e){let[t]=await W.insert(Fa).values(e).returning();return t}async getInvestorSubmission(e){let[t]=await W.select().from(Fa).where(se(Fa.id,e));return t||void 0}async getAllInvestorSubmissions(){return W.select().from(Fa).orderBy(ut(Fa.createdAt))}async getInvestorSubmissionsByAssignee(e){return W.select().from(Fa).where(se(Fa.assignedTo,e)).orderBy(ut(Fa.createdAt))}async updateInvestorSubmission(e,t){let[r]=await W.update(Fa).set({...t,updatedAt:new Date}).where(se(Fa.id,e)).returning();return r||void 0}async createPrivateDoctorRequest(e){let[t]=await W.insert(Ra).values(e).returning();return t}async getPrivateDoctorRequest(e){let[t]=await W.select().from(Ra).where(se(Ra.id,e));return t||void 0}async getAllPrivateDoctorRequests(){return W.select().from(Ra).orderBy(ut(Ra.createdAt))}async getPrivateDoctorRequestsByAssignee(e){return W.select().from(Ra).where(se(Ra.assignedTo,e)).orderBy(ut(Ra.createdAt))}async updatePrivateDoctorRequest(e,t){let[r]=await W.update(Ra).set({...t,updatedAt:new Date}).where(se(Ra.id,e)).returning();return r||void 0}async createWebsiteApplication(e){let[t]=await W.insert(Na).values(e).returning();return t}async getWebsiteApplication(e){let[t]=await W.select().from(Na).where(se(Na.id,e));return t||void 0}async getAllWebsiteApplications(){return W.select().from(Na).orderBy(ut(Na.createdAt))}async getWebsiteApplicationsByAssignee(e){return W.select().from(Na).where(se(Na.assignedTo,e)).orderBy(ut(Na.createdAt))}async updateWebsiteApplication(e,t){let[r]=await W.update(Na).set({...t,updatedAt:new Date}).where(se(Na.id,e)).returning();return r||void 0}async createGeneralContact(e){let[t]=await W.insert(Oa).values(e).returning();return t}async getGeneralContact(e){let[t]=await W.select().from(Oa).where(se(Oa.id,e));return t||void 0}async getAllGeneralContacts(){return W.select().from(Oa).orderBy(ut(Oa.createdAt))}async getGeneralContactsByAssignee(e){return W.select().from(Oa).where(se(Oa.assignedTo,e)).orderBy(ut(Oa.createdAt))}async updateGeneralContact(e,t){let[r]=await W.update(Oa).set({...t,updatedAt:new Date}).where(se(Oa.id,e)).returning();return r||void 0}async createVltIntake(e){let t=e.issue==="credits"?"CPA":e.issue==="resolution"?"Tax Attorney":"General";console.log("NEW LEAD:",{...e,routedTo:t,timestamp:new Date().toISOString()});let[r]=await W.insert(Zi).values({...e,routedTo:t}).returning();return r}async getVltIntake(e){let[t]=await W.select().from(Zi).where(se(Zi.id,e));return t||void 0}async getAllVltIntakes(){return W.select().from(Zi).orderBy(ut(Zi.createdAt))}async updateVltIntake(e,t){let[r]=await W.update(Zi).set(t).where(se(Zi.id,e)).returning();return r||void 0}async getVltIntakesByAffiliate(e){return W.select().from(Zi).where(od(se(Zi.referredByL1,e),se(Zi.referredByL2,e),se(Zi.referredByL3,e),se(Zi.referredByL4,e),se(Zi.referredByL5,e),se(Zi.referredByL6,e))).orderBy(ut(Zi.createdAt))}async createVltAffiliate(e){let[t]=await W.insert(Pr).values(e).returning();return t}async getVltAffiliate(e){let[t]=await W.select().from(Pr).where(se(Pr.id,e));return t||void 0}async getVltAffiliateByEmail(e){let[t]=await W.select().from(Pr).where(se(Pr.email,e));return t||void 0}async getVltAffiliateByReferralCode(e){let[t]=await W.select().from(Pr).where(se(Pr.referralCode,e));return t||void 0}async getAllVltAffiliates(){return W.select().from(Pr).orderBy(ut(Pr.createdAt))}async updateVltAffiliate(e,t){let[r]=await W.update(Pr).set({...t,updatedAt:new Date}).where(se(Pr.id,e)).returning();return r||void 0}async deleteVltAffiliate(e){await W.delete(Pr).where(se(Pr.id,e))}async getVltAffiliatesByRole(e){return W.select().from(Pr).where(se(Pr.role,e)).orderBy(ut(Pr.createdAt))}async getVltAffiliateDownline(e){return W.select().from(Pr).where(od(se(Pr.level1Id,e),se(Pr.level2Id,e),se(Pr.level3Id,e),se(Pr.level4Id,e),se(Pr.level5Id,e),se(Pr.level6Id,e),se(Pr.level7Id,e))).orderBy(ut(Pr.createdAt))}async createOpportunity(e){let[t]=await W.insert(da).values(e).returning();return t}async getOpportunity(e){let[t]=await W.select().from(da).where(se(da.id,e));return t||void 0}async getAllOpportunities(){return W.select().from(da).orderBy(ut(da.createdAt))}async getOpportunitiesByCategory(e){return W.select().from(da).where(se(da.category,e)).orderBy(ut(da.createdAt))}async updateOpportunity(e,t){let[r]=await W.update(da).set(t).where(se(da.id,e)).returning();return r||void 0}async createSale(e){let[t]=await W.insert(qn).values(e).returning();return t}async getSale(e){let[t]=await W.select().from(qn).where(se(qn.id,e));return t||void 0}async getAllSales(){return W.select().from(qn).orderBy(ut(qn.createdAt))}async getSalesByAffiliate(e){return W.select().from(qn).where(se(qn.affiliateId,e)).orderBy(ut(qn.createdAt))}async getSalesByDownline(e){return W.select().from(qn).where(od(se(qn.referredByL1,e),se(qn.referredByL2,e),se(qn.referredByL3,e),se(qn.referredByL4,e),se(qn.referredByL5,e),se(qn.referredByL6,e),se(qn.referredByL7,e))).orderBy(ut(qn.createdAt))}async updateSale(e,t){let[r]=await W.update(qn).set({...t,updatedAt:new Date}).where(se(qn.id,e)).returning();return r||void 0}async createCommission(e){let[t]=await W.insert(pa).values(e).returning();return t}async getCommission(e){let[t]=await W.select().from(pa).where(se(pa.id,e));return t||void 0}async getCommissionsByAffiliate(e){return W.select().from(pa).where(se(pa.affiliateId,e)).orderBy(ut(pa.createdAt))}async getCommissionsBySale(e){return W.select().from(pa).where(se(pa.saleId,e)).orderBy(ut(pa.createdAt))}async updateCommission(e,t){let[r]=await W.update(pa).set(t).where(se(pa.id,e)).returning();return r||void 0}async createVeteranIntake(e){let[t]=await W.insert(Da).values(e).returning();return t}async getVeteranIntake(e){let[t]=await W.select().from(Da).where(se(Da.id,e));return t||void 0}async getAllVeteranIntakes(){return W.select().from(Da).orderBy(ut(Da.createdAt))}async getVeteranIntakesByProgram(e){return W.select().from(Da).where(se(Da.programType,e)).orderBy(ut(Da.createdAt))}async updateVeteranIntake(e,t){let[r]=await W.update(Da).set({...t,updatedAt:new Date}).where(se(Da.id,e)).returning();return r||void 0}async createBusinessIntake(e){let[t]=await W.insert(La).values(e).returning();return t}async getBusinessIntake(e){let[t]=await W.select().from(La).where(se(La.id,e));return t||void 0}async getAllBusinessIntakes(){return W.select().from(La).orderBy(ut(La.createdAt))}async getBusinessIntakesByService(e){return W.select().from(La).where(se(La.serviceType,e)).orderBy(ut(La.createdAt))}async updateBusinessIntake(e,t){let[r]=await W.update(La).set({...t,updatedAt:new Date}).where(se(La.id,e)).returning();return r||void 0}async createContractTemplate(e){let[t]=await W.insert(ha).values(e).returning();return t}async getContractTemplate(e){let[t]=await W.select().from(ha).where(se(ha.id,e));return t||void 0}async getAllContractTemplates(){return W.select().from(ha).orderBy(ut(ha.createdAt))}async getActiveContractTemplates(){return W.select().from(ha).where(se(ha.isActive,"true")).orderBy(ut(ha.createdAt))}async updateContractTemplate(e,t){let[r]=await W.update(ha).set({...t,updatedAt:new Date}).where(se(ha.id,e)).returning();return r||void 0}async createSignedAgreement(e){let[t]=await W.insert(ki).values(e).returning();return t}async getSignedAgreement(e){let[t]=await W.select().from(ki).where(se(ki.id,e));return t||void 0}async getAllSignedAgreements(){return W.select().from(ki).orderBy(ut(ki.signedAt))}async getSignedAgreementsByAffiliate(e){return W.select().from(ki).where(se(ki.affiliateId,e)).orderBy(ut(ki.signedAt))}async hasAffiliateSignedContract(e,t){let[r]=await W.select().from(ki).where(Sr(se(ki.affiliateId,e),se(ki.contractTemplateId,t),se(ki.status,"signed")));return!!r}async updateSignedAgreement(e,t){let[r]=await W.update(ki).set(t).where(se(ki.id,e)).returning();return r||void 0}async createCommissionConfig(e){let[t]=await W.insert(El).values(e).returning();return t}async getActiveCommissionConfig(){let[e]=await W.select().from(El).where(se(El.isActive,"true")).orderBy(ut(El.createdAt)).limit(1);return e||void 0}async updateCommissionConfig(e,t){let[r]=await W.update(El).set({...t,updatedAt:new Date}).where(se(El.id,e)).returning();return r||void 0}async createAffiliateNda(e){let[t]=await W.insert(Fi).values(e).returning();return t}async getAffiliateNdaByUserId(e){let[t]=await W.select().from(Fi).where(se(Fi.userId,e));return t||void 0}async getAffiliateNdaById(e){let[t]=await W.select().from(Fi).where(se(Fi.id,e));return t||void 0}async hasAffiliateSignedNda(e){return!!await this.getAffiliateNdaByUserId(e)}async getAllAffiliateNdas(){return W.select().from(Fi).orderBy(ut(Fi.signedAt))}async signNdaAtomic(e,t,r){return await W.transaction(async s=>{let[c]=await s.select().from(Fi).where(se(Fi.userId,e));if(c)return{nda:c,alreadySigned:!0};await s.update(St).set({referralCode:t}).where(se(St.id,e));let[u]=await s.insert(Fi).values(r).returning();return{nda:u,alreadySigned:!1}})}async createBusinessLead(e){let[t]=await W.insert(Is).values(e).returning();return t}async getBusinessLead(e){let[t]=await W.select().from(Is).where(se(Is.id,e));return t||void 0}async getAllBusinessLeads(){return W.select().from(Is).orderBy(ut(Is.createdAt))}async getBusinessLeadsByType(e){return W.select().from(Is).where(se(Is.leadType,e)).orderBy(ut(Is.createdAt))}async getBusinessLeadsByReferrer(e){return W.select().from(Is).where(se(Is.referredBy,e)).orderBy(ut(Is.createdAt))}async updateBusinessLead(e,t){let[r]=await W.update(Is).set({...t,updatedAt:new Date}).where(se(Is.id,e)).returning();return r||void 0}async createIpReferralTracking(e){let[t]=await W.insert(Ma).values(e).returning();return t}async getActiveIpReferral(e){let t=new Date,[r]=await W.select().from(Ma).where(Sr(se(Ma.ipAddress,e),cd(Ma.expiresAt,t))).orderBy(ut(Ma.createdAt)).limit(1);return r||void 0}async getIpReferralsByAffiliate(e){return W.select().from(Ma).where(se(Ma.affiliateId,e)).orderBy(ut(Ma.createdAt))}async getAllIpReferrals(){return W.select().from(Ma).orderBy(ut(Ma.createdAt))}async createAffiliateW9(e){let[t]=await W.insert(Id).values(e).returning();return t}async getAffiliateW9ByUserId(e){let[t]=await W.select().from(Id).where(se(Id.userId,e));return t||void 0}async hasAffiliateSubmittedW9(e){return!!await this.getAffiliateW9ByUserId(e)}async getAllAffiliateW9s(){return await W.select().from(Id)}async createFinopsReferral(e){let[t]=await W.insert(Ps).values(e).returning();return t}async getFinopsReferral(e){let[t]=await W.select().from(Ps).where(se(Ps.id,e));return t||void 0}async getAllFinopsReferrals(){return W.select().from(Ps).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByAffiliate(e){return W.select().from(Ps).where(se(Ps.affiliateId,e)).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByPartnerType(e){return W.select().from(Ps).where(se(Ps.partnerType,e)).orderBy(ut(Ps.createdAt))}async updateFinopsReferral(e,t){let[r]=await W.update(Ps).set(t).where(se(Ps.id,e)).returning();return r||void 0}async createDisabilityReferral(e){let[t]=await W.insert(ma).values(e).returning();return t}async getDisabilityReferral(e){let[t]=await W.select().from(ma).where(se(ma.id,e));return t||void 0}async getAllDisabilityReferrals(){return W.select().from(ma).orderBy(ut(ma.createdAt))}async getDisabilityReferralsByAffiliate(e){return W.select().from(ma).where(se(ma.affiliateId,e)).orderBy(ut(ma.createdAt))}async updateDisabilityReferral(e,t){let[r]=await W.update(ma).set({...t,updatedAt:new Date}).where(se(ma.id,e)).returning();return r||void 0}async getDisabilityReferralStats(){let e=await W.select().from(ma),t={},r={};for(let s of e)t[s.claimType]=(t[s.claimType]||0)+1,r[s.status]=(r[s.status]||0)+1;return{total:e.length,byType:t,byStatus:r}}async createJobPlacementIntake(e){let[t]=await W.insert(Ba).values(e).returning();return t}async getJobPlacementIntake(e){let[t]=await W.select().from(Ba).where(se(Ba.id,e));return t||void 0}async getAllJobPlacementIntakes(){return W.select().from(Ba).orderBy(ut(Ba.createdAt))}async getJobPlacementIntakesByAffiliate(e){return W.select().from(Ba).where(se(Ba.affiliateId,e)).orderBy(ut(Ba.createdAt))}async updateJobPlacementIntake(e,t){let[r]=await W.update(Ba).set({...t,updatedAt:new Date}).where(se(Ba.id,e)).returning();return r||void 0}async createVetProfessionalIntake(e){let[t]=await W.insert(ja).values(e).returning();return t}async getVetProfessionalIntake(e){let[t]=await W.select().from(ja).where(se(ja.id,e));return t||void 0}async getAllVetProfessionalIntakes(){return W.select().from(ja).orderBy(ut(ja.createdAt))}async getVetProfessionalIntakesByAffiliate(e){return W.select().from(ja).where(se(ja.affiliateId,e)).orderBy(ut(ja.createdAt))}async updateVetProfessionalIntake(e,t){let[r]=await W.update(ja).set({...t,updatedAt:new Date}).where(se(ja.id,e)).returning();return r||void 0}async createHealthcareIntake(e){let[t]=await W.insert(Ou).values(e).returning();return t}async getAllHealthcareIntakes(){return W.select().from(Ou).orderBy(ut(Ou.createdAt))}async updateHealthcareIntake(e,t){let[r]=await W.update(Ou).set({...t,updatedAt:new Date}).where(se(Ou.id,e)).returning();return r||void 0}async createScheduleASignature(e){let[t]=await W.insert(Du).values(e).returning();return t}async getScheduleASignatureByUserId(e){let[t]=await W.select().from(Du).where(se(Du.userId,e));return t||void 0}async getAllScheduleASignatures(){return W.select().from(Du).orderBy(ut(Du.signedAt))}async createInsuranceIntake(e){let[t]=await W.insert(Lu).values(e).returning();return t}async getAllInsuranceIntakes(){return W.select().from(Lu).orderBy(ut(Lu.createdAt))}async updateInsuranceIntake(e,t){let[r]=await W.update(Lu).set({...t,updatedAt:new Date}).where(se(Lu.id,e)).returning();return r||void 0}async createMedicalSalesIntake(e){let[t]=await W.insert(qo).values(e).returning();return t}async getAllMedicalSalesIntakes(){return W.select().from(qo).orderBy(ut(qo.createdAt))}async getMedicalSalesIntakesByAffiliate(e){return W.select().from(qo).where(se(qo.assignedTo,e)).orderBy(ut(qo.createdAt))}async updateMedicalSalesIntake(e,t){let[r]=await W.update(qo).set({...t,updatedAt:new Date}).where(se(qo.id,e)).returning();return r||void 0}async createBusinessDevIntake(e){let[t]=await W.insert($o).values(e).returning();return t}async getAllBusinessDevIntakes(){return W.select().from($o).orderBy(ut($o.createdAt))}async getBusinessDevIntakesByAffiliate(e){return W.select().from($o).where(se($o.assignedTo,e)).orderBy(ut($o.createdAt))}async updateBusinessDevIntake(e,t){let[r]=await W.update($o).set({...t,updatedAt:new Date}).where(se($o.id,e)).returning();return r||void 0}async getUserById(e){return this.getUser(e)}async createCsuContractTemplate(e){let[t]=await W.insert($r).values(e).returning();return t}async getCsuContractTemplate(e){let[t]=await W.select().from($r).where(se($r.id,e));return t||void 0}async getAllCsuContractTemplates(){return W.select().from($r).orderBy(ut($r.createdAt))}async getActiveCsuContractTemplates(){return W.select().from($r).where(se($r.isActive,!0)).orderBy(ut($r.createdAt))}async updateCsuContractTemplate(e,t){let[r]=await W.update($r).set({...t,updatedAt:new Date}).where(se($r.id,e)).returning();return r||void 0}async getActiveTemplatesByPortal(e){return W.select().from($r).where(Sr(se($r.isActive,!0),od(se($r.portal,e),ml($r.portal)))).orderBy(ut($r.createdAt))}async deleteCsuContractTemplate(e){await W.delete($r).where(se($r.id,e))}async createCsuContractTemplateField(e){let[t]=await W.insert(Ua).values(e).returning();return t}async getCsuContractTemplateFields(e){return W.select().from(Ua).where(se(Ua.templateId,e)).orderBy(Ua.order)}async updateCsuContractTemplateField(e,t){let[r]=await W.update(Ua).set(t).where(se(Ua.id,e)).returning();return r||void 0}async deleteCsuContractTemplateField(e){await W.delete(Ua).where(se(Ua.id,e))}async deleteAllCsuContractTemplateFields(e){await W.delete(Ua).where(se(Ua.templateId,e))}async createCsuContractSend(e){let[t]=await W.insert(ga).values(e).returning();return t}async getCsuContractSend(e){let[t]=await W.select().from(ga).where(se(ga.id,e));return t||void 0}async getCsuContractSendByToken(e){let[t]=await W.select().from(ga).where(se(ga.signToken,e));return t||void 0}async getAllCsuContractSends(){return W.select().from(ga).orderBy(ut(ga.createdAt))}async updateCsuContractSend(e,t){let[r]=await W.update(ga).set(t).where(se(ga.id,e)).returning();return r||void 0}async createCsuSignedAgreement(e){let[t]=await W.insert(Cn).values(e).returning();return t}async getCsuSignedAgreement(e){let[t]=await W.select().from(Cn).where(se(Cn.id,e));return t||void 0}async getAllCsuSignedAgreements(){return await W.select({id:Cn.id,contractSendId:Cn.contractSendId,templateId:Cn.templateId,signerName:Cn.signerName,signerEmail:Cn.signerEmail,signerPhone:Cn.signerPhone,address:Cn.address,initials:Cn.initials,effectiveDate:Cn.effectiveDate,signatureData:Cn.signatureData,signedIpAddress:Cn.signedIpAddress,agreedToTerms:Cn.agreedToTerms,signedAt:Cn.signedAt,createdAt:Cn.createdAt,templateName:$r.name}).from(Cn).leftJoin($r,se(Cn.templateId,$r.id)).orderBy(ut(Cn.createdAt))}async createPortalActivity(e){let[t]=await W.insert(Cl).values(e).returning();return t}async getPortalActivity(e,t){return W.select().from(Cl).where(se(Cl.portal,e)).orderBy(ut(Cl.createdAt)).limit(t)}async getPortalStats(e){let t=await W.select().from(Cl).where(se(Cl.portal,e)),r=new Date;r.setHours(0,0,0,0);let s=t.filter(v=>new Date(v.createdAt)>=r),c=t.filter(v=>v.eventType==="page_view"),u=new Set(c.map(v=>v.ipAddress).filter(Boolean)),d=t.filter(v=>v.eventType==="contract_sent").length,m=t.filter(v=>v.eventType==="contract_signed").length;return{totalVisits:c.length,uniqueIps:u.size,contractsSent:d,contractsSigned:m,todayVisits:s.filter(v=>v.eventType==="page_view").length}}async createPasswordResetToken(e){let[t]=await W.insert(qa).values(e).returning();return t}async getValidPasswordResetToken(e){let t=new Date,[r]=await W.select().from(qa).where(Sr(se(qa.tokenHash,e),ml(qa.usedAt),cd(qa.expiresAt,t)));return r||void 0}async invalidatePasswordResetToken(e){await W.update(qa).set({usedAt:new Date}).where(se(qa.id,e))}async invalidateAllUserPasswordResetTokens(e){await W.update(qa).set({usedAt:new Date}).where(Sr(se(qa.userId,e),ml(qa.usedAt)))}async createPartnerSharingLog(e){let[t]=await W.insert(Fc).values(e).returning();return t}async getPartnerSharingLogsBySubmission(e,t){return await W.select().from(Fc).where(Sr(se(Fc.submissionType,e),se(Fc.submissionId,t))).orderBy(ut(Fc.sharedAt))}async getAllPartnerSharingLogs(){return await W.select().from(Fc).orderBy(ut(Fc.sharedAt))}async createConsentRecord(e){let[t]=await W.insert($a).values(e).returning();return t}async getConsentRecordsBySubmission(e,t){return await W.select().from($a).where(Sr(se($a.submissionType,e),se($a.submissionId,t))).orderBy(ut($a.submittedAt))}async getConsentRecordByEmail(e){return await W.select().from($a).where(se($a.email,e)).orderBy(ut($a.submittedAt))}async getAllConsentRecords(){return await W.select().from($a).orderBy(ut($a.submittedAt))}async createAffiliatedPartner(e){let[t]=await W.insert(Ha).values(e).returning();return t}async getActiveAffiliatedPartners(){return await W.select().from(Ha).where(se(Ha.isActive,!0)).orderBy(Ha.category,Ha.displayName)}async getAllAffiliatedPartners(){return await W.select().from(Ha).orderBy(Ha.category,Ha.displayName)}async updateAffiliatedPartner(e,t){let[r]=await W.update(Ha).set(t).where(se(Ha.id,e)).returning();return r||void 0}async createRangerTabApplication(e){let[t]=await W.insert(Bu).values(e).returning();return t}async getAllRangerTabApplications(){return W.select().from(Bu).orderBy(ut(Bu.createdAt))}async updateRangerTabApplication(e,t){let[r]=await W.update(Bu).set({...t,updatedAt:new Date}).where(se(Bu.id,e)).returning();return r||void 0}async createCsuEnvelope(e){let[t]=await W.insert(wo).values(e).returning();return t}async getCsuEnvelope(e){let[t]=await W.select().from(wo).where(se(wo.id,e));return t||void 0}async getAllCsuEnvelopes(){return W.select().from(wo).orderBy(ut(wo.createdAt))}async updateCsuEnvelope(e,t){let[r]=await W.update(wo).set({...t,updatedAt:new Date}).where(se(wo.id,e)).returning();return r||void 0}async createCsuEnvelopeRecipient(e){let[t]=await W.insert(ya).values(e).returning();return t}async getCsuEnvelopeRecipient(e){let[t]=await W.select().from(ya).where(se(ya.id,e));return t||void 0}async getCsuEnvelopeRecipientByToken(e){let[t]=await W.select().from(ya).where(se(ya.signToken,e));return t||void 0}async getEnvelopeRecipients(e){return W.select().from(ya).where(se(ya.envelopeId,e)).orderBy(ya.routingOrder)}async updateCsuEnvelopeRecipient(e,t){let[r]=await W.update(ya).set(t).where(se(ya.id,e)).returning();return r||void 0}async createCsuAuditTrail(e){let[t]=await W.insert(kc).values(e).returning();return t}async getAuditTrailForEnvelope(e){return W.select().from(kc).where(se(kc.envelopeId,e)).orderBy(ut(kc.createdAt))}async getAuditTrailForContractSend(e){return W.select().from(kc).where(se(kc.contractSendId,e)).orderBy(ut(kc.createdAt))}async createHipaaAuditLog(e){let[t]=await W.insert(Ri).values(e).returning();return t}async getHipaaAuditLogs(e=1e3){return W.select().from(Ri).orderBy(ut(Ri.timestamp)).limit(e)}async getHipaaAuditLogsByUser(e){return W.select().from(Ri).where(se(Ri.userId,e)).orderBy(ut(Ri.timestamp))}async getHipaaAuditLogsByResource(e,t){return t?W.select().from(Ri).where(Sr(se(Ri.resourceType,e),se(Ri.resourceId,t))).orderBy(ut(Ri.timestamp)):W.select().from(Ri).where(se(Ri.resourceType,e)).orderBy(ut(Ri.timestamp))}async getHipaaPhiAccessLogs(){return W.select().from(Ri).where(se(Ri.phiAccessed,!0)).orderBy(ut(Ri.timestamp))}async createHipaaTrainingRecord(e){let[t]=await W.insert(Va).values(e).returning();return t}async getHipaaTrainingRecordsByUser(e){return W.select().from(Va).where(se(Va.userId,e)).orderBy(ut(Va.completedAt))}async getAllHipaaTrainingRecords(){return W.select().from(Va).orderBy(ut(Va.completedAt))}async getExpiredTrainingRecords(){let e=new Date;return W.select().from(Va).where(Sr(se(Va.passed,!0),ld(Va.expiresAt,e))).orderBy(ut(Va.expiresAt))}async createBusinessAssociateAgreement(e){let[t]=await W.insert(Rc).values(e).returning();return t}async getBusinessAssociateAgreement(e){let[t]=await W.select().from(Rc).where(se(Rc.id,e));return t||void 0}async getAllBusinessAssociateAgreements(){return W.select().from(Rc).orderBy(ut(Rc.updatedAt))}async updateBusinessAssociateAgreement(e,t){let[r]=await W.update(Rc).set({...t,updatedAt:new Date}).where(se(Rc.id,e)).returning();return r||void 0}async createUserMfaConfig(e){let[t]=await W.insert(ju).values(e).returning();return t}async getUserMfaConfig(e){let[t]=await W.select().from(ju).where(se(ju.userId,e));return t||void 0}async updateUserMfaConfig(e,t){let[r]=await W.update(ju).set({...t,updatedAt:new Date}).where(se(ju.userId,e)).returning();return r||void 0}async getAuthRateLimit(e,t,r){let[s]=await W.select().from(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)));return s||void 0}async createOrUpdateAuthRateLimit(e){let t=await this.getAuthRateLimit(e.identifier,e.identifierType,e.attemptType);if(t){let[s]=await W.update(va).set({failedAttempts:e.failedAttempts,lastAttemptAt:new Date,lockedUntil:e.lockedUntil,updatedAt:new Date}).where(se(va.id,t.id)).returning();return s}let[r]=await W.insert(va).values({...e,lastAttemptAt:new Date}).returning();return r}async resetAuthRateLimit(e,t,r){await W.delete(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)))}async createAiGeneration(e){let[t]=await W.insert(ai).values(e).returning();return t}async getAiGeneration(e){let[t]=await W.select().from(ai).where(se(ai.id,e));return t||void 0}async getAiGenerationsByUser(e){return W.select().from(ai).where(se(ai.userId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsBySession(e){return W.select().from(ai).where(se(ai.sessionId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsByStatus(e){return W.select().from(ai).where(se(ai.status,e)).orderBy(ai.createdAt)}async updateAiGeneration(e,t){let[r]=await W.update(ai).set({...t,updatedAt:new Date}).where(se(ai.id,e)).returning();return r||void 0}async deleteAiGeneration(e){await W.delete(ai).where(se(ai.id,e))}async getAllAiGenerations(e=100){return W.select().from(ai).orderBy(ut(ai.createdAt)).limit(e)}async createAiTemplate(e){let[t]=await W.insert($n).values(e).returning();return t}async getAiTemplate(e){let[t]=await W.select().from($n).where(se($n.id,e));return t||void 0}async getAllAiTemplates(){return W.select().from($n).orderBy(ut($n.usageCount))}async getActiveAiTemplates(){return W.select().from($n).where(se($n.isActive,!0)).orderBy(ut($n.usageCount))}async getAiTemplatesByCategory(e){return W.select().from($n).where(Sr(se($n.category,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async getAiTemplatesByType(e){return W.select().from($n).where(Sr(se($n.type,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async updateAiTemplate(e,t){let[r]=await W.update($n).set({...t,updatedAt:new Date}).where(se($n.id,e)).returning();return r||void 0}async incrementTemplateUsage(e){let t=await this.getAiTemplate(e);t&&await W.update($n).set({usageCount:(t.usageCount||0)+1,updatedAt:new Date}).where(se($n.id,e))}async saveOperatorAiMessage(e){let[t]=await W.insert(Ni).values(e).returning();return t}async getSessionMemory(e){return W.select().from(Ni).where(se(Ni.sessionId,e)).orderBy(Ni.messageOrder)}async getUserPersistentMemory(e){return W.select().from(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent"))).orderBy(Ni.messageOrder)}async clearSessionMemory(e){await W.delete(Ni).where(se(Ni.sessionId,e))}async clearUserPersistentMemory(e){await W.delete(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent")))}async cleanupExpiredSessions(){await W.delete(Ni).where(Sr(se(Ni.memoryMode,"session"),ld(Ni.expiresAt,new Date)))}async getOrCreateAiUser(e,t){if(e){let s=await W.select().from(In).where(se(In.email,e));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}if(t){let s=await W.select().from(In).where(se(In.anonDeviceId,t));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}let[r]=await W.insert(In).values({email:e||null,anonDeviceId:t||null,memoryMode:"OFF"}).returning();return r}async getAiUser(e){let[t]=await W.select().from(In).where(se(In.id,e));return t||void 0}async getAiUserByEmail(e){let[t]=await W.select().from(In).where(se(In.email,e));return t||void 0}async updateAiUserMemoryMode(e,t){let[r]=await W.update(In).set({memoryMode:t,lastActiveAt:new Date}).where(se(In.id,e)).returning();return r||void 0}async deleteAiUser(e){await W.delete(In).where(se(In.id,e))}async createAiSession(e){let[t]=await W.insert(oi).values(e).returning();return t}async getAiSession(e){let[t]=await W.select().from(oi).where(se(oi.id,e));return t||void 0}async getAiSessionByToken(e){let[t]=await W.select().from(oi).where(se(oi.sessionToken,e));return t||void 0}async getUserAiSessions(e){return W.select().from(oi).where(se(oi.userId,e)).orderBy(ut(oi.createdAt))}async endAiSession(e){await W.update(oi).set({endedAt:new Date}).where(se(oi.id,e))}async deleteAiSession(e){await W.delete(_o).where(se(_o.sessionId,e)),await W.delete(oi).where(se(oi.id,e))}async createAiMessage(e){let[t]=await W.insert(_o).values(e).returning();return await W.update(oi).set({lastMessageAt:new Date}).where(se(oi.id,e.sessionId)),t}async getAiSessionMessages(e){return W.select().from(_o).where(se(_o.sessionId,e)).orderBy(_o.createdAt)}async deleteAiSessionMessages(e){await W.delete(_o).where(se(_o.sessionId,e))}async createAiFile(e){let[t]=await W.insert(us).values(e).returning();return t}async getAiFile(e){let[t]=await W.select().from(us).where(Sr(se(us.id,e),ml(us.deletedAt)));return t||void 0}async getSessionAiFiles(e){return W.select().from(us).where(Sr(se(us.sessionId,e),ml(us.deletedAt)))}async getUserAiFiles(e){return W.select().from(us).where(Sr(se(us.ownerUserId,e),ml(us.deletedAt)))}async softDeleteAiFile(e){await W.update(us).set({deletedAt:new Date}).where(se(us.id,e))}async deleteSessionAiFiles(e){await W.update(us).set({deletedAt:new Date}).where(se(us.sessionId,e))}async setAiMemory(e,t,r,s){let c=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));if(c[0]){let[d]=await W.update(bi).set({value:r,sourceMessageId:s,updatedAt:new Date}).where(se(bi.id,c[0].id)).returning();return d}let[u]=await W.insert(bi).values({userId:e,key:t,value:r,sourceMessageId:s}).returning();return u}async getAiMemory(e,t){let[r]=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));return r||void 0}async getAllAiMemories(e){return W.select().from(bi).where(se(bi.userId,e)).orderBy(bi.key)}async deleteAiMemory(e,t){await W.delete(bi).where(Sr(se(bi.userId,e),se(bi.key,t)))}async clearAllAiMemories(e){await W.delete(bi).where(se(bi.userId,e))}async createAiJob(e){let[t]=await W.insert(Oi).values(e).returning();return t}async getAiJob(e){let[t]=await W.select().from(Oi).where(se(Oi.id,e));return t||void 0}async getUserAiJobs(e){return W.select().from(Oi).where(se(Oi.userId,e)).orderBy(ut(Oi.createdAt))}async getSessionAiJobs(e){return W.select().from(Oi).where(se(Oi.sessionId,e)).orderBy(ut(Oi.createdAt))}async getQueuedAiJobs(){return W.select().from(Oi).where(se(Oi.status,"QUEUED")).orderBy(Oi.createdAt)}async updateAiJobStatus(e,t,r,s){let c={status:t};t==="RUNNING"&&(c.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(c.completedAt=new Date,c.progress=t==="DONE"?100:void 0),r&&(c.output=r),s&&(c.errorMessage=s);let[u]=await W.update(Oi).set(c).where(se(Oi.id,e)).returning();return u||void 0}async updateAiJobProgress(e,t){await W.update(Oi).set({progress:Math.min(100,Math.max(0,t))}).where(se(Oi.id,e))}async createMediaPipeline(e){let[t]=await W.insert(fs).values(e).returning();return t}async getMediaPipeline(e){let[t]=await W.select().from(fs).where(se(fs.id,e));return t||void 0}async getUserPipelines(e){return W.select().from(fs).where(se(fs.userId,e)).orderBy(ut(fs.createdAt))}async updatePipelineStatus(e,t,r){let s={status:t};t==="RUNNING"&&(s.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(s.completedAt=new Date),r&&(s.errorMessage=r),await W.update(fs).set(s).where(se(fs.id,e))}async updatePipelineProgress(e,t,r){await W.update(fs).set({completedSteps:t,progress:Math.min(100,Math.max(0,r))}).where(se(fs.id,e))}async updatePipelineFinalArtifact(e,t,r){await W.update(fs).set({finalArtifactUrl:t,finalArtifactType:r}).where(se(fs.id,e))}async createPipelineStep(e){let[t]=await W.insert(ks).values(e).returning();return t}async getPipelineSteps(e){return W.select().from(ks).where(se(ks.pipelineId,e)).orderBy(ks.stepOrder)}async updatePipelineStepStatus(e,t){let r={status:t};t==="RUNNING"&&(r.startedAt=new Date),(t==="DONE"||t==="FAILED"||t==="SKIPPED")&&(r.completedAt=new Date),await W.update(ks).set(r).where(se(ks.id,e))}async updatePipelineStepProgress(e,t){await W.update(ks).set({progress:Math.min(100,Math.max(0,t))}).where(se(ks.id,e))}async updatePipelineStepComplete(e,t,r){await W.update(ks).set({status:"DONE",progress:100,completedAt:new Date,outputData:t?JSON.stringify(t):null,artifactUrls:r?JSON.stringify(r):null}).where(se(ks.id,e))}async updatePipelineStepFailed(e,t){await W.update(ks).set({status:"FAILED",completedAt:new Date,errorMessage:t}).where(se(ks.id,e))}async createPipelineArtifact(e){let[t]=await W.insert(Nc).values(e).returning();return t}async getPipelineArtifacts(e){return W.select().from(Nc).where(se(Nc.pipelineId,e)).orderBy(Nc.createdAt)}async getFinalArtifact(e){let[t]=await W.select().from(Nc).where(Sr(se(Nc.pipelineId,e),se(Nc.isFinal,!0)));return t||void 0}async getClaimCasesByUserId(e){return W.select().from(Di).where(se(Di.veteranUserId,e)).orderBy(ut(Di.createdAt))}async getClaimCaseById(e){let[t]=await W.select().from(Di).where(se(Di.id,e));return t||void 0}async createClaimCase(e){let[t]=await W.insert(Di).values(e).returning();return t}async updateClaimCase(e,t){let[r]=await W.update(Di).set({...t,updatedAt:new Date}).where(se(Di.id,e)).returning();return r||void 0}async getClaimTasksByCaseId(e){return W.select().from(zo).where(se(zo.caseId,e)).orderBy(zo.sortOrder)}async getClaimTaskById(e){let[t]=await W.select().from(zo).where(se(zo.id,e));return t||void 0}async createClaimTask(e){let[t]=await W.insert(zo).values(e).returning();return t}async updateClaimTask(e,t){let[r]=await W.update(zo).set(t).where(se(zo.id,e)).returning();return r||void 0}async getCaseNotesByCaseId(e){return W.select().from(Pd).where(se(Pd.caseId,e)).orderBy(ut(Pd.createdAt))}async createCaseNote(e){let[t]=await W.insert(Pd).values(e).returning();return t}async getCaseDeadlinesByCaseId(e){return W.select().from(Pl).where(se(Pl.caseId,e)).orderBy(Pl.dueDate)}async createCaseDeadline(e){let[t]=await W.insert(Pl).values(e).returning();return t}async updateCaseDeadline(e,t){let[r]=await W.update(Pl).set(t).where(se(Pl.id,e)).returning();return r||void 0}async getClaimFilesByCaseId(e){return W.select().from(Il).where(se(Il.caseId,e)).orderBy(ut(Il.createdAt))}async createClaimFile(e){let[t]=await W.insert(Il).values(e).returning();return t}async getCaseSharesByCaseId(e){return W.select().from(es).where(se(es.caseId,e)).orderBy(ut(es.createdAt))}async getCaseShareByEmail(e,t){let[r]=await W.select().from(es).where(Sr(se(es.caseId,e),se(es.email,t)));return r}async getAllCaseShares(){return W.select().from(es).orderBy(ut(es.createdAt))}async upsertCaseShare(e){let t=await this.getCaseShareByEmail(e.caseId,e.email);if(t){let[s]=await W.update(es).set({role:e.role}).where(se(es.id,t.id)).returning();return s}let[r]=await W.insert(es).values(e).returning();return r}async getCaseShareById(e){let[t]=await W.select().from(es).where(se(es.id,e));return t}async deleteCaseShare(e){await W.delete(es).where(se(es.id,e))}async getEvidenceRequirements(e,t){return W.select().from(Go).where(Sr(se(Go.track,e),se(Go.purpose,t))).orderBy(Go.priority)}async getAllEvidenceRequirements(){return W.select().from(Go).orderBy(Go.track,Go.purpose,Go.priority)}async updateClaimFileEvidence(e,t){let[r]=await W.update(Il).set(t).where(se(Il.id,e)).returning();return r}async createVendorMagicLink(e){let[t]=await W.insert(Ao).values(e).returning();return t}async getVendorMagicLinkByToken(e){let[t]=await W.select().from(Ao).where(Sr(se(Ao.token,e),se(Ao.used,!1),cd(Ao.expiresAt,new Date)));return t}async markMagicLinkUsed(e){await W.update(Ao).set({used:!0}).where(se(Ao.id,e))}async createVendorSession(e){let[t]=await W.insert(Wo).values(e).returning();return t}async getVendorSessionByToken(e){let[t]=await W.select().from(Wo).where(Sr(se(Wo.sessionToken,e),cd(Wo.expiresAt,new Date)));return t}async deleteVendorSession(e){await W.delete(Wo).where(se(Wo.sessionToken,e))}async deleteExpiredMagicLinks(){await W.delete(Ao).where(ld(Ao.expiresAt,new Date))}async deleteExpiredVendorSessions(){await W.delete(Wo).where(ld(Wo.expiresAt,new Date))}async createAffiliateActivity(e){let[t]=await W.insert(Ho).values(e).returning();return t}async getAffiliateActivityByHash(e){let[t]=await W.select().from(Ho).where(se(Ho.hash,e));return t}async getAllAffiliateActivities(){return W.select().from(Ho).orderBy(ut(Ho.createdAt))}async getAffiliateActivitiesByActorEmail(e){return W.select().from(Ho).where(se(Ho.actorEmail,e)).orderBy(ut(Ho.createdAt))}async getNotificationSettings(e){let[t]=await W.select().from(Mu).where(se(Mu.userId,e));return t}async createNotificationSettings(e){let[t]=await W.insert(Mu).values(e).returning();return t}async updateNotificationSettings(e,t){let[r]=await W.update(Mu).set({...t,updatedAt:new Date}).where(se(Mu.userId,e)).returning();return r}async ensureNotificationSettings(e){let t=await this.getNotificationSettings(e);if(t)return t;let r={SITE_VISIT:!0,CONTRACT_VIEW:!0,CONTRACT_SIGNED:!0,INFO_REQUEST:!0,AFFILIATE_CLICK:!0,AFFILIATE_SIGNUP:!0},{encrypt:s}=await Promise.resolve().then(()=>(Iv(),Cv));return this.createNotificationSettings({userId:e,enabled:!0,emailsEnc:s(JSON.stringify([])),events:JSON.stringify(r),delivery:"instant"})}async createRepairLog(e){let[t]=await W.insert(Oc).values(e).returning();return t}async getRepairLogs(e=20){return W.select().from(Oc).orderBy(ut(Oc.createdAt)).limit(e)}async getRepairLogById(e){let[t]=await W.select().from(Oc).where(se(Oc.id,e));return t||void 0}async updateRepairLogStatus(e,t){let[r]=await W.update(Oc).set({status:t}).where(se(Oc.id,e)).returning();return r||void 0}async createCriticalIncident(e){let[t]=await W.insert(za).values(e).returning();return t}async getCriticalIncidentByIncidentId(e){let[t]=await W.select().from(za).where(se(za.incidentId,e));return t||void 0}async getCriticalIncidents(e,t=20){return e?W.select().from(za).where(se(za.status,e)).orderBy(ut(za.createdAt)).limit(t):W.select().from(za).orderBy(ut(za.createdAt)).limit(t)}async updateCriticalIncident(e,t){let[r]=await W.update(za).set(t).where(se(za.incidentId,e)).returning();return r||void 0}async createIncidentAuditLog(e){let[t]=await W.insert(kd).values(e).returning();return t}async getIncidentAuditLogs(e){return W.select().from(kd).where(se(kd.incidentId,e)).orderBy(kd.timestamp)}},q=new WR});var lX={};jr(lX,{LEGAL_DOCS:()=>nn,createLegalOverride:()=>KR,generateEvidenceBundle:()=>QR,getLegalStatus:()=>jd,hasSignedLegalDoc:()=>$_,hashDocument:()=>xm,healLegalStateOnLogin:()=>R5e,legalSystemHealthCheck:()=>wm,processExternalEsignCallback:()=>YR,requireLegalClearance:()=>F5e,runLegalTestBot:()=>XR,signLegalDocumentAtomic:()=>Pv,signLegalDocumentCore:()=>bm});function xm(n){return aX.default.createHash("sha256").update(n).digest("hex")}async function $_(n,e){let[t]=await W.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e.type),se(Kr.documentVersion,e.version)));return!!t}async function bm({userId:n,documentType:e,documentVersion:t,documentHash:r,ipAddress:s,userAgent:c}){return await W.transaction(async u=>{let[d]=await u.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e),se(Kr.documentVersion,t)));return d?{success:!0,alreadySigned:!0}:(await u.insert(Kr).values({userId:n,documentType:e,documentVersion:t,documentHash:r||null,ipAddress:s,userAgent:c}),{success:!0,alreadySigned:!1})})}async function Pv({userId:n,doc:e,docHash:t,req:r,provider:s=null,envelopeId:c=null}){let u=r.headers["x-forwarded-for"]?.toString().split(",")[0]||r.socket.remoteAddress||"unknown",d=r.headers["user-agent"]||"unknown";return bm({userId:n,documentType:e.type,documentVersion:e.version,documentHash:t,ipAddress:u,userAgent:d})}function F5e(){return async(n,e,t)=>{let r=n.session;if(!r?.userId||!r?.userRole)return e.status(401).json({message:"Unauthorized"});for(let s of Object.keys(nn)){let c=nn[s];if(!c.requiredFor.includes(r.userRole))continue;if(!await $_(r.userId,c))return e.status(403).json({required:c.type,redirectTo:c.path})}t()}}async function jd(n,e){let t={};for(let r of Object.keys(nn)){let s=nn[r];if(!s.requiredFor.includes(e)){t[r]=!0;continue}t[r]=await $_(n,s)}return t}async function R5e(n,e){for(let t of Object.keys(nn)){let r=nn[t];if(!r.requiredFor.includes(e))continue;if(!await $_(n,r))return{redirectTo:r.path}}return{ok:!0}}async function KR({adminId:n,userId:e,documentType:t,reason:r,req:s}){let c=s.headers["x-forwarded-for"]?.toString().split(",")[0]||s.socket.remoteAddress||"unknown",u=s.headers["user-agent"]||"unknown";await W.transaction(async d=>{await d.insert(Kr).values({userId:e,documentType:t,documentVersion:"ADMIN_OVERRIDE",documentHash:"OVERRIDE",ipAddress:c,userAgent:u}),await d.insert(x_).values({adminId:n,userId:e,documentType:t,reason:r})})}async function QR(n){let t=(await W.select().from(Kr).where(se(Kr.userId,n))).map(s=>`DOC: ${s.documentType}
                                                                                                                                                                                                                                                                                                                                                                                                                   ^
Error: DATABASE_URL must be set. Did you forget to provision a database?
    at /app/dist/index.cjs:87:410
    at /app/dist/index.cjs:1:231
    at /app/dist/index.cjs:87:1374
    at /app/dist/index.cjs:1:231
    at Object.<anonymous> (/app/dist/index.cjs:599:517)
    at Module._compile (node:internal/modules/cjs/loader:1706:14)
    at Object..js (node:internal/modules/cjs/loader:1839:10)
    at Module.load (node:internal/modules/cjs/loader:1441:32)
    at Function._load (node:internal/modules/cjs/loader:1263:12)
    at TracingChannel.traceSync (node:diagnostics_channel:328:14)
Node.js v22.22.0
npm warn config production Use `--omit=dev` instead.
> rest-express@1.0.0 start
> NODE_ENV=production node dist/index.cjs
/app/dist/index.cjs:87
                                                                                                                                                                                                                                                                                                                                                                                                                   ^
> rest-express@1.0.0 start
    at /app/dist/index.cjs:87:1374
    at /app/dist/index.cjs:1:231
    at Module._compile (node:internal/modules/cjs/loader:1706:14)
    at Module.load (node:internal/modules/cjs/loader:1441:32)
    at Function._load (node:internal/modules/cjs/loader:1263:12)
    at TracingChannel.traceSync (node:diagnostics_channel:328:14)
Node.js v22.22.0
                                                                                                                                                                                                                                                                                                                                                                                                                   ^
    at /app/dist/index.cjs:87:1374
    at Object.<anonymous> (/app/dist/index.cjs:599:517)
    at Object..js (node:internal/modules/cjs/loader:1839:10)
    at Module.load (node:internal/modules/cjs/loader:1441:32)
Node.js v22.22.0
/app/dist/index.cjs:87
`+t)}function Bd(n,e,t,r,s,c){if(n.listenerCount("wsClientError")){let u=new Error(s);Error.captureStackTrace(u,Bd),n.emit("wsClientError",u,t,e)}else Ev(t,r,s,c)}});var S5e,E5e,T5e,tX,C5e,rX,nX=xe(()=>{S5e=Xt(zY(),1),E5e=Xt(LR(),1),T5e=Xt(jR(),1),tX=Xt(U_(),1),C5e=Xt(eX(),1),rX=tX.default});var I5e,W,Ks=xe(()=>{"use strict";T_();kQ();nX();Li();qu.webSocketConstructor=rX;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");I5e=new Fl({connectionString:process.env.DATABASE_URL}),W=I_({client:I5e,schema:b_})});var Cv={};jr(Cv,{decrypt:()=>k5e,encrypt:()=>P5e});function P5e(n){let e=Tv.default.randomBytes(16),t=Tv.default.createCipheriv("aes-256-gcm",sX,e),r=Buffer.concat([t.update(n,"utf8"),t.final()]),s=t.getAuthTag();return Buffer.concat([e,s,r]).toString("base64")}function k5e(n){let e=Buffer.from(n,"base64"),t=e.subarray(0,16),r=e.subarray(16,32),s=e.subarray(32),c=Tv.default.createDecipheriv("aes-256-gcm",sX,t);return c.setAuthTag(r),c.update(s).toString("utf8")+c.final("utf8")}var Tv,iX,sX,Iv=xe(()=>{"use strict";Tv=Xt(require("crypto"),1),iX=process.env.ENCRYPTION_KEY;if(!iX)throw new Error("ENCRYPTION_KEY environment variable is required in production");sX=Tv.default.createHash("sha256").update(iX||"dev-only-key-not-for-production-use").digest()});var WR,q,Jo=xe(()=>{"use strict";Li();Ks();Ji();WR=class{async getUser(e){let[t]=await W.select().from(St).where(se(St.id,e));return t||void 0}async getUserByEmail(e){let[t]=await W.select().from(St).where(se(St.email,e));return t||void 0}async getUserByReferralCode(e){let[t]=await W.select().from(St).where(se(St.referralCode,e));return t||void 0}async createUser(e){let[t]=await W.insert(St).values(e).returning();return t}async getAllAffiliates(){return W.select().from(St).where(se(St.role,"affiliate")).orderBy(ut(St.createdAt))}async updateUserPassword(e,t){let[r]=await W.update(St).set({passwordHash:t}).where(se(St.id,e)).returning();return r||void 0}async updateUserReferralCode(e,t){let[r]=await W.update(St).set({referralCode:t}).where(se(St.id,e)).returning();return r||void 0}async deleteUser(e){await W.delete(St).where(se(St.id,e))}async createAffiliateApplication(e){let[t]=await W.insert(Ca).values(e).returning();return t}async getAffiliateApplication(e){let[t]=await W.select().from(Ca).where(se(Ca.id,e));return t||void 0}async getAllAffiliateApplications(){return W.select().from(Ca).orderBy(ut(Ca.createdAt))}async getAffiliateApplicationsByAssignee(e){return W.select().from(Ca).where(se(Ca.assignedTo,e)).orderBy(ut(Ca.createdAt))}async updateAffiliateApplication(e,t){let[r]=await W.update(Ca).set({...t,updatedAt:new Date}).where(se(Ca.id,e)).returning();return r||void 0}async createHelpRequest(e){let[t]=await W.insert(Ia).values(e).returning();return t}async getHelpRequest(e){let[t]=await W.select().from(Ia).where(se(Ia.id,e));return t||void 0}async getAllHelpRequests(){return W.select().from(Ia).orderBy(ut(Ia.createdAt))}async getHelpRequestsByAssignee(e){return W.select().from(Ia).where(se(Ia.assignedTo,e)).orderBy(ut(Ia.createdAt))}async updateHelpRequest(e,t){let[r]=await W.update(Ia).set({...t,updatedAt:new Date}).where(se(Ia.id,e)).returning();return r||void 0}async createStartupGrant(e){let[t]=await W.insert(Pa).values(e).returning();return t}async getStartupGrant(e){let[t]=await W.select().from(Pa).where(se(Pa.id,e));return t||void 0}async getAllStartupGrants(){return W.select().from(Pa).orderBy(ut(Pa.createdAt))}async getStartupGrantsByAssignee(e){return W.select().from(Pa).where(se(Pa.assignedTo,e)).orderBy(ut(Pa.createdAt))}async updateStartupGrant(e,t){let[r]=await W.update(Pa).set({...t,updatedAt:new Date}).where(se(Pa.id,e)).returning();return r||void 0}async createFurnitureAssistance(e){let[t]=await W.insert(ka).values(e).returning();return t}async getFurnitureAssistance(e){let[t]=await W.select().from(ka).where(se(ka.id,e));return t||void 0}async getAllFurnitureAssistance(){return W.select().from(ka).orderBy(ut(ka.createdAt))}async getFurnitureAssistanceByAssignee(e){return W.select().from(ka).where(se(ka.assignedTo,e)).orderBy(ut(ka.createdAt))}async updateFurnitureAssistance(e,t){let[r]=await W.update(ka).set({...t,updatedAt:new Date}).where(se(ka.id,e)).returning();return r||void 0}async createInvestorSubmission(e){let[t]=await W.insert(Fa).values(e).returning();return t}async getInvestorSubmission(e){let[t]=await W.select().from(Fa).where(se(Fa.id,e));return t||void 0}async getAllInvestorSubmissions(){return W.select().from(Fa).orderBy(ut(Fa.createdAt))}async getInvestorSubmissionsByAssignee(e){return W.select().from(Fa).where(se(Fa.assignedTo,e)).orderBy(ut(Fa.createdAt))}async updateInvestorSubmission(e,t){let[r]=await W.update(Fa).set({...t,updatedAt:new Date}).where(se(Fa.id,e)).returning();return r||void 0}async createPrivateDoctorRequest(e){let[t]=await W.insert(Ra).values(e).returning();return t}async getPrivateDoctorRequest(e){let[t]=await W.select().from(Ra).where(se(Ra.id,e));return t||void 0}async getAllPrivateDoctorRequests(){return W.select().from(Ra).orderBy(ut(Ra.createdAt))}async getPrivateDoctorRequestsByAssignee(e){return W.select().from(Ra).where(se(Ra.assignedTo,e)).orderBy(ut(Ra.createdAt))}async updatePrivateDoctorRequest(e,t){let[r]=await W.update(Ra).set({...t,updatedAt:new Date}).where(se(Ra.id,e)).returning();return r||void 0}async createWebsiteApplication(e){let[t]=await W.insert(Na).values(e).returning();return t}async getWebsiteApplication(e){let[t]=await W.select().from(Na).where(se(Na.id,e));return t||void 0}async getAllWebsiteApplications(){return W.select().from(Na).orderBy(ut(Na.createdAt))}async getWebsiteApplicationsByAssignee(e){return W.select().from(Na).where(se(Na.assignedTo,e)).orderBy(ut(Na.createdAt))}async updateWebsiteApplication(e,t){let[r]=await W.update(Na).set({...t,updatedAt:new Date}).where(se(Na.id,e)).returning();return r||void 0}async createGeneralContact(e){let[t]=await W.insert(Oa).values(e).returning();return t}async getGeneralContact(e){let[t]=await W.select().from(Oa).where(se(Oa.id,e));return t||void 0}async getAllGeneralContacts(){return W.select().from(Oa).orderBy(ut(Oa.createdAt))}async getGeneralContactsByAssignee(e){return W.select().from(Oa).where(se(Oa.assignedTo,e)).orderBy(ut(Oa.createdAt))}async updateGeneralContact(e,t){let[r]=await W.update(Oa).set({...t,updatedAt:new Date}).where(se(Oa.id,e)).returning();return r||void 0}async createVltIntake(e){let t=e.issue==="credits"?"CPA":e.issue==="resolution"?"Tax Attorney":"General";console.log("NEW LEAD:",{...e,routedTo:t,timestamp:new Date().toISOString()});let[r]=await W.insert(Zi).values({...e,routedTo:t}).returning();return r}async getVltIntake(e){let[t]=await W.select().from(Zi).where(se(Zi.id,e));return t||void 0}async getAllVltIntakes(){return W.select().from(Zi).orderBy(ut(Zi.createdAt))}async updateVltIntake(e,t){let[r]=await W.update(Zi).set(t).where(se(Zi.id,e)).returning();return r||void 0}async getVltIntakesByAffiliate(e){return W.select().from(Zi).where(od(se(Zi.referredByL1,e),se(Zi.referredByL2,e),se(Zi.referredByL3,e),se(Zi.referredByL4,e),se(Zi.referredByL5,e),se(Zi.referredByL6,e))).orderBy(ut(Zi.createdAt))}async createVltAffiliate(e){let[t]=await W.insert(Pr).values(e).returning();return t}async getVltAffiliate(e){let[t]=await W.select().from(Pr).where(se(Pr.id,e));return t||void 0}async getVltAffiliateByEmail(e){let[t]=await W.select().from(Pr).where(se(Pr.email,e));return t||void 0}async getVltAffiliateByReferralCode(e){let[t]=await W.select().from(Pr).where(se(Pr.referralCode,e));return t||void 0}async getAllVltAffiliates(){return W.select().from(Pr).orderBy(ut(Pr.createdAt))}async updateVltAffiliate(e,t){let[r]=await W.update(Pr).set({...t,updatedAt:new Date}).where(se(Pr.id,e)).returning();return r||void 0}async deleteVltAffiliate(e){await W.delete(Pr).where(se(Pr.id,e))}async getVltAffiliatesByRole(e){return W.select().from(Pr).where(se(Pr.role,e)).orderBy(ut(Pr.createdAt))}async getVltAffiliateDownline(e){return W.select().from(Pr).where(od(se(Pr.level1Id,e),se(Pr.level2Id,e),se(Pr.level3Id,e),se(Pr.level4Id,e),se(Pr.level5Id,e),se(Pr.level6Id,e),se(Pr.level7Id,e))).orderBy(ut(Pr.createdAt))}async createOpportunity(e){let[t]=await W.insert(da).values(e).returning();return t}async getOpportunity(e){let[t]=await W.select().from(da).where(se(da.id,e));return t||void 0}async getAllOpportunities(){return W.select().from(da).orderBy(ut(da.createdAt))}async getOpportunitiesByCategory(e){return W.select().from(da).where(se(da.category,e)).orderBy(ut(da.createdAt))}async updateOpportunity(e,t){let[r]=await W.update(da).set(t).where(se(da.id,e)).returning();return r||void 0}async createSale(e){let[t]=await W.insert(qn).values(e).returning();return t}async getSale(e){let[t]=await W.select().from(qn).where(se(qn.id,e));return t||void 0}async getAllSales(){return W.select().from(qn).orderBy(ut(qn.createdAt))}async getSalesByAffiliate(e){return W.select().from(qn).where(se(qn.affiliateId,e)).orderBy(ut(qn.createdAt))}async getSalesByDownline(e){return W.select().from(qn).where(od(se(qn.referredByL1,e),se(qn.referredByL2,e),se(qn.referredByL3,e),se(qn.referredByL4,e),se(qn.referredByL5,e),se(qn.referredByL6,e),se(qn.referredByL7,e))).orderBy(ut(qn.createdAt))}async updateSale(e,t){let[r]=await W.update(qn).set({...t,updatedAt:new Date}).where(se(qn.id,e)).returning();return r||void 0}async createCommission(e){let[t]=await W.insert(pa).values(e).returning();return t}async getCommission(e){let[t]=await W.select().from(pa).where(se(pa.id,e));return t||void 0}async getCommissionsByAffiliate(e){return W.select().from(pa).where(se(pa.affiliateId,e)).orderBy(ut(pa.createdAt))}async getCommissionsBySale(e){return W.select().from(pa).where(se(pa.saleId,e)).orderBy(ut(pa.createdAt))}async updateCommission(e,t){let[r]=await W.update(pa).set(t).where(se(pa.id,e)).returning();return r||void 0}async createVeteranIntake(e){let[t]=await W.insert(Da).values(e).returning();return t}async getVeteranIntake(e){let[t]=await W.select().from(Da).where(se(Da.id,e));return t||void 0}async getAllVeteranIntakes(){return W.select().from(Da).orderBy(ut(Da.createdAt))}async getVeteranIntakesByProgram(e){return W.select().from(Da).where(se(Da.programType,e)).orderBy(ut(Da.createdAt))}async updateVeteranIntake(e,t){let[r]=await W.update(Da).set({...t,updatedAt:new Date}).where(se(Da.id,e)).returning();return r||void 0}async createBusinessIntake(e){let[t]=await W.insert(La).values(e).returning();return t}async getBusinessIntake(e){let[t]=await W.select().from(La).where(se(La.id,e));return t||void 0}async getAllBusinessIntakes(){return W.select().from(La).orderBy(ut(La.createdAt))}async getBusinessIntakesByService(e){return W.select().from(La).where(se(La.serviceType,e)).orderBy(ut(La.createdAt))}async updateBusinessIntake(e,t){let[r]=await W.update(La).set({...t,updatedAt:new Date}).where(se(La.id,e)).returning();return r||void 0}async createContractTemplate(e){let[t]=await W.insert(ha).values(e).returning();return t}async getContractTemplate(e){let[t]=await W.select().from(ha).where(se(ha.id,e));return t||void 0}async getAllContractTemplates(){return W.select().from(ha).orderBy(ut(ha.createdAt))}async getActiveContractTemplates(){return W.select().from(ha).where(se(ha.isActive,"true")).orderBy(ut(ha.createdAt))}async updateContractTemplate(e,t){let[r]=await W.update(ha).set({...t,updatedAt:new Date}).where(se(ha.id,e)).returning();return r||void 0}async createSignedAgreement(e){let[t]=await W.insert(ki).values(e).returning();return t}async getSignedAgreement(e){let[t]=await W.select().from(ki).where(se(ki.id,e));return t||void 0}async getAllSignedAgreements(){return W.select().from(ki).orderBy(ut(ki.signedAt))}async getSignedAgreementsByAffiliate(e){return W.select().from(ki).where(se(ki.affiliateId,e)).orderBy(ut(ki.signedAt))}async hasAffiliateSignedContract(e,t){let[r]=await W.select().from(ki).where(Sr(se(ki.affiliateId,e),se(ki.contractTemplateId,t),se(ki.status,"signed")));return!!r}async updateSignedAgreement(e,t){let[r]=await W.update(ki).set(t).where(se(ki.id,e)).returning();return r||void 0}async createCommissionConfig(e){let[t]=await W.insert(El).values(e).returning();return t}async getActiveCommissionConfig(){let[e]=await W.select().from(El).where(se(El.isActive,"true")).orderBy(ut(El.createdAt)).limit(1);return e||void 0}async updateCommissionConfig(e,t){let[r]=await W.update(El).set({...t,updatedAt:new Date}).where(se(El.id,e)).returning();return r||void 0}async createAffiliateNda(e){let[t]=await W.insert(Fi).values(e).returning();return t}async getAffiliateNdaByUserId(e){let[t]=await W.select().from(Fi).where(se(Fi.userId,e));return t||void 0}async getAffiliateNdaById(e){let[t]=await W.select().from(Fi).where(se(Fi.id,e));return t||void 0}async hasAffiliateSignedNda(e){return!!await this.getAffiliateNdaByUserId(e)}async getAllAffiliateNdas(){return W.select().from(Fi).orderBy(ut(Fi.signedAt))}async signNdaAtomic(e,t,r){return await W.transaction(async s=>{let[c]=await s.select().from(Fi).where(se(Fi.userId,e));if(c)return{nda:c,alreadySigned:!0};await s.update(St).set({referralCode:t}).where(se(St.id,e));let[u]=await s.insert(Fi).values(r).returning();return{nda:u,alreadySigned:!1}})}async createBusinessLead(e){let[t]=await W.insert(Is).values(e).returning();return t}async getBusinessLead(e){let[t]=await W.select().from(Is).where(se(Is.id,e));return t||void 0}async getAllBusinessLeads(){return W.select().from(Is).orderBy(ut(Is.createdAt))}async getBusinessLeadsByType(e){return W.select().from(Is).where(se(Is.leadType,e)).orderBy(ut(Is.createdAt))}async getBusinessLeadsByReferrer(e){return W.select().from(Is).where(se(Is.referredBy,e)).orderBy(ut(Is.createdAt))}async updateBusinessLead(e,t){let[r]=await W.update(Is).set({...t,updatedAt:new Date}).where(se(Is.id,e)).returning();return r||void 0}async createIpReferralTracking(e){let[t]=await W.insert(Ma).values(e).returning();return t}async getActiveIpReferral(e){let t=new Date,[r]=await W.select().from(Ma).where(Sr(se(Ma.ipAddress,e),cd(Ma.expiresAt,t))).orderBy(ut(Ma.createdAt)).limit(1);return r||void 0}async getIpReferralsByAffiliate(e){return W.select().from(Ma).where(se(Ma.affiliateId,e)).orderBy(ut(Ma.createdAt))}async getAllIpReferrals(){return W.select().from(Ma).orderBy(ut(Ma.createdAt))}async createAffiliateW9(e){let[t]=await W.insert(Id).values(e).returning();return t}async getAffiliateW9ByUserId(e){let[t]=await W.select().from(Id).where(se(Id.userId,e));return t||void 0}async hasAffiliateSubmittedW9(e){return!!await this.getAffiliateW9ByUserId(e)}async getAllAffiliateW9s(){return await W.select().from(Id)}async createFinopsReferral(e){let[t]=await W.insert(Ps).values(e).returning();return t}async getFinopsReferral(e){let[t]=await W.select().from(Ps).where(se(Ps.id,e));return t||void 0}async getAllFinopsReferrals(){return W.select().from(Ps).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByAffiliate(e){return W.select().from(Ps).where(se(Ps.affiliateId,e)).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByPartnerType(e){return W.select().from(Ps).where(se(Ps.partnerType,e)).orderBy(ut(Ps.createdAt))}async updateFinopsReferral(e,t){let[r]=await W.update(Ps).set(t).where(se(Ps.id,e)).returning();return r||void 0}async createDisabilityReferral(e){let[t]=await W.insert(ma).values(e).returning();return t}async getDisabilityReferral(e){let[t]=await W.select().from(ma).where(se(ma.id,e));return t||void 0}async getAllDisabilityReferrals(){return W.select().from(ma).orderBy(ut(ma.createdAt))}async getDisabilityReferralsByAffiliate(e){return W.select().from(ma).where(se(ma.affiliateId,e)).orderBy(ut(ma.createdAt))}async updateDisabilityReferral(e,t){let[r]=await W.update(ma).set({...t,updatedAt:new Date}).where(se(ma.id,e)).returning();return r||void 0}async getDisabilityReferralStats(){let e=await W.select().from(ma),t={},r={};for(let s of e)t[s.claimType]=(t[s.claimType]||0)+1,r[s.status]=(r[s.status]||0)+1;return{total:e.length,byType:t,byStatus:r}}async createJobPlacementIntake(e){let[t]=await W.insert(Ba).values(e).returning();return t}async getJobPlacementIntake(e){let[t]=await W.select().from(Ba).where(se(Ba.id,e));return t||void 0}async getAllJobPlacementIntakes(){return W.select().from(Ba).orderBy(ut(Ba.createdAt))}async getJobPlacementIntakesByAffiliate(e){return W.select().from(Ba).where(se(Ba.affiliateId,e)).orderBy(ut(Ba.createdAt))}async updateJobPlacementIntake(e,t){let[r]=await W.update(Ba).set({...t,updatedAt:new Date}).where(se(Ba.id,e)).returning();return r||void 0}async createVetProfessionalIntake(e){let[t]=await W.insert(ja).values(e).returning();return t}async getVetProfessionalIntake(e){let[t]=await W.select().from(ja).where(se(ja.id,e));return t||void 0}async getAllVetProfessionalIntakes(){return W.select().from(ja).orderBy(ut(ja.createdAt))}async getVetProfessionalIntakesByAffiliate(e){return W.select().from(ja).where(se(ja.affiliateId,e)).orderBy(ut(ja.createdAt))}async updateVetProfessionalIntake(e,t){let[r]=await W.update(ja).set({...t,updatedAt:new Date}).where(se(ja.id,e)).returning();return r||void 0}async createHealthcareIntake(e){let[t]=await W.insert(Ou).values(e).returning();return t}async getAllHealthcareIntakes(){return W.select().from(Ou).orderBy(ut(Ou.createdAt))}async updateHealthcareIntake(e,t){let[r]=await W.update(Ou).set({...t,updatedAt:new Date}).where(se(Ou.id,e)).returning();return r||void 0}async createScheduleASignature(e){let[t]=await W.insert(Du).values(e).returning();return t}async getScheduleASignatureByUserId(e){let[t]=await W.select().from(Du).where(se(Du.userId,e));return t||void 0}async getAllScheduleASignatures(){return W.select().from(Du).orderBy(ut(Du.signedAt))}async createInsuranceIntake(e){let[t]=await W.insert(Lu).values(e).returning();return t}async getAllInsuranceIntakes(){return W.select().from(Lu).orderBy(ut(Lu.createdAt))}async updateInsuranceIntake(e,t){let[r]=await W.update(Lu).set({...t,updatedAt:new Date}).where(se(Lu.id,e)).returning();return r||void 0}async createMedicalSalesIntake(e){let[t]=await W.insert(qo).values(e).returning();return t}async getAllMedicalSalesIntakes(){return W.select().from(qo).orderBy(ut(qo.createdAt))}async getMedicalSalesIntakesByAffiliate(e){return W.select().from(qo).where(se(qo.assignedTo,e)).orderBy(ut(qo.createdAt))}async updateMedicalSalesIntake(e,t){let[r]=await W.update(qo).set({...t,updatedAt:new Date}).where(se(qo.id,e)).returning();return r||void 0}async createBusinessDevIntake(e){let[t]=await W.insert($o).values(e).returning();return t}async getAllBusinessDevIntakes(){return W.select().from($o).orderBy(ut($o.createdAt))}async getBusinessDevIntakesByAffiliate(e){return W.select().from($o).where(se($o.assignedTo,e)).orderBy(ut($o.createdAt))}async updateBusinessDevIntake(e,t){let[r]=await W.update($o).set({...t,updatedAt:new Date}).where(se($o.id,e)).returning();return r||void 0}async getUserById(e){return this.getUser(e)}async createCsuContractTemplate(e){let[t]=await W.insert($r).values(e).returning();return t}async getCsuContractTemplate(e){let[t]=await W.select().from($r).where(se($r.id,e));return t||void 0}async getAllCsuContractTemplates(){return W.select().from($r).orderBy(ut($r.createdAt))}async getActiveCsuContractTemplates(){return W.select().from($r).where(se($r.isActive,!0)).orderBy(ut($r.createdAt))}async updateCsuContractTemplate(e,t){let[r]=await W.update($r).set({...t,updatedAt:new Date}).where(se($r.id,e)).returning();return r||void 0}async getActiveTemplatesByPortal(e){return W.select().from($r).where(Sr(se($r.isActive,!0),od(se($r.portal,e),ml($r.portal)))).orderBy(ut($r.createdAt))}async deleteCsuContractTemplate(e){await W.delete($r).where(se($r.id,e))}async createCsuContractTemplateField(e){let[t]=await W.insert(Ua).values(e).returning();return t}async getCsuContractTemplateFields(e){return W.select().from(Ua).where(se(Ua.templateId,e)).orderBy(Ua.order)}async updateCsuContractTemplateField(e,t){let[r]=await W.update(Ua).set(t).where(se(Ua.id,e)).returning();return r||void 0}async deleteCsuContractTemplateField(e){await W.delete(Ua).where(se(Ua.id,e))}async deleteAllCsuContractTemplateFields(e){await W.delete(Ua).where(se(Ua.templateId,e))}async createCsuContractSend(e){let[t]=await W.insert(ga).values(e).returning();return t}async getCsuContractSend(e){let[t]=await W.select().from(ga).where(se(ga.id,e));return t||void 0}async getCsuContractSendByToken(e){let[t]=await W.select().from(ga).where(se(ga.signToken,e));return t||void 0}async getAllCsuContractSends(){return W.select().from(ga).orderBy(ut(ga.createdAt))}async updateCsuContractSend(e,t){let[r]=await W.update(ga).set(t).where(se(ga.id,e)).returning();return r||void 0}async createCsuSignedAgreement(e){let[t]=await W.insert(Cn).values(e).returning();return t}async getCsuSignedAgreement(e){let[t]=await W.select().from(Cn).where(se(Cn.id,e));return t||void 0}async getAllCsuSignedAgreements(){return await W.select({id:Cn.id,contractSendId:Cn.contractSendId,templateId:Cn.templateId,signerName:Cn.signerName,signerEmail:Cn.signerEmail,signerPhone:Cn.signerPhone,address:Cn.address,initials:Cn.initials,effectiveDate:Cn.effectiveDate,signatureData:Cn.signatureData,signedIpAddress:Cn.signedIpAddress,agreedToTerms:Cn.agreedToTerms,signedAt:Cn.signedAt,createdAt:Cn.createdAt,templateName:$r.name}).from(Cn).leftJoin($r,se(Cn.templateId,$r.id)).orderBy(ut(Cn.createdAt))}async createPortalActivity(e){let[t]=await W.insert(Cl).values(e).returning();return t}async getPortalActivity(e,t){return W.select().from(Cl).where(se(Cl.portal,e)).orderBy(ut(Cl.createdAt)).limit(t)}async getPortalStats(e){let t=await W.select().from(Cl).where(se(Cl.portal,e)),r=new Date;r.setHours(0,0,0,0);let s=t.filter(v=>new Date(v.createdAt)>=r),c=t.filter(v=>v.eventType==="page_view"),u=new Set(c.map(v=>v.ipAddress).filter(Boolean)),d=t.filter(v=>v.eventType==="contract_sent").length,m=t.filter(v=>v.eventType==="contract_signed").length;return{totalVisits:c.length,uniqueIps:u.size,contractsSent:d,contractsSigned:m,todayVisits:s.filter(v=>v.eventType==="page_view").length}}async createPasswordResetToken(e){let[t]=await W.insert(qa).values(e).returning();return t}async getValidPasswordResetToken(e){let t=new Date,[r]=await W.select().from(qa).where(Sr(se(qa.tokenHash,e),ml(qa.usedAt),cd(qa.expiresAt,t)));return r||void 0}async invalidatePasswordResetToken(e){await W.update(qa).set({usedAt:new Date}).where(se(qa.id,e))}async invalidateAllUserPasswordResetTokens(e){await W.update(qa).set({usedAt:new Date}).where(Sr(se(qa.userId,e),ml(qa.usedAt)))}async createPartnerSharingLog(e){let[t]=await W.insert(Fc).values(e).returning();return t}async getPartnerSharingLogsBySubmission(e,t){return await W.select().from(Fc).where(Sr(se(Fc.submissionType,e),se(Fc.submissionId,t))).orderBy(ut(Fc.sharedAt))}async getAllPartnerSharingLogs(){return await W.select().from(Fc).orderBy(ut(Fc.sharedAt))}async createConsentRecord(e){let[t]=await W.insert($a).values(e).returning();return t}async getConsentRecordsBySubmission(e,t){return await W.select().from($a).where(Sr(se($a.submissionType,e),se($a.submissionId,t))).orderBy(ut($a.submittedAt))}async getConsentRecordByEmail(e){return await W.select().from($a).where(se($a.email,e)).orderBy(ut($a.submittedAt))}async getAllConsentRecords(){return await W.select().from($a).orderBy(ut($a.submittedAt))}async createAffiliatedPartner(e){let[t]=await W.insert(Ha).values(e).returning();return t}async getActiveAffiliatedPartners(){return await W.select().from(Ha).where(se(Ha.isActive,!0)).orderBy(Ha.category,Ha.displayName)}async getAllAffiliatedPartners(){return await W.select().from(Ha).orderBy(Ha.category,Ha.displayName)}async updateAffiliatedPartner(e,t){let[r]=await W.update(Ha).set(t).where(se(Ha.id,e)).returning();return r||void 0}async createRangerTabApplication(e){let[t]=await W.insert(Bu).values(e).returning();return t}async getAllRangerTabApplications(){return W.select().from(Bu).orderBy(ut(Bu.createdAt))}async updateRangerTabApplication(e,t){let[r]=await W.update(Bu).set({...t,updatedAt:new Date}).where(se(Bu.id,e)).returning();return r||void 0}async createCsuEnvelope(e){let[t]=await W.insert(wo).values(e).returning();return t}async getCsuEnvelope(e){let[t]=await W.select().from(wo).where(se(wo.id,e));return t||void 0}async getAllCsuEnvelopes(){return W.select().from(wo).orderBy(ut(wo.createdAt))}async updateCsuEnvelope(e,t){let[r]=await W.update(wo).set({...t,updatedAt:new Date}).where(se(wo.id,e)).returning();return r||void 0}async createCsuEnvelopeRecipient(e){let[t]=await W.insert(ya).values(e).returning();return t}async getCsuEnvelopeRecipient(e){let[t]=await W.select().from(ya).where(se(ya.id,e));return t||void 0}async getCsuEnvelopeRecipientByToken(e){let[t]=await W.select().from(ya).where(se(ya.signToken,e));return t||void 0}async getEnvelopeRecipients(e){return W.select().from(ya).where(se(ya.envelopeId,e)).orderBy(ya.routingOrder)}async updateCsuEnvelopeRecipient(e,t){let[r]=await W.update(ya).set(t).where(se(ya.id,e)).returning();return r||void 0}async createCsuAuditTrail(e){let[t]=await W.insert(kc).values(e).returning();return t}async getAuditTrailForEnvelope(e){return W.select().from(kc).where(se(kc.envelopeId,e)).orderBy(ut(kc.createdAt))}async getAuditTrailForContractSend(e){return W.select().from(kc).where(se(kc.contractSendId,e)).orderBy(ut(kc.createdAt))}async createHipaaAuditLog(e){let[t]=await W.insert(Ri).values(e).returning();return t}async getHipaaAuditLogs(e=1e3){return W.select().from(Ri).orderBy(ut(Ri.timestamp)).limit(e)}async getHipaaAuditLogsByUser(e){return W.select().from(Ri).where(se(Ri.userId,e)).orderBy(ut(Ri.timestamp))}async getHipaaAuditLogsByResource(e,t){return t?W.select().from(Ri).where(Sr(se(Ri.resourceType,e),se(Ri.resourceId,t))).orderBy(ut(Ri.timestamp)):W.select().from(Ri).where(se(Ri.resourceType,e)).orderBy(ut(Ri.timestamp))}async getHipaaPhiAccessLogs(){return W.select().from(Ri).where(se(Ri.phiAccessed,!0)).orderBy(ut(Ri.timestamp))}async createHipaaTrainingRecord(e){let[t]=await W.insert(Va).values(e).returning();return t}async getHipaaTrainingRecordsByUser(e){return W.select().from(Va).where(se(Va.userId,e)).orderBy(ut(Va.completedAt))}async getAllHipaaTrainingRecords(){return W.select().from(Va).orderBy(ut(Va.completedAt))}async getExpiredTrainingRecords(){let e=new Date;return W.select().from(Va).where(Sr(se(Va.passed,!0),ld(Va.expiresAt,e))).orderBy(ut(Va.expiresAt))}async createBusinessAssociateAgreement(e){let[t]=await W.insert(Rc).values(e).returning();return t}async getBusinessAssociateAgreement(e){let[t]=await W.select().from(Rc).where(se(Rc.id,e));return t||void 0}async getAllBusinessAssociateAgreements(){return W.select().from(Rc).orderBy(ut(Rc.updatedAt))}async updateBusinessAssociateAgreement(e,t){let[r]=await W.update(Rc).set({...t,updatedAt:new Date}).where(se(Rc.id,e)).returning();return r||void 0}async createUserMfaConfig(e){let[t]=await W.insert(ju).values(e).returning();return t}async getUserMfaConfig(e){let[t]=await W.select().from(ju).where(se(ju.userId,e));return t||void 0}async updateUserMfaConfig(e,t){let[r]=await W.update(ju).set({...t,updatedAt:new Date}).where(se(ju.userId,e)).returning();return r||void 0}async getAuthRateLimit(e,t,r){let[s]=await W.select().from(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)));return s||void 0}async createOrUpdateAuthRateLimit(e){let t=await this.getAuthRateLimit(e.identifier,e.identifierType,e.attemptType);if(t){let[s]=await W.update(va).set({failedAttempts:e.failedAttempts,lastAttemptAt:new Date,lockedUntil:e.lockedUntil,updatedAt:new Date}).where(se(va.id,t.id)).returning();return s}let[r]=await W.insert(va).values({...e,lastAttemptAt:new Date}).returning();return r}async resetAuthRateLimit(e,t,r){await W.delete(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)))}async createAiGeneration(e){let[t]=await W.insert(ai).values(e).returning();return t}async getAiGeneration(e){let[t]=await W.select().from(ai).where(se(ai.id,e));return t||void 0}async getAiGenerationsByUser(e){return W.select().from(ai).where(se(ai.userId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsBySession(e){return W.select().from(ai).where(se(ai.sessionId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsByStatus(e){return W.select().from(ai).where(se(ai.status,e)).orderBy(ai.createdAt)}async updateAiGeneration(e,t){let[r]=await W.update(ai).set({...t,updatedAt:new Date}).where(se(ai.id,e)).returning();return r||void 0}async deleteAiGeneration(e){await W.delete(ai).where(se(ai.id,e))}async getAllAiGenerations(e=100){return W.select().from(ai).orderBy(ut(ai.createdAt)).limit(e)}async createAiTemplate(e){let[t]=await W.insert($n).values(e).returning();return t}async getAiTemplate(e){let[t]=await W.select().from($n).where(se($n.id,e));return t||void 0}async getAllAiTemplates(){return W.select().from($n).orderBy(ut($n.usageCount))}async getActiveAiTemplates(){return W.select().from($n).where(se($n.isActive,!0)).orderBy(ut($n.usageCount))}async getAiTemplatesByCategory(e){return W.select().from($n).where(Sr(se($n.category,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async getAiTemplatesByType(e){return W.select().from($n).where(Sr(se($n.type,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async updateAiTemplate(e,t){let[r]=await W.update($n).set({...t,updatedAt:new Date}).where(se($n.id,e)).returning();return r||void 0}async incrementTemplateUsage(e){let t=await this.getAiTemplate(e);t&&await W.update($n).set({usageCount:(t.usageCount||0)+1,updatedAt:new Date}).where(se($n.id,e))}async saveOperatorAiMessage(e){let[t]=await W.insert(Ni).values(e).returning();return t}async getSessionMemory(e){return W.select().from(Ni).where(se(Ni.sessionId,e)).orderBy(Ni.messageOrder)}async getUserPersistentMemory(e){return W.select().from(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent"))).orderBy(Ni.messageOrder)}async clearSessionMemory(e){await W.delete(Ni).where(se(Ni.sessionId,e))}async clearUserPersistentMemory(e){await W.delete(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent")))}async cleanupExpiredSessions(){await W.delete(Ni).where(Sr(se(Ni.memoryMode,"session"),ld(Ni.expiresAt,new Date)))}async getOrCreateAiUser(e,t){if(e){let s=await W.select().from(In).where(se(In.email,e));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}if(t){let s=await W.select().from(In).where(se(In.anonDeviceId,t));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}let[r]=await W.insert(In).values({email:e||null,anonDeviceId:t||null,memoryMode:"OFF"}).returning();return r}async getAiUser(e){let[t]=await W.select().from(In).where(se(In.id,e));return t||void 0}async getAiUserByEmail(e){let[t]=await W.select().from(In).where(se(In.email,e));return t||void 0}async updateAiUserMemoryMode(e,t){let[r]=await W.update(In).set({memoryMode:t,lastActiveAt:new Date}).where(se(In.id,e)).returning();return r||void 0}async deleteAiUser(e){await W.delete(In).where(se(In.id,e))}async createAiSession(e){let[t]=await W.insert(oi).values(e).returning();return t}async getAiSession(e){let[t]=await W.select().from(oi).where(se(oi.id,e));return t||void 0}async getAiSessionByToken(e){let[t]=await W.select().from(oi).where(se(oi.sessionToken,e));return t||void 0}async getUserAiSessions(e){return W.select().from(oi).where(se(oi.userId,e)).orderBy(ut(oi.createdAt))}async endAiSession(e){await W.update(oi).set({endedAt:new Date}).where(se(oi.id,e))}async deleteAiSession(e){await W.delete(_o).where(se(_o.sessionId,e)),await W.delete(oi).where(se(oi.id,e))}async createAiMessage(e){let[t]=await W.insert(_o).values(e).returning();return await W.update(oi).set({lastMessageAt:new Date}).where(se(oi.id,e.sessionId)),t}async getAiSessionMessages(e){return W.select().from(_o).where(se(_o.sessionId,e)).orderBy(_o.createdAt)}async deleteAiSessionMessages(e){await W.delete(_o).where(se(_o.sessionId,e))}async createAiFile(e){let[t]=await W.insert(us).values(e).returning();return t}async getAiFile(e){let[t]=await W.select().from(us).where(Sr(se(us.id,e),ml(us.deletedAt)));return t||void 0}async getSessionAiFiles(e){return W.select().from(us).where(Sr(se(us.sessionId,e),ml(us.deletedAt)))}async getUserAiFiles(e){return W.select().from(us).where(Sr(se(us.ownerUserId,e),ml(us.deletedAt)))}async softDeleteAiFile(e){await W.update(us).set({deletedAt:new Date}).where(se(us.id,e))}async deleteSessionAiFiles(e){await W.update(us).set({deletedAt:new Date}).where(se(us.sessionId,e))}async setAiMemory(e,t,r,s){let c=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));if(c[0]){let[d]=await W.update(bi).set({value:r,sourceMessageId:s,updatedAt:new Date}).where(se(bi.id,c[0].id)).returning();return d}let[u]=await W.insert(bi).values({userId:e,key:t,value:r,sourceMessageId:s}).returning();return u}async getAiMemory(e,t){let[r]=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));return r||void 0}async getAllAiMemories(e){return W.select().from(bi).where(se(bi.userId,e)).orderBy(bi.key)}async deleteAiMemory(e,t){await W.delete(bi).where(Sr(se(bi.userId,e),se(bi.key,t)))}async clearAllAiMemories(e){await W.delete(bi).where(se(bi.userId,e))}async createAiJob(e){let[t]=await W.insert(Oi).values(e).returning();return t}async getAiJob(e){let[t]=await W.select().from(Oi).where(se(Oi.id,e));return t||void 0}async getUserAiJobs(e){return W.select().from(Oi).where(se(Oi.userId,e)).orderBy(ut(Oi.createdAt))}async getSessionAiJobs(e){return W.select().from(Oi).where(se(Oi.sessionId,e)).orderBy(ut(Oi.createdAt))}async getQueuedAiJobs(){return W.select().from(Oi).where(se(Oi.status,"QUEUED")).orderBy(Oi.createdAt)}async updateAiJobStatus(e,t,r,s){let c={status:t};t==="RUNNING"&&(c.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(c.completedAt=new Date,c.progress=t==="DONE"?100:void 0),r&&(c.output=r),s&&(c.errorMessage=s);let[u]=await W.update(Oi).set(c).where(se(Oi.id,e)).returning();return u||void 0}async updateAiJobProgress(e,t){await W.update(Oi).set({progress:Math.min(100,Math.max(0,t))}).where(se(Oi.id,e))}async createMediaPipeline(e){let[t]=await W.insert(fs).values(e).returning();return t}async getMediaPipeline(e){let[t]=await W.select().from(fs).where(se(fs.id,e));return t||void 0}async getUserPipelines(e){return W.select().from(fs).where(se(fs.userId,e)).orderBy(ut(fs.createdAt))}async updatePipelineStatus(e,t,r){let s={status:t};t==="RUNNING"&&(s.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(s.completedAt=new Date),r&&(s.errorMessage=r),await W.update(fs).set(s).where(se(fs.id,e))}async updatePipelineProgress(e,t,r){await W.update(fs).set({completedSteps:t,progress:Math.min(100,Math.max(0,r))}).where(se(fs.id,e))}async updatePipelineFinalArtifact(e,t,r){await W.update(fs).set({finalArtifactUrl:t,finalArtifactType:r}).where(se(fs.id,e))}async createPipelineStep(e){let[t]=await W.insert(ks).values(e).returning();return t}async getPipelineSteps(e){return W.select().from(ks).where(se(ks.pipelineId,e)).orderBy(ks.stepOrder)}async updatePipelineStepStatus(e,t){let r={status:t};t==="RUNNING"&&(r.startedAt=new Date),(t==="DONE"||t==="FAILED"||t==="SKIPPED")&&(r.completedAt=new Date),await W.update(ks).set(r).where(se(ks.id,e))}async updatePipelineStepProgress(e,t){await W.update(ks).set({progress:Math.min(100,Math.max(0,t))}).where(se(ks.id,e))}async updatePipelineStepComplete(e,t,r){await W.update(ks).set({status:"DONE",progress:100,completedAt:new Date,outputData:t?JSON.stringify(t):null,artifactUrls:r?JSON.stringify(r):null}).where(se(ks.id,e))}async updatePipelineStepFailed(e,t){await W.update(ks).set({status:"FAILED",completedAt:new Date,errorMessage:t}).where(se(ks.id,e))}async createPipelineArtifact(e){let[t]=await W.insert(Nc).values(e).returning();return t}async getPipelineArtifacts(e){return W.select().from(Nc).where(se(Nc.pipelineId,e)).orderBy(Nc.createdAt)}async getFinalArtifact(e){let[t]=await W.select().from(Nc).where(Sr(se(Nc.pipelineId,e),se(Nc.isFinal,!0)));return t||void 0}async getClaimCasesByUserId(e){return W.select().from(Di).where(se(Di.veteranUserId,e)).orderBy(ut(Di.createdAt))}async getClaimCaseById(e){let[t]=await W.select().from(Di).where(se(Di.id,e));return t||void 0}async createClaimCase(e){let[t]=await W.insert(Di).values(e).returning();return t}async updateClaimCase(e,t){let[r]=await W.update(Di).set({...t,updatedAt:new Date}).where(se(Di.id,e)).returning();return r||void 0}async getClaimTasksByCaseId(e){return W.select().from(zo).where(se(zo.caseId,e)).orderBy(zo.sortOrder)}async getClaimTaskById(e){let[t]=await W.select().from(zo).where(se(zo.id,e));return t||void 0}async createClaimTask(e){let[t]=await W.insert(zo).values(e).returning();return t}async updateClaimTask(e,t){let[r]=await W.update(zo).set(t).where(se(zo.id,e)).returning();return r||void 0}async getCaseNotesByCaseId(e){return W.select().from(Pd).where(se(Pd.caseId,e)).orderBy(ut(Pd.createdAt))}async createCaseNote(e){let[t]=await W.insert(Pd).values(e).returning();return t}async getCaseDeadlinesByCaseId(e){return W.select().from(Pl).where(se(Pl.caseId,e)).orderBy(Pl.dueDate)}async createCaseDeadline(e){let[t]=await W.insert(Pl).values(e).returning();return t}async updateCaseDeadline(e,t){let[r]=await W.update(Pl).set(t).where(se(Pl.id,e)).returning();return r||void 0}async getClaimFilesByCaseId(e){return W.select().from(Il).where(se(Il.caseId,e)).orderBy(ut(Il.createdAt))}async createClaimFile(e){let[t]=await W.insert(Il).values(e).returning();return t}async getCaseSharesByCaseId(e){return W.select().from(es).where(se(es.caseId,e)).orderBy(ut(es.createdAt))}async getCaseShareByEmail(e,t){let[r]=await W.select().from(es).where(Sr(se(es.caseId,e),se(es.email,t)));return r}async getAllCaseShares(){return W.select().from(es).orderBy(ut(es.createdAt))}async upsertCaseShare(e){let t=await this.getCaseShareByEmail(e.caseId,e.email);if(t){let[s]=await W.update(es).set({role:e.role}).where(se(es.id,t.id)).returning();return s}let[r]=await W.insert(es).values(e).returning();return r}async getCaseShareById(e){let[t]=await W.select().from(es).where(se(es.id,e));return t}async deleteCaseShare(e){await W.delete(es).where(se(es.id,e))}async getEvidenceRequirements(e,t){return W.select().from(Go).where(Sr(se(Go.track,e),se(Go.purpose,t))).orderBy(Go.priority)}async getAllEvidenceRequirements(){return W.select().from(Go).orderBy(Go.track,Go.purpose,Go.priority)}async updateClaimFileEvidence(e,t){let[r]=await W.update(Il).set(t).where(se(Il.id,e)).returning();return r}async createVendorMagicLink(e){let[t]=await W.insert(Ao).values(e).returning();return t}async getVendorMagicLinkByToken(e){let[t]=await W.select().from(Ao).where(Sr(se(Ao.token,e),se(Ao.used,!1),cd(Ao.expiresAt,new Date)));return t}async markMagicLinkUsed(e){await W.update(Ao).set({used:!0}).where(se(Ao.id,e))}async createVendorSession(e){let[t]=await W.insert(Wo).values(e).returning();return t}async getVendorSessionByToken(e){let[t]=await W.select().from(Wo).where(Sr(se(Wo.sessionToken,e),cd(Wo.expiresAt,new Date)));return t}async deleteVendorSession(e){await W.delete(Wo).where(se(Wo.sessionToken,e))}async deleteExpiredMagicLinks(){await W.delete(Ao).where(ld(Ao.expiresAt,new Date))}async deleteExpiredVendorSessions(){await W.delete(Wo).where(ld(Wo.expiresAt,new Date))}async createAffiliateActivity(e){let[t]=await W.insert(Ho).values(e).returning();return t}async getAffiliateActivityByHash(e){let[t]=await W.select().from(Ho).where(se(Ho.hash,e));return t}async getAllAffiliateActivities(){return W.select().from(Ho).orderBy(ut(Ho.createdAt))}async getAffiliateActivitiesByActorEmail(e){return W.select().from(Ho).where(se(Ho.actorEmail,e)).orderBy(ut(Ho.createdAt))}async getNotificationSettings(e){let[t]=await W.select().from(Mu).where(se(Mu.userId,e));return t}async createNotificationSettings(e){let[t]=await W.insert(Mu).values(e).returning();return t}async updateNotificationSettings(e,t){let[r]=await W.update(Mu).set({...t,updatedAt:new Date}).where(se(Mu.userId,e)).returning();return r}async ensureNotificationSettings(e){let t=await this.getNotificationSettings(e);if(t)return t;let r={SITE_VISIT:!0,CONTRACT_VIEW:!0,CONTRACT_SIGNED:!0,INFO_REQUEST:!0,AFFILIATE_CLICK:!0,AFFILIATE_SIGNUP:!0},{encrypt:s}=await Promise.resolve().then(()=>(Iv(),Cv));return this.createNotificationSettings({userId:e,enabled:!0,emailsEnc:s(JSON.stringify([])),events:JSON.stringify(r),delivery:"instant"})}async createRepairLog(e){let[t]=await W.insert(Oc).values(e).returning();return t}async getRepairLogs(e=20){return W.select().from(Oc).orderBy(ut(Oc.createdAt)).limit(e)}async getRepairLogById(e){let[t]=await W.select().from(Oc).where(se(Oc.id,e));return t||void 0}async updateRepairLogStatus(e,t){let[r]=await W.update(Oc).set({status:t}).where(se(Oc.id,e)).returning();return r||void 0}async createCriticalIncident(e){let[t]=await W.insert(za).values(e).returning();return t}async getCriticalIncidentByIncidentId(e){let[t]=await W.select().from(za).where(se(za.incidentId,e));return t||void 0}async getCriticalIncidents(e,t=20){return e?W.select().from(za).where(se(za.status,e)).orderBy(ut(za.createdAt)).limit(t):W.select().from(za).orderBy(ut(za.createdAt)).limit(t)}async updateCriticalIncident(e,t){let[r]=await W.update(za).set(t).where(se(za.incidentId,e)).returning();return r||void 0}async createIncidentAuditLog(e){let[t]=await W.insert(kd).values(e).returning();return t}async getIncidentAuditLogs(e){return W.select().from(kd).where(se(kd.incidentId,e)).orderBy(kd.timestamp)}},q=new WR});var lX={};jr(lX,{LEGAL_DOCS:()=>nn,createLegalOverride:()=>KR,generateEvidenceBundle:()=>QR,getLegalStatus:()=>jd,hasSignedLegalDoc:()=>$_,hashDocument:()=>xm,healLegalStateOnLogin:()=>R5e,legalSystemHealthCheck:()=>wm,processExternalEsignCallback:()=>YR,requireLegalClearance:()=>F5e,runLegalTestBot:()=>XR,signLegalDocumentAtomic:()=>Pv,signLegalDocumentCore:()=>bm});function xm(n){return aX.default.createHash("sha256").update(n).digest("hex")}async function $_(n,e){let[t]=await W.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e.type),se(Kr.documentVersion,e.version)));return!!t}async function bm({userId:n,documentType:e,documentVersion:t,documentHash:r,ipAddress:s,userAgent:c}){return await W.transaction(async u=>{let[d]=await u.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e),se(Kr.documentVersion,t)));return d?{success:!0,alreadySigned:!0}:(await u.insert(Kr).values({userId:n,documentType:e,documentVersion:t,documentHash:r||null,ipAddress:s,userAgent:c}),{success:!0,alreadySigned:!1})})}async function Pv({userId:n,doc:e,docHash:t,req:r,provider:s=null,envelopeId:c=null}){let u=r.headers["x-forwarded-for"]?.toString().split(",")[0]||r.socket.remoteAddress||"unknown",d=r.headers["user-agent"]||"unknown";return bm({userId:n,documentType:e.type,documentVersion:e.version,documentHash:t,ipAddress:u,userAgent:d})}function F5e(){return async(n,e,t)=>{let r=n.session;if(!r?.userId||!r?.userRole)return e.status(401).json({message:"Unauthorized"});for(let s of Object.keys(nn)){let c=nn[s];if(!c.requiredFor.includes(r.userRole))continue;if(!await $_(r.userId,c))return e.status(403).json({required:c.type,redirectTo:c.path})}t()}}async function jd(n,e){let t={};for(let r of Object.keys(nn)){let s=nn[r];if(!s.requiredFor.includes(e)){t[r]=!0;continue}t[r]=await $_(n,s)}return t}async function R5e(n,e){for(let t of Object.keys(nn)){let r=nn[t];if(!r.requiredFor.includes(e))continue;if(!await $_(n,r))return{redirectTo:r.path}}return{ok:!0}}async function KR({adminId:n,userId:e,documentType:t,reason:r,req:s}){let c=s.headers["x-forwarded-for"]?.toString().split(",")[0]||s.socket.remoteAddress||"unknown",u=s.headers["user-agent"]||"unknown";await W.transaction(async d=>{await d.insert(Kr).values({userId:e,documentType:t,documentVersion:"ADMIN_OVERRIDE",documentHash:"OVERRIDE",ipAddress:c,userAgent:u}),await d.insert(x_).values({adminId:n,userId:e,documentType:t,reason:r})})}async function QR(n){let t=(await W.select().from(Kr).where(se(Kr.userId,n))).map(s=>`DOC: ${s.documentType}
                                                                                                                                                                                                                                                                                                                                                                                                                   ^
Error: DATABASE_URL must be set. Did you forget to provision a database?
    at /app/dist/index.cjs:87:410
    at /app/dist/index.cjs:87:1374
    at /app/dist/index.cjs:1:231
    at Object.<anonymous> (/app/dist/index.cjs:599:517)
    at Module._compile (node:internal/modules/cjs/loader:1706:14)
    at Object..js (node:internal/modules/cjs/loader:1839:10)
    at Module.load (node:internal/modules/cjs/loader:1441:32)
    at Function._load (node:internal/modules/cjs/loader:1263:12)
    at TracingChannel.traceSync (node:diagnostics_channel:328:14)
Node.js v22.22.0
npm warn config production Use `--omit=dev` instead.
> NODE_ENV=production node dist/index.cjs
/app/dist/index.cjs:87
/app/dist/index.cjs:87
                                                                                                                                                                                                                                                                                                                                                                                                                   ^
    at /app/dist/index.cjs:87:410
    at /app/dist/index.cjs:1:231
    at Object.<anonymous> (/app/dist/index.cjs:599:517)
    at Module.load (node:internal/modules/cjs/loader:1441:32)
    at TracingChannel.traceSync (node:diagnostics_channel:328:14)
Node.js v22.22.0
npm warn config production Use `--omit=dev` instead.
> rest-express@1.0.0 start
`+t)}function Bd(n,e,t,r,s,c){if(n.listenerCount("wsClientError")){let u=new Error(s);Error.captureStackTrace(u,Bd),n.emit("wsClientError",u,t,e)}else Ev(t,r,s,c)}});var S5e,E5e,T5e,tX,C5e,rX,nX=xe(()=>{S5e=Xt(zY(),1),E5e=Xt(LR(),1),T5e=Xt(jR(),1),tX=Xt(U_(),1),C5e=Xt(eX(),1),rX=tX.default});var I5e,W,Ks=xe(()=>{"use strict";T_();kQ();nX();Li();qu.webSocketConstructor=rX;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");I5e=new Fl({connectionString:process.env.DATABASE_URL}),W=I_({client:I5e,schema:b_})});var Cv={};jr(Cv,{decrypt:()=>k5e,encrypt:()=>P5e});function P5e(n){let e=Tv.default.randomBytes(16),t=Tv.default.createCipheriv("aes-256-gcm",sX,e),r=Buffer.concat([t.update(n,"utf8"),t.final()]),s=t.getAuthTag();return Buffer.concat([e,s,r]).toString("base64")}function k5e(n){let e=Buffer.from(n,"base64"),t=e.subarray(0,16),r=e.subarray(16,32),s=e.subarray(32),c=Tv.default.createDecipheriv("aes-256-gcm",sX,t);return c.setAuthTag(r),c.update(s).toString("utf8")+c.final("utf8")}var Tv,iX,sX,Iv=xe(()=>{"use strict";Tv=Xt(require("crypto"),1),iX=process.env.ENCRYPTION_KEY;if(!iX)throw new Error("ENCRYPTION_KEY environment variable is required in production");sX=Tv.default.createHash("sha256").update(iX||"dev-only-key-not-for-production-use").digest()});var WR,q,Jo=xe(()=>{"use strict";Li();Ks();Ji();WR=class{async getUser(e){let[t]=await W.select().from(St).where(se(St.id,e));return t||void 0}async getUserByEmail(e){let[t]=await W.select().from(St).where(se(St.email,e));return t||void 0}async getUserByReferralCode(e){let[t]=await W.select().from(St).where(se(St.referralCode,e));return t||void 0}async createUser(e){let[t]=await W.insert(St).values(e).returning();return t}async getAllAffiliates(){return W.select().from(St).where(se(St.role,"affiliate")).orderBy(ut(St.createdAt))}async updateUserPassword(e,t){let[r]=await W.update(St).set({passwordHash:t}).where(se(St.id,e)).returning();return r||void 0}async updateUserReferralCode(e,t){let[r]=await W.update(St).set({referralCode:t}).where(se(St.id,e)).returning();return r||void 0}async deleteUser(e){await W.delete(St).where(se(St.id,e))}async createAffiliateApplication(e){let[t]=await W.insert(Ca).values(e).returning();return t}async getAffiliateApplication(e){let[t]=await W.select().from(Ca).where(se(Ca.id,e));return t||void 0}async getAllAffiliateApplications(){return W.select().from(Ca).orderBy(ut(Ca.createdAt))}async getAffiliateApplicationsByAssignee(e){return W.select().from(Ca).where(se(Ca.assignedTo,e)).orderBy(ut(Ca.createdAt))}async updateAffiliateApplication(e,t){let[r]=await W.update(Ca).set({...t,updatedAt:new Date}).where(se(Ca.id,e)).returning();return r||void 0}async createHelpRequest(e){let[t]=await W.insert(Ia).values(e).returning();return t}async getHelpRequest(e){let[t]=await W.select().from(Ia).where(se(Ia.id,e));return t||void 0}async getAllHelpRequests(){return W.select().from(Ia).orderBy(ut(Ia.createdAt))}async getHelpRequestsByAssignee(e){return W.select().from(Ia).where(se(Ia.assignedTo,e)).orderBy(ut(Ia.createdAt))}async updateHelpRequest(e,t){let[r]=await W.update(Ia).set({...t,updatedAt:new Date}).where(se(Ia.id,e)).returning();return r||void 0}async createStartupGrant(e){let[t]=await W.insert(Pa).values(e).returning();return t}async getStartupGrant(e){let[t]=await W.select().from(Pa).where(se(Pa.id,e));return t||void 0}async getAllStartupGrants(){return W.select().from(Pa).orderBy(ut(Pa.createdAt))}async getStartupGrantsByAssignee(e){return W.select().from(Pa).where(se(Pa.assignedTo,e)).orderBy(ut(Pa.createdAt))}async updateStartupGrant(e,t){let[r]=await W.update(Pa).set({...t,updatedAt:new Date}).where(se(Pa.id,e)).returning();return r||void 0}async createFurnitureAssistance(e){let[t]=await W.insert(ka).values(e).returning();return t}async getFurnitureAssistance(e){let[t]=await W.select().from(ka).where(se(ka.id,e));return t||void 0}async getAllFurnitureAssistance(){return W.select().from(ka).orderBy(ut(ka.createdAt))}async getFurnitureAssistanceByAssignee(e){return W.select().from(ka).where(se(ka.assignedTo,e)).orderBy(ut(ka.createdAt))}async updateFurnitureAssistance(e,t){let[r]=await W.update(ka).set({...t,updatedAt:new Date}).where(se(ka.id,e)).returning();return r||void 0}async createInvestorSubmission(e){let[t]=await W.insert(Fa).values(e).returning();return t}async getInvestorSubmission(e){let[t]=await W.select().from(Fa).where(se(Fa.id,e));return t||void 0}async getAllInvestorSubmissions(){return W.select().from(Fa).orderBy(ut(Fa.createdAt))}async getInvestorSubmissionsByAssignee(e){return W.select().from(Fa).where(se(Fa.assignedTo,e)).orderBy(ut(Fa.createdAt))}async updateInvestorSubmission(e,t){let[r]=await W.update(Fa).set({...t,updatedAt:new Date}).where(se(Fa.id,e)).returning();return r||void 0}async createPrivateDoctorRequest(e){let[t]=await W.insert(Ra).values(e).returning();return t}async getPrivateDoctorRequest(e){let[t]=await W.select().from(Ra).where(se(Ra.id,e));return t||void 0}async getAllPrivateDoctorRequests(){return W.select().from(Ra).orderBy(ut(Ra.createdAt))}async getPrivateDoctorRequestsByAssignee(e){return W.select().from(Ra).where(se(Ra.assignedTo,e)).orderBy(ut(Ra.createdAt))}async updatePrivateDoctorRequest(e,t){let[r]=await W.update(Ra).set({...t,updatedAt:new Date}).where(se(Ra.id,e)).returning();return r||void 0}async createWebsiteApplication(e){let[t]=await W.insert(Na).values(e).returning();return t}async getWebsiteApplication(e){let[t]=await W.select().from(Na).where(se(Na.id,e));return t||void 0}async getAllWebsiteApplications(){return W.select().from(Na).orderBy(ut(Na.createdAt))}async getWebsiteApplicationsByAssignee(e){return W.select().from(Na).where(se(Na.assignedTo,e)).orderBy(ut(Na.createdAt))}async updateWebsiteApplication(e,t){let[r]=await W.update(Na).set({...t,updatedAt:new Date}).where(se(Na.id,e)).returning();return r||void 0}async createGeneralContact(e){let[t]=await W.insert(Oa).values(e).returning();return t}async getGeneralContact(e){let[t]=await W.select().from(Oa).where(se(Oa.id,e));return t||void 0}async getAllGeneralContacts(){return W.select().from(Oa).orderBy(ut(Oa.createdAt))}async getGeneralContactsByAssignee(e){return W.select().from(Oa).where(se(Oa.assignedTo,e)).orderBy(ut(Oa.createdAt))}async updateGeneralContact(e,t){let[r]=await W.update(Oa).set({...t,updatedAt:new Date}).where(se(Oa.id,e)).returning();return r||void 0}async createVltIntake(e){let t=e.issue==="credits"?"CPA":e.issue==="resolution"?"Tax Attorney":"General";console.log("NEW LEAD:",{...e,routedTo:t,timestamp:new Date().toISOString()});let[r]=await W.insert(Zi).values({...e,routedTo:t}).returning();return r}async getVltIntake(e){let[t]=await W.select().from(Zi).where(se(Zi.id,e));return t||void 0}async getAllVltIntakes(){return W.select().from(Zi).orderBy(ut(Zi.createdAt))}async updateVltIntake(e,t){let[r]=await W.update(Zi).set(t).where(se(Zi.id,e)).returning();return r||void 0}async getVltIntakesByAffiliate(e){return W.select().from(Zi).where(od(se(Zi.referredByL1,e),se(Zi.referredByL2,e),se(Zi.referredByL3,e),se(Zi.referredByL4,e),se(Zi.referredByL5,e),se(Zi.referredByL6,e))).orderBy(ut(Zi.createdAt))}async createVltAffiliate(e){let[t]=await W.insert(Pr).values(e).returning();return t}async getVltAffiliate(e){let[t]=await W.select().from(Pr).where(se(Pr.id,e));return t||void 0}async getVltAffiliateByEmail(e){let[t]=await W.select().from(Pr).where(se(Pr.email,e));return t||void 0}async getVltAffiliateByReferralCode(e){let[t]=await W.select().from(Pr).where(se(Pr.referralCode,e));return t||void 0}async getAllVltAffiliates(){return W.select().from(Pr).orderBy(ut(Pr.createdAt))}async updateVltAffiliate(e,t){let[r]=await W.update(Pr).set({...t,updatedAt:new Date}).where(se(Pr.id,e)).returning();return r||void 0}async deleteVltAffiliate(e){await W.delete(Pr).where(se(Pr.id,e))}async getVltAffiliatesByRole(e){return W.select().from(Pr).where(se(Pr.role,e)).orderBy(ut(Pr.createdAt))}async getVltAffiliateDownline(e){return W.select().from(Pr).where(od(se(Pr.level1Id,e),se(Pr.level2Id,e),se(Pr.level3Id,e),se(Pr.level4Id,e),se(Pr.level5Id,e),se(Pr.level6Id,e),se(Pr.level7Id,e))).orderBy(ut(Pr.createdAt))}async createOpportunity(e){let[t]=await W.insert(da).values(e).returning();return t}async getOpportunity(e){let[t]=await W.select().from(da).where(se(da.id,e));return t||void 0}async getAllOpportunities(){return W.select().from(da).orderBy(ut(da.createdAt))}async getOpportunitiesByCategory(e){return W.select().from(da).where(se(da.category,e)).orderBy(ut(da.createdAt))}async updateOpportunity(e,t){let[r]=await W.update(da).set(t).where(se(da.id,e)).returning();return r||void 0}async createSale(e){let[t]=await W.insert(qn).values(e).returning();return t}async getSale(e){let[t]=await W.select().from(qn).where(se(qn.id,e));return t||void 0}async getAllSales(){return W.select().from(qn).orderBy(ut(qn.createdAt))}async getSalesByAffiliate(e){return W.select().from(qn).where(se(qn.affiliateId,e)).orderBy(ut(qn.createdAt))}async getSalesByDownline(e){return W.select().from(qn).where(od(se(qn.referredByL1,e),se(qn.referredByL2,e),se(qn.referredByL3,e),se(qn.referredByL4,e),se(qn.referredByL5,e),se(qn.referredByL6,e),se(qn.referredByL7,e))).orderBy(ut(qn.createdAt))}async updateSale(e,t){let[r]=await W.update(qn).set({...t,updatedAt:new Date}).where(se(qn.id,e)).returning();return r||void 0}async createCommission(e){let[t]=await W.insert(pa).values(e).returning();return t}async getCommission(e){let[t]=await W.select().from(pa).where(se(pa.id,e));return t||void 0}async getCommissionsByAffiliate(e){return W.select().from(pa).where(se(pa.affiliateId,e)).orderBy(ut(pa.createdAt))}async getCommissionsBySale(e){return W.select().from(pa).where(se(pa.saleId,e)).orderBy(ut(pa.createdAt))}async updateCommission(e,t){let[r]=await W.update(pa).set(t).where(se(pa.id,e)).returning();return r||void 0}async createVeteranIntake(e){let[t]=await W.insert(Da).values(e).returning();return t}async getVeteranIntake(e){let[t]=await W.select().from(Da).where(se(Da.id,e));return t||void 0}async getAllVeteranIntakes(){return W.select().from(Da).orderBy(ut(Da.createdAt))}async getVeteranIntakesByProgram(e){return W.select().from(Da).where(se(Da.programType,e)).orderBy(ut(Da.createdAt))}async updateVeteranIntake(e,t){let[r]=await W.update(Da).set({...t,updatedAt:new Date}).where(se(Da.id,e)).returning();return r||void 0}async createBusinessIntake(e){let[t]=await W.insert(La).values(e).returning();return t}async getBusinessIntake(e){let[t]=await W.select().from(La).where(se(La.id,e));return t||void 0}async getAllBusinessIntakes(){return W.select().from(La).orderBy(ut(La.createdAt))}async getBusinessIntakesByService(e){return W.select().from(La).where(se(La.serviceType,e)).orderBy(ut(La.createdAt))}async updateBusinessIntake(e,t){let[r]=await W.update(La).set({...t,updatedAt:new Date}).where(se(La.id,e)).returning();return r||void 0}async createContractTemplate(e){let[t]=await W.insert(ha).values(e).returning();return t}async getContractTemplate(e){let[t]=await W.select().from(ha).where(se(ha.id,e));return t||void 0}async getAllContractTemplates(){return W.select().from(ha).orderBy(ut(ha.createdAt))}async getActiveContractTemplates(){return W.select().from(ha).where(se(ha.isActive,"true")).orderBy(ut(ha.createdAt))}async updateContractTemplate(e,t){let[r]=await W.update(ha).set({...t,updatedAt:new Date}).where(se(ha.id,e)).returning();return r||void 0}async createSignedAgreement(e){let[t]=await W.insert(ki).values(e).returning();return t}async getSignedAgreement(e){let[t]=await W.select().from(ki).where(se(ki.id,e));return t||void 0}async getAllSignedAgreements(){return W.select().from(ki).orderBy(ut(ki.signedAt))}async getSignedAgreementsByAffiliate(e){return W.select().from(ki).where(se(ki.affiliateId,e)).orderBy(ut(ki.signedAt))}async hasAffiliateSignedContract(e,t){let[r]=await W.select().from(ki).where(Sr(se(ki.affiliateId,e),se(ki.contractTemplateId,t),se(ki.status,"signed")));return!!r}async updateSignedAgreement(e,t){let[r]=await W.update(ki).set(t).where(se(ki.id,e)).returning();return r||void 0}async createCommissionConfig(e){let[t]=await W.insert(El).values(e).returning();return t}async getActiveCommissionConfig(){let[e]=await W.select().from(El).where(se(El.isActive,"true")).orderBy(ut(El.createdAt)).limit(1);return e||void 0}async updateCommissionConfig(e,t){let[r]=await W.update(El).set({...t,updatedAt:new Date}).where(se(El.id,e)).returning();return r||void 0}async createAffiliateNda(e){let[t]=await W.insert(Fi).values(e).returning();return t}async getAffiliateNdaByUserId(e){let[t]=await W.select().from(Fi).where(se(Fi.userId,e));return t||void 0}async getAffiliateNdaById(e){let[t]=await W.select().from(Fi).where(se(Fi.id,e));return t||void 0}async hasAffiliateSignedNda(e){return!!await this.getAffiliateNdaByUserId(e)}async getAllAffiliateNdas(){return W.select().from(Fi).orderBy(ut(Fi.signedAt))}async signNdaAtomic(e,t,r){return await W.transaction(async s=>{let[c]=await s.select().from(Fi).where(se(Fi.userId,e));if(c)return{nda:c,alreadySigned:!0};await s.update(St).set({referralCode:t}).where(se(St.id,e));let[u]=await s.insert(Fi).values(r).returning();return{nda:u,alreadySigned:!1}})}async createBusinessLead(e){let[t]=await W.insert(Is).values(e).returning();return t}async getBusinessLead(e){let[t]=await W.select().from(Is).where(se(Is.id,e));return t||void 0}async getAllBusinessLeads(){return W.select().from(Is).orderBy(ut(Is.createdAt))}async getBusinessLeadsByType(e){return W.select().from(Is).where(se(Is.leadType,e)).orderBy(ut(Is.createdAt))}async getBusinessLeadsByReferrer(e){return W.select().from(Is).where(se(Is.referredBy,e)).orderBy(ut(Is.createdAt))}async updateBusinessLead(e,t){let[r]=await W.update(Is).set({...t,updatedAt:new Date}).where(se(Is.id,e)).returning();return r||void 0}async createIpReferralTracking(e){let[t]=await W.insert(Ma).values(e).returning();return t}async getActiveIpReferral(e){let t=new Date,[r]=await W.select().from(Ma).where(Sr(se(Ma.ipAddress,e),cd(Ma.expiresAt,t))).orderBy(ut(Ma.createdAt)).limit(1);return r||void 0}async getIpReferralsByAffiliate(e){return W.select().from(Ma).where(se(Ma.affiliateId,e)).orderBy(ut(Ma.createdAt))}async getAllIpReferrals(){return W.select().from(Ma).orderBy(ut(Ma.createdAt))}async createAffiliateW9(e){let[t]=await W.insert(Id).values(e).returning();return t}async getAffiliateW9ByUserId(e){let[t]=await W.select().from(Id).where(se(Id.userId,e));return t||void 0}async hasAffiliateSubmittedW9(e){return!!await this.getAffiliateW9ByUserId(e)}async getAllAffiliateW9s(){return await W.select().from(Id)}async createFinopsReferral(e){let[t]=await W.insert(Ps).values(e).returning();return t}async getFinopsReferral(e){let[t]=await W.select().from(Ps).where(se(Ps.id,e));return t||void 0}async getAllFinopsReferrals(){return W.select().from(Ps).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByAffiliate(e){return W.select().from(Ps).where(se(Ps.affiliateId,e)).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByPartnerType(e){return W.select().from(Ps).where(se(Ps.partnerType,e)).orderBy(ut(Ps.createdAt))}async updateFinopsReferral(e,t){let[r]=await W.update(Ps).set(t).where(se(Ps.id,e)).returning();return r||void 0}async createDisabilityReferral(e){let[t]=await W.insert(ma).values(e).returning();return t}async getDisabilityReferral(e){let[t]=await W.select().from(ma).where(se(ma.id,e));return t||void 0}async getAllDisabilityReferrals(){return W.select().from(ma).orderBy(ut(ma.createdAt))}async getDisabilityReferralsByAffiliate(e){return W.select().from(ma).where(se(ma.affiliateId,e)).orderBy(ut(ma.createdAt))}async updateDisabilityReferral(e,t){let[r]=await W.update(ma).set({...t,updatedAt:new Date}).where(se(ma.id,e)).returning();return r||void 0}async getDisabilityReferralStats(){let e=await W.select().from(ma),t={},r={};for(let s of e)t[s.claimType]=(t[s.claimType]||0)+1,r[s.status]=(r[s.status]||0)+1;return{total:e.length,byType:t,byStatus:r}}async createJobPlacementIntake(e){let[t]=await W.insert(Ba).values(e).returning();return t}async getJobPlacementIntake(e){let[t]=await W.select().from(Ba).where(se(Ba.id,e));return t||void 0}async getAllJobPlacementIntakes(){return W.select().from(Ba).orderBy(ut(Ba.createdAt))}async getJobPlacementIntakesByAffiliate(e){return W.select().from(Ba).where(se(Ba.affiliateId,e)).orderBy(ut(Ba.createdAt))}async updateJobPlacementIntake(e,t){let[r]=await W.update(Ba).set({...t,updatedAt:new Date}).where(se(Ba.id,e)).returning();return r||void 0}async createVetProfessionalIntake(e){let[t]=await W.insert(ja).values(e).returning();return t}async getVetProfessionalIntake(e){let[t]=await W.select().from(ja).where(se(ja.id,e));return t||void 0}async getAllVetProfessionalIntakes(){return W.select().from(ja).orderBy(ut(ja.createdAt))}async getVetProfessionalIntakesByAffiliate(e){return W.select().from(ja).where(se(ja.affiliateId,e)).orderBy(ut(ja.createdAt))}async updateVetProfessionalIntake(e,t){let[r]=await W.update(ja).set({...t,updatedAt:new Date}).where(se(ja.id,e)).returning();return r||void 0}async createHealthcareIntake(e){let[t]=await W.insert(Ou).values(e).returning();return t}async getAllHealthcareIntakes(){return W.select().from(Ou).orderBy(ut(Ou.createdAt))}async updateHealthcareIntake(e,t){let[r]=await W.update(Ou).set({...t,updatedAt:new Date}).where(se(Ou.id,e)).returning();return r||void 0}async createScheduleASignature(e){let[t]=await W.insert(Du).values(e).returning();return t}async getScheduleASignatureByUserId(e){let[t]=await W.select().from(Du).where(se(Du.userId,e));return t||void 0}async getAllScheduleASignatures(){return W.select().from(Du).orderBy(ut(Du.signedAt))}async createInsuranceIntake(e){let[t]=await W.insert(Lu).values(e).returning();return t}async getAllInsuranceIntakes(){return W.select().from(Lu).orderBy(ut(Lu.createdAt))}async updateInsuranceIntake(e,t){let[r]=await W.update(Lu).set({...t,updatedAt:new Date}).where(se(Lu.id,e)).returning();return r||void 0}async createMedicalSalesIntake(e){let[t]=await W.insert(qo).values(e).returning();return t}async getAllMedicalSalesIntakes(){return W.select().from(qo).orderBy(ut(qo.createdAt))}async getMedicalSalesIntakesByAffiliate(e){return W.select().from(qo).where(se(qo.assignedTo,e)).orderBy(ut(qo.createdAt))}async updateMedicalSalesIntake(e,t){let[r]=await W.update(qo).set({...t,updatedAt:new Date}).where(se(qo.id,e)).returning();return r||void 0}async createBusinessDevIntake(e){let[t]=await W.insert($o).values(e).returning();return t}async getAllBusinessDevIntakes(){return W.select().from($o).orderBy(ut($o.createdAt))}async getBusinessDevIntakesByAffiliate(e){return W.select().from($o).where(se($o.assignedTo,e)).orderBy(ut($o.createdAt))}async updateBusinessDevIntake(e,t){let[r]=await W.update($o).set({...t,updatedAt:new Date}).where(se($o.id,e)).returning();return r||void 0}async getUserById(e){return this.getUser(e)}async createCsuContractTemplate(e){let[t]=await W.insert($r).values(e).returning();return t}async getCsuContractTemplate(e){let[t]=await W.select().from($r).where(se($r.id,e));return t||void 0}async getAllCsuContractTemplates(){return W.select().from($r).orderBy(ut($r.createdAt))}async getActiveCsuContractTemplates(){return W.select().from($r).where(se($r.isActive,!0)).orderBy(ut($r.createdAt))}async updateCsuContractTemplate(e,t){let[r]=await W.update($r).set({...t,updatedAt:new Date}).where(se($r.id,e)).returning();return r||void 0}async getActiveTemplatesByPortal(e){return W.select().from($r).where(Sr(se($r.isActive,!0),od(se($r.portal,e),ml($r.portal)))).orderBy(ut($r.createdAt))}async deleteCsuContractTemplate(e){await W.delete($r).where(se($r.id,e))}async createCsuContractTemplateField(e){let[t]=await W.insert(Ua).values(e).returning();return t}async getCsuContractTemplateFields(e){return W.select().from(Ua).where(se(Ua.templateId,e)).orderBy(Ua.order)}async updateCsuContractTemplateField(e,t){let[r]=await W.update(Ua).set(t).where(se(Ua.id,e)).returning();return r||void 0}async deleteCsuContractTemplateField(e){await W.delete(Ua).where(se(Ua.id,e))}async deleteAllCsuContractTemplateFields(e){await W.delete(Ua).where(se(Ua.templateId,e))}async createCsuContractSend(e){let[t]=await W.insert(ga).values(e).returning();return t}async getCsuContractSend(e){let[t]=await W.select().from(ga).where(se(ga.id,e));return t||void 0}async getCsuContractSendByToken(e){let[t]=await W.select().from(ga).where(se(ga.signToken,e));return t||void 0}async getAllCsuContractSends(){return W.select().from(ga).orderBy(ut(ga.createdAt))}async updateCsuContractSend(e,t){let[r]=await W.update(ga).set(t).where(se(ga.id,e)).returning();return r||void 0}async createCsuSignedAgreement(e){let[t]=await W.insert(Cn).values(e).returning();return t}async getCsuSignedAgreement(e){let[t]=await W.select().from(Cn).where(se(Cn.id,e));return t||void 0}async getAllCsuSignedAgreements(){return await W.select({id:Cn.id,contractSendId:Cn.contractSendId,templateId:Cn.templateId,signerName:Cn.signerName,signerEmail:Cn.signerEmail,signerPhone:Cn.signerPhone,address:Cn.address,initials:Cn.initials,effectiveDate:Cn.effectiveDate,signatureData:Cn.signatureData,signedIpAddress:Cn.signedIpAddress,agreedToTerms:Cn.agreedToTerms,signedAt:Cn.signedAt,createdAt:Cn.createdAt,templateName:$r.name}).from(Cn).leftJoin($r,se(Cn.templateId,$r.id)).orderBy(ut(Cn.createdAt))}async createPortalActivity(e){let[t]=await W.insert(Cl).values(e).returning();return t}async getPortalActivity(e,t){return W.select().from(Cl).where(se(Cl.portal,e)).orderBy(ut(Cl.createdAt)).limit(t)}async getPortalStats(e){let t=await W.select().from(Cl).where(se(Cl.portal,e)),r=new Date;r.setHours(0,0,0,0);let s=t.filter(v=>new Date(v.createdAt)>=r),c=t.filter(v=>v.eventType==="page_view"),u=new Set(c.map(v=>v.ipAddress).filter(Boolean)),d=t.filter(v=>v.eventType==="contract_sent").length,m=t.filter(v=>v.eventType==="contract_signed").length;return{totalVisits:c.length,uniqueIps:u.size,contractsSent:d,contractsSigned:m,todayVisits:s.filter(v=>v.eventType==="page_view").length}}async createPasswordResetToken(e){let[t]=await W.insert(qa).values(e).returning();return t}async getValidPasswordResetToken(e){let t=new Date,[r]=await W.select().from(qa).where(Sr(se(qa.tokenHash,e),ml(qa.usedAt),cd(qa.expiresAt,t)));return r||void 0}async invalidatePasswordResetToken(e){await W.update(qa).set({usedAt:new Date}).where(se(qa.id,e))}async invalidateAllUserPasswordResetTokens(e){await W.update(qa).set({usedAt:new Date}).where(Sr(se(qa.userId,e),ml(qa.usedAt)))}async createPartnerSharingLog(e){let[t]=await W.insert(Fc).values(e).returning();return t}async getPartnerSharingLogsBySubmission(e,t){return await W.select().from(Fc).where(Sr(se(Fc.submissionType,e),se(Fc.submissionId,t))).orderBy(ut(Fc.sharedAt))}async getAllPartnerSharingLogs(){return await W.select().from(Fc).orderBy(ut(Fc.sharedAt))}async createConsentRecord(e){let[t]=await W.insert($a).values(e).returning();return t}async getConsentRecordsBySubmission(e,t){return await W.select().from($a).where(Sr(se($a.submissionType,e),se($a.submissionId,t))).orderBy(ut($a.submittedAt))}async getConsentRecordByEmail(e){return await W.select().from($a).where(se($a.email,e)).orderBy(ut($a.submittedAt))}async getAllConsentRecords(){return await W.select().from($a).orderBy(ut($a.submittedAt))}async createAffiliatedPartner(e){let[t]=await W.insert(Ha).values(e).returning();return t}async getActiveAffiliatedPartners(){return await W.select().from(Ha).where(se(Ha.isActive,!0)).orderBy(Ha.category,Ha.displayName)}async getAllAffiliatedPartners(){return await W.select().from(Ha).orderBy(Ha.category,Ha.displayName)}async updateAffiliatedPartner(e,t){let[r]=await W.update(Ha).set(t).where(se(Ha.id,e)).returning();return r||void 0}async createRangerTabApplication(e){let[t]=await W.insert(Bu).values(e).returning();return t}async getAllRangerTabApplications(){return W.select().from(Bu).orderBy(ut(Bu.createdAt))}async updateRangerTabApplication(e,t){let[r]=await W.update(Bu).set({...t,updatedAt:new Date}).where(se(Bu.id,e)).returning();return r||void 0}async createCsuEnvelope(e){let[t]=await W.insert(wo).values(e).returning();return t}async getCsuEnvelope(e){let[t]=await W.select().from(wo).where(se(wo.id,e));return t||void 0}async getAllCsuEnvelopes(){return W.select().from(wo).orderBy(ut(wo.createdAt))}async updateCsuEnvelope(e,t){let[r]=await W.update(wo).set({...t,updatedAt:new Date}).where(se(wo.id,e)).returning();return r||void 0}async createCsuEnvelopeRecipient(e){let[t]=await W.insert(ya).values(e).returning();return t}async getCsuEnvelopeRecipient(e){let[t]=await W.select().from(ya).where(se(ya.id,e));return t||void 0}async getCsuEnvelopeRecipientByToken(e){let[t]=await W.select().from(ya).where(se(ya.signToken,e));return t||void 0}async getEnvelopeRecipients(e){return W.select().from(ya).where(se(ya.envelopeId,e)).orderBy(ya.routingOrder)}async updateCsuEnvelopeRecipient(e,t){let[r]=await W.update(ya).set(t).where(se(ya.id,e)).returning();return r||void 0}async createCsuAuditTrail(e){let[t]=await W.insert(kc).values(e).returning();return t}async getAuditTrailForEnvelope(e){return W.select().from(kc).where(se(kc.envelopeId,e)).orderBy(ut(kc.createdAt))}async getAuditTrailForContractSend(e){return W.select().from(kc).where(se(kc.contractSendId,e)).orderBy(ut(kc.createdAt))}async createHipaaAuditLog(e){let[t]=await W.insert(Ri).values(e).returning();return t}async getHipaaAuditLogs(e=1e3){return W.select().from(Ri).orderBy(ut(Ri.timestamp)).limit(e)}async getHipaaAuditLogsByUser(e){return W.select().from(Ri).where(se(Ri.userId,e)).orderBy(ut(Ri.timestamp))}async getHipaaAuditLogsByResource(e,t){return t?W.select().from(Ri).where(Sr(se(Ri.resourceType,e),se(Ri.resourceId,t))).orderBy(ut(Ri.timestamp)):W.select().from(Ri).where(se(Ri.resourceType,e)).orderBy(ut(Ri.timestamp))}async getHipaaPhiAccessLogs(){return W.select().from(Ri).where(se(Ri.phiAccessed,!0)).orderBy(ut(Ri.timestamp))}async createHipaaTrainingRecord(e){let[t]=await W.insert(Va).values(e).returning();return t}async getHipaaTrainingRecordsByUser(e){return W.select().from(Va).where(se(Va.userId,e)).orderBy(ut(Va.completedAt))}async getAllHipaaTrainingRecords(){return W.select().from(Va).orderBy(ut(Va.completedAt))}async getExpiredTrainingRecords(){let e=new Date;return W.select().from(Va).where(Sr(se(Va.passed,!0),ld(Va.expiresAt,e))).orderBy(ut(Va.expiresAt))}async createBusinessAssociateAgreement(e){let[t]=await W.insert(Rc).values(e).returning();return t}async getBusinessAssociateAgreement(e){let[t]=await W.select().from(Rc).where(se(Rc.id,e));return t||void 0}async getAllBusinessAssociateAgreements(){return W.select().from(Rc).orderBy(ut(Rc.updatedAt))}async updateBusinessAssociateAgreement(e,t){let[r]=await W.update(Rc).set({...t,updatedAt:new Date}).where(se(Rc.id,e)).returning();return r||void 0}async createUserMfaConfig(e){let[t]=await W.insert(ju).values(e).returning();return t}async getUserMfaConfig(e){let[t]=await W.select().from(ju).where(se(ju.userId,e));return t||void 0}async updateUserMfaConfig(e,t){let[r]=await W.update(ju).set({...t,updatedAt:new Date}).where(se(ju.userId,e)).returning();return r||void 0}async getAuthRateLimit(e,t,r){let[s]=await W.select().from(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)));return s||void 0}async createOrUpdateAuthRateLimit(e){let t=await this.getAuthRateLimit(e.identifier,e.identifierType,e.attemptType);if(t){let[s]=await W.update(va).set({failedAttempts:e.failedAttempts,lastAttemptAt:new Date,lockedUntil:e.lockedUntil,updatedAt:new Date}).where(se(va.id,t.id)).returning();return s}let[r]=await W.insert(va).values({...e,lastAttemptAt:new Date}).returning();return r}async resetAuthRateLimit(e,t,r){await W.delete(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)))}async createAiGeneration(e){let[t]=await W.insert(ai).values(e).returning();return t}async getAiGeneration(e){let[t]=await W.select().from(ai).where(se(ai.id,e));return t||void 0}async getAiGenerationsByUser(e){return W.select().from(ai).where(se(ai.userId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsBySession(e){return W.select().from(ai).where(se(ai.sessionId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsByStatus(e){return W.select().from(ai).where(se(ai.status,e)).orderBy(ai.createdAt)}async updateAiGeneration(e,t){let[r]=await W.update(ai).set({...t,updatedAt:new Date}).where(se(ai.id,e)).returning();return r||void 0}async deleteAiGeneration(e){await W.delete(ai).where(se(ai.id,e))}async getAllAiGenerations(e=100){return W.select().from(ai).orderBy(ut(ai.createdAt)).limit(e)}async createAiTemplate(e){let[t]=await W.insert($n).values(e).returning();return t}async getAiTemplate(e){let[t]=await W.select().from($n).where(se($n.id,e));return t||void 0}async getAllAiTemplates(){return W.select().from($n).orderBy(ut($n.usageCount))}async getActiveAiTemplates(){return W.select().from($n).where(se($n.isActive,!0)).orderBy(ut($n.usageCount))}async getAiTemplatesByCategory(e){return W.select().from($n).where(Sr(se($n.category,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async getAiTemplatesByType(e){return W.select().from($n).where(Sr(se($n.type,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async updateAiTemplate(e,t){let[r]=await W.update($n).set({...t,updatedAt:new Date}).where(se($n.id,e)).returning();return r||void 0}async incrementTemplateUsage(e){let t=await this.getAiTemplate(e);t&&await W.update($n).set({usageCount:(t.usageCount||0)+1,updatedAt:new Date}).where(se($n.id,e))}async saveOperatorAiMessage(e){let[t]=await W.insert(Ni).values(e).returning();return t}async getSessionMemory(e){return W.select().from(Ni).where(se(Ni.sessionId,e)).orderBy(Ni.messageOrder)}async getUserPersistentMemory(e){return W.select().from(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent"))).orderBy(Ni.messageOrder)}async clearSessionMemory(e){await W.delete(Ni).where(se(Ni.sessionId,e))}async clearUserPersistentMemory(e){await W.delete(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent")))}async cleanupExpiredSessions(){await W.delete(Ni).where(Sr(se(Ni.memoryMode,"session"),ld(Ni.expiresAt,new Date)))}async getOrCreateAiUser(e,t){if(e){let s=await W.select().from(In).where(se(In.email,e));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}if(t){let s=await W.select().from(In).where(se(In.anonDeviceId,t));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}let[r]=await W.insert(In).values({email:e||null,anonDeviceId:t||null,memoryMode:"OFF"}).returning();return r}async getAiUser(e){let[t]=await W.select().from(In).where(se(In.id,e));return t||void 0}async getAiUserByEmail(e){let[t]=await W.select().from(In).where(se(In.email,e));return t||void 0}async updateAiUserMemoryMode(e,t){let[r]=await W.update(In).set({memoryMode:t,lastActiveAt:new Date}).where(se(In.id,e)).returning();return r||void 0}async deleteAiUser(e){await W.delete(In).where(se(In.id,e))}async createAiSession(e){let[t]=await W.insert(oi).values(e).returning();return t}async getAiSession(e){let[t]=await W.select().from(oi).where(se(oi.id,e));return t||void 0}async getAiSessionByToken(e){let[t]=await W.select().from(oi).where(se(oi.sessionToken,e));return t||void 0}async getUserAiSessions(e){return W.select().from(oi).where(se(oi.userId,e)).orderBy(ut(oi.createdAt))}async endAiSession(e){await W.update(oi).set({endedAt:new Date}).where(se(oi.id,e))}async deleteAiSession(e){await W.delete(_o).where(se(_o.sessionId,e)),await W.delete(oi).where(se(oi.id,e))}async createAiMessage(e){let[t]=await W.insert(_o).values(e).returning();return await W.update(oi).set({lastMessageAt:new Date}).where(se(oi.id,e.sessionId)),t}async getAiSessionMessages(e){return W.select().from(_o).where(se(_o.sessionId,e)).orderBy(_o.createdAt)}async deleteAiSessionMessages(e){await W.delete(_o).where(se(_o.sessionId,e))}async createAiFile(e){let[t]=await W.insert(us).values(e).returning();return t}async getAiFile(e){let[t]=await W.select().from(us).where(Sr(se(us.id,e),ml(us.deletedAt)));return t||void 0}async getSessionAiFiles(e){return W.select().from(us).where(Sr(se(us.sessionId,e),ml(us.deletedAt)))}async getUserAiFiles(e){return W.select().from(us).where(Sr(se(us.ownerUserId,e),ml(us.deletedAt)))}async softDeleteAiFile(e){await W.update(us).set({deletedAt:new Date}).where(se(us.id,e))}async deleteSessionAiFiles(e){await W.update(us).set({deletedAt:new Date}).where(se(us.sessionId,e))}async setAiMemory(e,t,r,s){let c=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));if(c[0]){let[d]=await W.update(bi).set({value:r,sourceMessageId:s,updatedAt:new Date}).where(se(bi.id,c[0].id)).returning();return d}let[u]=await W.insert(bi).values({userId:e,key:t,value:r,sourceMessageId:s}).returning();return u}async getAiMemory(e,t){let[r]=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));return r||void 0}async getAllAiMemories(e){return W.select().from(bi).where(se(bi.userId,e)).orderBy(bi.key)}async deleteAiMemory(e,t){await W.delete(bi).where(Sr(se(bi.userId,e),se(bi.key,t)))}async clearAllAiMemories(e){await W.delete(bi).where(se(bi.userId,e))}async createAiJob(e){let[t]=await W.insert(Oi).values(e).returning();return t}async getAiJob(e){let[t]=await W.select().from(Oi).where(se(Oi.id,e));return t||void 0}async getUserAiJobs(e){return W.select().from(Oi).where(se(Oi.userId,e)).orderBy(ut(Oi.createdAt))}async getSessionAiJobs(e){return W.select().from(Oi).where(se(Oi.sessionId,e)).orderBy(ut(Oi.createdAt))}async getQueuedAiJobs(){return W.select().from(Oi).where(se(Oi.status,"QUEUED")).orderBy(Oi.createdAt)}async updateAiJobStatus(e,t,r,s){let c={status:t};t==="RUNNING"&&(c.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(c.completedAt=new Date,c.progress=t==="DONE"?100:void 0),r&&(c.output=r),s&&(c.errorMessage=s);let[u]=await W.update(Oi).set(c).where(se(Oi.id,e)).returning();return u||void 0}async updateAiJobProgress(e,t){await W.update(Oi).set({progress:Math.min(100,Math.max(0,t))}).where(se(Oi.id,e))}async createMediaPipeline(e){let[t]=await W.insert(fs).values(e).returning();return t}async getMediaPipeline(e){let[t]=await W.select().from(fs).where(se(fs.id,e));return t||void 0}async getUserPipelines(e){return W.select().from(fs).where(se(fs.userId,e)).orderBy(ut(fs.createdAt))}async updatePipelineStatus(e,t,r){let s={status:t};t==="RUNNING"&&(s.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(s.completedAt=new Date),r&&(s.errorMessage=r),await W.update(fs).set(s).where(se(fs.id,e))}async updatePipelineProgress(e,t,r){await W.update(fs).set({completedSteps:t,progress:Math.min(100,Math.max(0,r))}).where(se(fs.id,e))}async updatePipelineFinalArtifact(e,t,r){await W.update(fs).set({finalArtifactUrl:t,finalArtifactType:r}).where(se(fs.id,e))}async createPipelineStep(e){let[t]=await W.insert(ks).values(e).returning();return t}async getPipelineSteps(e){return W.select().from(ks).where(se(ks.pipelineId,e)).orderBy(ks.stepOrder)}async updatePipelineStepStatus(e,t){let r={status:t};t==="RUNNING"&&(r.startedAt=new Date),(t==="DONE"||t==="FAILED"||t==="SKIPPED")&&(r.completedAt=new Date),await W.update(ks).set(r).where(se(ks.id,e))}async updatePipelineStepProgress(e,t){await W.update(ks).set({progress:Math.min(100,Math.max(0,t))}).where(se(ks.id,e))}async updatePipelineStepComplete(e,t,r){await W.update(ks).set({status:"DONE",progress:100,completedAt:new Date,outputData:t?JSON.stringify(t):null,artifactUrls:r?JSON.stringify(r):null}).where(se(ks.id,e))}async updatePipelineStepFailed(e,t){await W.update(ks).set({status:"FAILED",completedAt:new Date,errorMessage:t}).where(se(ks.id,e))}async createPipelineArtifact(e){let[t]=await W.insert(Nc).values(e).returning();return t}async getPipelineArtifacts(e){return W.select().from(Nc).where(se(Nc.pipelineId,e)).orderBy(Nc.createdAt)}async getFinalArtifact(e){let[t]=await W.select().from(Nc).where(Sr(se(Nc.pipelineId,e),se(Nc.isFinal,!0)));return t||void 0}async getClaimCasesByUserId(e){return W.select().from(Di).where(se(Di.veteranUserId,e)).orderBy(ut(Di.createdAt))}async getClaimCaseById(e){let[t]=await W.select().from(Di).where(se(Di.id,e));return t||void 0}async createClaimCase(e){let[t]=await W.insert(Di).values(e).returning();return t}async updateClaimCase(e,t){let[r]=await W.update(Di).set({...t,updatedAt:new Date}).where(se(Di.id,e)).returning();return r||void 0}async getClaimTasksByCaseId(e){return W.select().from(zo).where(se(zo.caseId,e)).orderBy(zo.sortOrder)}async getClaimTaskById(e){let[t]=await W.select().from(zo).where(se(zo.id,e));return t||void 0}async createClaimTask(e){let[t]=await W.insert(zo).values(e).returning();return t}async updateClaimTask(e,t){let[r]=await W.update(zo).set(t).where(se(zo.id,e)).returning();return r||void 0}async getCaseNotesByCaseId(e){return W.select().from(Pd).where(se(Pd.caseId,e)).orderBy(ut(Pd.createdAt))}async createCaseNote(e){let[t]=await W.insert(Pd).values(e).returning();return t}async getCaseDeadlinesByCaseId(e){return W.select().from(Pl).where(se(Pl.caseId,e)).orderBy(Pl.dueDate)}async createCaseDeadline(e){let[t]=await W.insert(Pl).values(e).returning();return t}async updateCaseDeadline(e,t){let[r]=await W.update(Pl).set(t).where(se(Pl.id,e)).returning();return r||void 0}async getClaimFilesByCaseId(e){return W.select().from(Il).where(se(Il.caseId,e)).orderBy(ut(Il.createdAt))}async createClaimFile(e){let[t]=await W.insert(Il).values(e).returning();return t}async getCaseSharesByCaseId(e){return W.select().from(es).where(se(es.caseId,e)).orderBy(ut(es.createdAt))}async getCaseShareByEmail(e,t){let[r]=await W.select().from(es).where(Sr(se(es.caseId,e),se(es.email,t)));return r}async getAllCaseShares(){return W.select().from(es).orderBy(ut(es.createdAt))}async upsertCaseShare(e){let t=await this.getCaseShareByEmail(e.caseId,e.email);if(t){let[s]=await W.update(es).set({role:e.role}).where(se(es.id,t.id)).returning();return s}let[r]=await W.insert(es).values(e).returning();return r}async getCaseShareById(e){let[t]=await W.select().from(es).where(se(es.id,e));return t}async deleteCaseShare(e){await W.delete(es).where(se(es.id,e))}async getEvidenceRequirements(e,t){return W.select().from(Go).where(Sr(se(Go.track,e),se(Go.purpose,t))).orderBy(Go.priority)}async getAllEvidenceRequirements(){return W.select().from(Go).orderBy(Go.track,Go.purpose,Go.priority)}async updateClaimFileEvidence(e,t){let[r]=await W.update(Il).set(t).where(se(Il.id,e)).returning();return r}async createVendorMagicLink(e){let[t]=await W.insert(Ao).values(e).returning();return t}async getVendorMagicLinkByToken(e){let[t]=await W.select().from(Ao).where(Sr(se(Ao.token,e),se(Ao.used,!1),cd(Ao.expiresAt,new Date)));return t}async markMagicLinkUsed(e){await W.update(Ao).set({used:!0}).where(se(Ao.id,e))}async createVendorSession(e){let[t]=await W.insert(Wo).values(e).returning();return t}async getVendorSessionByToken(e){let[t]=await W.select().from(Wo).where(Sr(se(Wo.sessionToken,e),cd(Wo.expiresAt,new Date)));return t}async deleteVendorSession(e){await W.delete(Wo).where(se(Wo.sessionToken,e))}async deleteExpiredMagicLinks(){await W.delete(Ao).where(ld(Ao.expiresAt,new Date))}async deleteExpiredVendorSessions(){await W.delete(Wo).where(ld(Wo.expiresAt,new Date))}async createAffiliateActivity(e){let[t]=await W.insert(Ho).values(e).returning();return t}async getAffiliateActivityByHash(e){let[t]=await W.select().from(Ho).where(se(Ho.hash,e));return t}async getAllAffiliateActivities(){return W.select().from(Ho).orderBy(ut(Ho.createdAt))}async getAffiliateActivitiesByActorEmail(e){return W.select().from(Ho).where(se(Ho.actorEmail,e)).orderBy(ut(Ho.createdAt))}async getNotificationSettings(e){let[t]=await W.select().from(Mu).where(se(Mu.userId,e));return t}async createNotificationSettings(e){let[t]=await W.insert(Mu).values(e).returning();return t}async updateNotificationSettings(e,t){let[r]=await W.update(Mu).set({...t,updatedAt:new Date}).where(se(Mu.userId,e)).returning();return r}async ensureNotificationSettings(e){let t=await this.getNotificationSettings(e);if(t)return t;let r={SITE_VISIT:!0,CONTRACT_VIEW:!0,CONTRACT_SIGNED:!0,INFO_REQUEST:!0,AFFILIATE_CLICK:!0,AFFILIATE_SIGNUP:!0},{encrypt:s}=await Promise.resolve().then(()=>(Iv(),Cv));return this.createNotificationSettings({userId:e,enabled:!0,emailsEnc:s(JSON.stringify([])),events:JSON.stringify(r),delivery:"instant"})}async createRepairLog(e){let[t]=await W.insert(Oc).values(e).returning();return t}async getRepairLogs(e=20){return W.select().from(Oc).orderBy(ut(Oc.createdAt)).limit(e)}async getRepairLogById(e){let[t]=await W.select().from(Oc).where(se(Oc.id,e));return t||void 0}async updateRepairLogStatus(e,t){let[r]=await W.update(Oc).set({status:t}).where(se(Oc.id,e)).returning();return r||void 0}async createCriticalIncident(e){let[t]=await W.insert(za).values(e).returning();return t}async getCriticalIncidentByIncidentId(e){let[t]=await W.select().from(za).where(se(za.incidentId,e));return t||void 0}async getCriticalIncidents(e,t=20){return e?W.select().from(za).where(se(za.status,e)).orderBy(ut(za.createdAt)).limit(t):W.select().from(za).orderBy(ut(za.createdAt)).limit(t)}async updateCriticalIncident(e,t){let[r]=await W.update(za).set(t).where(se(za.incidentId,e)).returning();return r||void 0}async createIncidentAuditLog(e){let[t]=await W.insert(kd).values(e).returning();return t}async getIncidentAuditLogs(e){return W.select().from(kd).where(se(kd.incidentId,e)).orderBy(kd.timestamp)}},q=new WR});var lX={};jr(lX,{LEGAL_DOCS:()=>nn,createLegalOverride:()=>KR,generateEvidenceBundle:()=>QR,getLegalStatus:()=>jd,hasSignedLegalDoc:()=>$_,hashDocument:()=>xm,healLegalStateOnLogin:()=>R5e,legalSystemHealthCheck:()=>wm,processExternalEsignCallback:()=>YR,requireLegalClearance:()=>F5e,runLegalTestBot:()=>XR,signLegalDocumentAtomic:()=>Pv,signLegalDocumentCore:()=>bm});function xm(n){return aX.default.createHash("sha256").update(n).digest("hex")}async function $_(n,e){let[t]=await W.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e.type),se(Kr.documentVersion,e.version)));return!!t}async function bm({userId:n,documentType:e,documentVersion:t,documentHash:r,ipAddress:s,userAgent:c}){return await W.transaction(async u=>{let[d]=await u.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e),se(Kr.documentVersion,t)));return d?{success:!0,alreadySigned:!0}:(await u.insert(Kr).values({userId:n,documentType:e,documentVersion:t,documentHash:r||null,ipAddress:s,userAgent:c}),{success:!0,alreadySigned:!1})})}async function Pv({userId:n,doc:e,docHash:t,req:r,provider:s=null,envelopeId:c=null}){let u=r.headers["x-forwarded-for"]?.toString().split(",")[0]||r.socket.remoteAddress||"unknown",d=r.headers["user-agent"]||"unknown";return bm({userId:n,documentType:e.type,documentVersion:e.version,documentHash:t,ipAddress:u,userAgent:d})}function F5e(){return async(n,e,t)=>{let r=n.session;if(!r?.userId||!r?.userRole)return e.status(401).json({message:"Unauthorized"});for(let s of Object.keys(nn)){let c=nn[s];if(!c.requiredFor.includes(r.userRole))continue;if(!await $_(r.userId,c))return e.status(403).json({required:c.type,redirectTo:c.path})}t()}}async function jd(n,e){let t={};for(let r of Object.keys(nn)){let s=nn[r];if(!s.requiredFor.includes(e)){t[r]=!0;continue}t[r]=await $_(n,s)}return t}async function R5e(n,e){for(let t of Object.keys(nn)){let r=nn[t];if(!r.requiredFor.includes(e))continue;if(!await $_(n,r))return{redirectTo:r.path}}return{ok:!0}}async function KR({adminId:n,userId:e,documentType:t,reason:r,req:s}){let c=s.headers["x-forwarded-for"]?.toString().split(",")[0]||s.socket.remoteAddress||"unknown",u=s.headers["user-agent"]||"unknown";await W.transaction(async d=>{await d.insert(Kr).values({userId:e,documentType:t,documentVersion:"ADMIN_OVERRIDE",documentHash:"OVERRIDE",ipAddress:c,userAgent:u}),await d.insert(x_).values({adminId:n,userId:e,documentType:t,reason:r})})}async function QR(n){let t=(await W.select().from(Kr).where(se(Kr.userId,n))).map(s=>`DOC: ${s.documentType}
                                                                                                                                                                                                                                                                                                                                                                                                                   ^
    at /app/dist/index.cjs:1:231
    at /app/dist/index.cjs:87:1374
    at /app/dist/index.cjs:1:231
    at Object.<anonymous> (/app/dist/index.cjs:599:517)
    at Module.load (node:internal/modules/cjs/loader:1441:32)
    at Function._load (node:internal/modules/cjs/loader:1263:12)
    at TracingChannel.traceSync (node:diagnostics_channel:328:14)
Node.js v22.22.0
npm warn config production Use `--omit=dev` instead.
> rest-express@1.0.0 start
`+t)}function Bd(n,e,t,r,s,c){if(n.listenerCount("wsClientError")){let u=new Error(s);Error.captureStackTrace(u,Bd),n.emit("wsClientError",u,t,e)}else Ev(t,r,s,c)}});var S5e,E5e,T5e,tX,C5e,rX,nX=xe(()=>{S5e=Xt(zY(),1),E5e=Xt(LR(),1),T5e=Xt(jR(),1),tX=Xt(U_(),1),C5e=Xt(eX(),1),rX=tX.default});var I5e,W,Ks=xe(()=>{"use strict";T_();kQ();nX();Li();qu.webSocketConstructor=rX;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");I5e=new Fl({connectionString:process.env.DATABASE_URL}),W=I_({client:I5e,schema:b_})});var Cv={};jr(Cv,{decrypt:()=>k5e,encrypt:()=>P5e});function P5e(n){let e=Tv.default.randomBytes(16),t=Tv.default.createCipheriv("aes-256-gcm",sX,e),r=Buffer.concat([t.update(n,"utf8"),t.final()]),s=t.getAuthTag();return Buffer.concat([e,s,r]).toString("base64")}function k5e(n){let e=Buffer.from(n,"base64"),t=e.subarray(0,16),r=e.subarray(16,32),s=e.subarray(32),c=Tv.default.createDecipheriv("aes-256-gcm",sX,t);return c.setAuthTag(r),c.update(s).toString("utf8")+c.final("utf8")}var Tv,iX,sX,Iv=xe(()=>{"use strict";Tv=Xt(require("crypto"),1),iX=process.env.ENCRYPTION_KEY;if(!iX)throw new Error("ENCRYPTION_KEY environment variable is required in production");sX=Tv.default.createHash("sha256").update(iX||"dev-only-key-not-for-production-use").digest()});var WR,q,Jo=xe(()=>{"use strict";Li();Ks();Ji();WR=class{async getUser(e){let[t]=await W.select().from(St).where(se(St.id,e));return t||void 0}async getUserByEmail(e){let[t]=await W.select().from(St).where(se(St.email,e));return t||void 0}async getUserByReferralCode(e){let[t]=await W.select().from(St).where(se(St.referralCode,e));return t||void 0}async createUser(e){let[t]=await W.insert(St).values(e).returning();return t}async getAllAffiliates(){return W.select().from(St).where(se(St.role,"affiliate")).orderBy(ut(St.createdAt))}async updateUserPassword(e,t){let[r]=await W.update(St).set({passwordHash:t}).where(se(St.id,e)).returning();return r||void 0}async updateUserReferralCode(e,t){let[r]=await W.update(St).set({referralCode:t}).where(se(St.id,e)).returning();return r||void 0}async deleteUser(e){await W.delete(St).where(se(St.id,e))}async createAffiliateApplication(e){let[t]=await W.insert(Ca).values(e).returning();return t}async getAffiliateApplication(e){let[t]=await W.select().from(Ca).where(se(Ca.id,e));return t||void 0}async getAllAffiliateApplications(){return W.select().from(Ca).orderBy(ut(Ca.createdAt))}async getAffiliateApplicationsByAssignee(e){return W.select().from(Ca).where(se(Ca.assignedTo,e)).orderBy(ut(Ca.createdAt))}async updateAffiliateApplication(e,t){let[r]=await W.update(Ca).set({...t,updatedAt:new Date}).where(se(Ca.id,e)).returning();return r||void 0}async createHelpRequest(e){let[t]=await W.insert(Ia).values(e).returning();return t}async getHelpRequest(e){let[t]=await W.select().from(Ia).where(se(Ia.id,e));return t||void 0}async getAllHelpRequests(){return W.select().from(Ia).orderBy(ut(Ia.createdAt))}async getHelpRequestsByAssignee(e){return W.select().from(Ia).where(se(Ia.assignedTo,e)).orderBy(ut(Ia.createdAt))}async updateHelpRequest(e,t){let[r]=await W.update(Ia).set({...t,updatedAt:new Date}).where(se(Ia.id,e)).returning();return r||void 0}async createStartupGrant(e){let[t]=await W.insert(Pa).values(e).returning();return t}async getStartupGrant(e){let[t]=await W.select().from(Pa).where(se(Pa.id,e));return t||void 0}async getAllStartupGrants(){return W.select().from(Pa).orderBy(ut(Pa.createdAt))}async getStartupGrantsByAssignee(e){return W.select().from(Pa).where(se(Pa.assignedTo,e)).orderBy(ut(Pa.createdAt))}async updateStartupGrant(e,t){let[r]=await W.update(Pa).set({...t,updatedAt:new Date}).where(se(Pa.id,e)).returning();return r||void 0}async createFurnitureAssistance(e){let[t]=await W.insert(ka).values(e).returning();return t}async getFurnitureAssistance(e){let[t]=await W.select().from(ka).where(se(ka.id,e));return t||void 0}async getAllFurnitureAssistance(){return W.select().from(ka).orderBy(ut(ka.createdAt))}async getFurnitureAssistanceByAssignee(e){return W.select().from(ka).where(se(ka.assignedTo,e)).orderBy(ut(ka.createdAt))}async updateFurnitureAssistance(e,t){let[r]=await W.update(ka).set({...t,updatedAt:new Date}).where(se(ka.id,e)).returning();return r||void 0}async createInvestorSubmission(e){let[t]=await W.insert(Fa).values(e).returning();return t}async getInvestorSubmission(e){let[t]=await W.select().from(Fa).where(se(Fa.id,e));return t||void 0}async getAllInvestorSubmissions(){return W.select().from(Fa).orderBy(ut(Fa.createdAt))}async getInvestorSubmissionsByAssignee(e){return W.select().from(Fa).where(se(Fa.assignedTo,e)).orderBy(ut(Fa.createdAt))}async updateInvestorSubmission(e,t){let[r]=await W.update(Fa).set({...t,updatedAt:new Date}).where(se(Fa.id,e)).returning();return r||void 0}async createPrivateDoctorRequest(e){let[t]=await W.insert(Ra).values(e).returning();return t}async getPrivateDoctorRequest(e){let[t]=await W.select().from(Ra).where(se(Ra.id,e));return t||void 0}async getAllPrivateDoctorRequests(){return W.select().from(Ra).orderBy(ut(Ra.createdAt))}async getPrivateDoctorRequestsByAssignee(e){return W.select().from(Ra).where(se(Ra.assignedTo,e)).orderBy(ut(Ra.createdAt))}async updatePrivateDoctorRequest(e,t){let[r]=await W.update(Ra).set({...t,updatedAt:new Date}).where(se(Ra.id,e)).returning();return r||void 0}async createWebsiteApplication(e){let[t]=await W.insert(Na).values(e).returning();return t}async getWebsiteApplication(e){let[t]=await W.select().from(Na).where(se(Na.id,e));return t||void 0}async getAllWebsiteApplications(){return W.select().from(Na).orderBy(ut(Na.createdAt))}async getWebsiteApplicationsByAssignee(e){return W.select().from(Na).where(se(Na.assignedTo,e)).orderBy(ut(Na.createdAt))}async updateWebsiteApplication(e,t){let[r]=await W.update(Na).set({...t,updatedAt:new Date}).where(se(Na.id,e)).returning();return r||void 0}async createGeneralContact(e){let[t]=await W.insert(Oa).values(e).returning();return t}async getGeneralContact(e){let[t]=await W.select().from(Oa).where(se(Oa.id,e));return t||void 0}async getAllGeneralContacts(){return W.select().from(Oa).orderBy(ut(Oa.createdAt))}async getGeneralContactsByAssignee(e){return W.select().from(Oa).where(se(Oa.assignedTo,e)).orderBy(ut(Oa.createdAt))}async updateGeneralContact(e,t){let[r]=await W.update(Oa).set({...t,updatedAt:new Date}).where(se(Oa.id,e)).returning();return r||void 0}async createVltIntake(e){let t=e.issue==="credits"?"CPA":e.issue==="resolution"?"Tax Attorney":"General";console.log("NEW LEAD:",{...e,routedTo:t,timestamp:new Date().toISOString()});let[r]=await W.insert(Zi).values({...e,routedTo:t}).returning();return r}async getVltIntake(e){let[t]=await W.select().from(Zi).where(se(Zi.id,e));return t||void 0}async getAllVltIntakes(){return W.select().from(Zi).orderBy(ut(Zi.createdAt))}async updateVltIntake(e,t){let[r]=await W.update(Zi).set(t).where(se(Zi.id,e)).returning();return r||void 0}async getVltIntakesByAffiliate(e){return W.select().from(Zi).where(od(se(Zi.referredByL1,e),se(Zi.referredByL2,e),se(Zi.referredByL3,e),se(Zi.referredByL4,e),se(Zi.referredByL5,e),se(Zi.referredByL6,e))).orderBy(ut(Zi.createdAt))}async createVltAffiliate(e){let[t]=await W.insert(Pr).values(e).returning();return t}async getVltAffiliate(e){let[t]=await W.select().from(Pr).where(se(Pr.id,e));return t||void 0}async getVltAffiliateByEmail(e){let[t]=await W.select().from(Pr).where(se(Pr.email,e));return t||void 0}async getVltAffiliateByReferralCode(e){let[t]=await W.select().from(Pr).where(se(Pr.referralCode,e));return t||void 0}async getAllVltAffiliates(){return W.select().from(Pr).orderBy(ut(Pr.createdAt))}async updateVltAffiliate(e,t){let[r]=await W.update(Pr).set({...t,updatedAt:new Date}).where(se(Pr.id,e)).returning();return r||void 0}async deleteVltAffiliate(e){await W.delete(Pr).where(se(Pr.id,e))}async getVltAffiliatesByRole(e){return W.select().from(Pr).where(se(Pr.role,e)).orderBy(ut(Pr.createdAt))}async getVltAffiliateDownline(e){return W.select().from(Pr).where(od(se(Pr.level1Id,e),se(Pr.level2Id,e),se(Pr.level3Id,e),se(Pr.level4Id,e),se(Pr.level5Id,e),se(Pr.level6Id,e),se(Pr.level7Id,e))).orderBy(ut(Pr.createdAt))}async createOpportunity(e){let[t]=await W.insert(da).values(e).returning();return t}async getOpportunity(e){let[t]=await W.select().from(da).where(se(da.id,e));return t||void 0}async getAllOpportunities(){return W.select().from(da).orderBy(ut(da.createdAt))}async getOpportunitiesByCategory(e){return W.select().from(da).where(se(da.category,e)).orderBy(ut(da.createdAt))}async updateOpportunity(e,t){let[r]=await W.update(da).set(t).where(se(da.id,e)).returning();return r||void 0}async createSale(e){let[t]=await W.insert(qn).values(e).returning();return t}async getSale(e){let[t]=await W.select().from(qn).where(se(qn.id,e));return t||void 0}async getAllSales(){return W.select().from(qn).orderBy(ut(qn.createdAt))}async getSalesByAffiliate(e){return W.select().from(qn).where(se(qn.affiliateId,e)).orderBy(ut(qn.createdAt))}async getSalesByDownline(e){return W.select().from(qn).where(od(se(qn.referredByL1,e),se(qn.referredByL2,e),se(qn.referredByL3,e),se(qn.referredByL4,e),se(qn.referredByL5,e),se(qn.referredByL6,e),se(qn.referredByL7,e))).orderBy(ut(qn.createdAt))}async updateSale(e,t){let[r]=await W.update(qn).set({...t,updatedAt:new Date}).where(se(qn.id,e)).returning();return r||void 0}async createCommission(e){let[t]=await W.insert(pa).values(e).returning();return t}async getCommission(e){let[t]=await W.select().from(pa).where(se(pa.id,e));return t||void 0}async getCommissionsByAffiliate(e){return W.select().from(pa).where(se(pa.affiliateId,e)).orderBy(ut(pa.createdAt))}async getCommissionsBySale(e){return W.select().from(pa).where(se(pa.saleId,e)).orderBy(ut(pa.createdAt))}async updateCommission(e,t){let[r]=await W.update(pa).set(t).where(se(pa.id,e)).returning();return r||void 0}async createVeteranIntake(e){let[t]=await W.insert(Da).values(e).returning();return t}async getVeteranIntake(e){let[t]=await W.select().from(Da).where(se(Da.id,e));return t||void 0}async getAllVeteranIntakes(){return W.select().from(Da).orderBy(ut(Da.createdAt))}async getVeteranIntakesByProgram(e){return W.select().from(Da).where(se(Da.programType,e)).orderBy(ut(Da.createdAt))}async updateVeteranIntake(e,t){let[r]=await W.update(Da).set({...t,updatedAt:new Date}).where(se(Da.id,e)).returning();return r||void 0}async createBusinessIntake(e){let[t]=await W.insert(La).values(e).returning();return t}async getBusinessIntake(e){let[t]=await W.select().from(La).where(se(La.id,e));return t||void 0}async getAllBusinessIntakes(){return W.select().from(La).orderBy(ut(La.createdAt))}async getBusinessIntakesByService(e){return W.select().from(La).where(se(La.serviceType,e)).orderBy(ut(La.createdAt))}async updateBusinessIntake(e,t){let[r]=await W.update(La).set({...t,updatedAt:new Date}).where(se(La.id,e)).returning();return r||void 0}async createContractTemplate(e){let[t]=await W.insert(ha).values(e).returning();return t}async getContractTemplate(e){let[t]=await W.select().from(ha).where(se(ha.id,e));return t||void 0}async getAllContractTemplates(){return W.select().from(ha).orderBy(ut(ha.createdAt))}async getActiveContractTemplates(){return W.select().from(ha).where(se(ha.isActive,"true")).orderBy(ut(ha.createdAt))}async updateContractTemplate(e,t){let[r]=await W.update(ha).set({...t,updatedAt:new Date}).where(se(ha.id,e)).returning();return r||void 0}async createSignedAgreement(e){let[t]=await W.insert(ki).values(e).returning();return t}async getSignedAgreement(e){let[t]=await W.select().from(ki).where(se(ki.id,e));return t||void 0}async getAllSignedAgreements(){return W.select().from(ki).orderBy(ut(ki.signedAt))}async getSignedAgreementsByAffiliate(e){return W.select().from(ki).where(se(ki.affiliateId,e)).orderBy(ut(ki.signedAt))}async hasAffiliateSignedContract(e,t){let[r]=await W.select().from(ki).where(Sr(se(ki.affiliateId,e),se(ki.contractTemplateId,t),se(ki.status,"signed")));return!!r}async updateSignedAgreement(e,t){let[r]=await W.update(ki).set(t).where(se(ki.id,e)).returning();return r||void 0}async createCommissionConfig(e){let[t]=await W.insert(El).values(e).returning();return t}async getActiveCommissionConfig(){let[e]=await W.select().from(El).where(se(El.isActive,"true")).orderBy(ut(El.createdAt)).limit(1);return e||void 0}async updateCommissionConfig(e,t){let[r]=await W.update(El).set({...t,updatedAt:new Date}).where(se(El.id,e)).returning();return r||void 0}async createAffiliateNda(e){let[t]=await W.insert(Fi).values(e).returning();return t}async getAffiliateNdaByUserId(e){let[t]=await W.select().from(Fi).where(se(Fi.userId,e));return t||void 0}async getAffiliateNdaById(e){let[t]=await W.select().from(Fi).where(se(Fi.id,e));return t||void 0}async hasAffiliateSignedNda(e){return!!await this.getAffiliateNdaByUserId(e)}async getAllAffiliateNdas(){return W.select().from(Fi).orderBy(ut(Fi.signedAt))}async signNdaAtomic(e,t,r){return await W.transaction(async s=>{let[c]=await s.select().from(Fi).where(se(Fi.userId,e));if(c)return{nda:c,alreadySigned:!0};await s.update(St).set({referralCode:t}).where(se(St.id,e));let[u]=await s.insert(Fi).values(r).returning();return{nda:u,alreadySigned:!1}})}async createBusinessLead(e){let[t]=await W.insert(Is).values(e).returning();return t}async getBusinessLead(e){let[t]=await W.select().from(Is).where(se(Is.id,e));return t||void 0}async getAllBusinessLeads(){return W.select().from(Is).orderBy(ut(Is.createdAt))}async getBusinessLeadsByType(e){return W.select().from(Is).where(se(Is.leadType,e)).orderBy(ut(Is.createdAt))}async getBusinessLeadsByReferrer(e){return W.select().from(Is).where(se(Is.referredBy,e)).orderBy(ut(Is.createdAt))}async updateBusinessLead(e,t){let[r]=await W.update(Is).set({...t,updatedAt:new Date}).where(se(Is.id,e)).returning();return r||void 0}async createIpReferralTracking(e){let[t]=await W.insert(Ma).values(e).returning();return t}async getActiveIpReferral(e){let t=new Date,[r]=await W.select().from(Ma).where(Sr(se(Ma.ipAddress,e),cd(Ma.expiresAt,t))).orderBy(ut(Ma.createdAt)).limit(1);return r||void 0}async getIpReferralsByAffiliate(e){return W.select().from(Ma).where(se(Ma.affiliateId,e)).orderBy(ut(Ma.createdAt))}async getAllIpReferrals(){return W.select().from(Ma).orderBy(ut(Ma.createdAt))}async createAffiliateW9(e){let[t]=await W.insert(Id).values(e).returning();return t}async getAffiliateW9ByUserId(e){let[t]=await W.select().from(Id).where(se(Id.userId,e));return t||void 0}async hasAffiliateSubmittedW9(e){return!!await this.getAffiliateW9ByUserId(e)}async getAllAffiliateW9s(){return await W.select().from(Id)}async createFinopsReferral(e){let[t]=await W.insert(Ps).values(e).returning();return t}async getFinopsReferral(e){let[t]=await W.select().from(Ps).where(se(Ps.id,e));return t||void 0}async getAllFinopsReferrals(){return W.select().from(Ps).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByAffiliate(e){return W.select().from(Ps).where(se(Ps.affiliateId,e)).orderBy(ut(Ps.createdAt))}async getFinopsReferralsByPartnerType(e){return W.select().from(Ps).where(se(Ps.partnerType,e)).orderBy(ut(Ps.createdAt))}async updateFinopsReferral(e,t){let[r]=await W.update(Ps).set(t).where(se(Ps.id,e)).returning();return r||void 0}async createDisabilityReferral(e){let[t]=await W.insert(ma).values(e).returning();return t}async getDisabilityReferral(e){let[t]=await W.select().from(ma).where(se(ma.id,e));return t||void 0}async getAllDisabilityReferrals(){return W.select().from(ma).orderBy(ut(ma.createdAt))}async getDisabilityReferralsByAffiliate(e){return W.select().from(ma).where(se(ma.affiliateId,e)).orderBy(ut(ma.createdAt))}async updateDisabilityReferral(e,t){let[r]=await W.update(ma).set({...t,updatedAt:new Date}).where(se(ma.id,e)).returning();return r||void 0}async getDisabilityReferralStats(){let e=await W.select().from(ma),t={},r={};for(let s of e)t[s.claimType]=(t[s.claimType]||0)+1,r[s.status]=(r[s.status]||0)+1;return{total:e.length,byType:t,byStatus:r}}async createJobPlacementIntake(e){let[t]=await W.insert(Ba).values(e).returning();return t}async getJobPlacementIntake(e){let[t]=await W.select().from(Ba).where(se(Ba.id,e));return t||void 0}async getAllJobPlacementIntakes(){return W.select().from(Ba).orderBy(ut(Ba.createdAt))}async getJobPlacementIntakesByAffiliate(e){return W.select().from(Ba).where(se(Ba.affiliateId,e)).orderBy(ut(Ba.createdAt))}async updateJobPlacementIntake(e,t){let[r]=await W.update(Ba).set({...t,updatedAt:new Date}).where(se(Ba.id,e)).returning();return r||void 0}async createVetProfessionalIntake(e){let[t]=await W.insert(ja).values(e).returning();return t}async getVetProfessionalIntake(e){let[t]=await W.select().from(ja).where(se(ja.id,e));return t||void 0}async getAllVetProfessionalIntakes(){return W.select().from(ja).orderBy(ut(ja.createdAt))}async getVetProfessionalIntakesByAffiliate(e){return W.select().from(ja).where(se(ja.affiliateId,e)).orderBy(ut(ja.createdAt))}async updateVetProfessionalIntake(e,t){let[r]=await W.update(ja).set({...t,updatedAt:new Date}).where(se(ja.id,e)).returning();return r||void 0}async createHealthcareIntake(e){let[t]=await W.insert(Ou).values(e).returning();return t}async getAllHealthcareIntakes(){return W.select().from(Ou).orderBy(ut(Ou.createdAt))}async updateHealthcareIntake(e,t){let[r]=await W.update(Ou).set({...t,updatedAt:new Date}).where(se(Ou.id,e)).returning();return r||void 0}async createScheduleASignature(e){let[t]=await W.insert(Du).values(e).returning();return t}async getScheduleASignatureByUserId(e){let[t]=await W.select().from(Du).where(se(Du.userId,e));return t||void 0}async getAllScheduleASignatures(){return W.select().from(Du).orderBy(ut(Du.signedAt))}async createInsuranceIntake(e){let[t]=await W.insert(Lu).values(e).returning();return t}async getAllInsuranceIntakes(){return W.select().from(Lu).orderBy(ut(Lu.createdAt))}async updateInsuranceIntake(e,t){let[r]=await W.update(Lu).set({...t,updatedAt:new Date}).where(se(Lu.id,e)).returning();return r||void 0}async createMedicalSalesIntake(e){let[t]=await W.insert(qo).values(e).returning();return t}async getAllMedicalSalesIntakes(){return W.select().from(qo).orderBy(ut(qo.createdAt))}async getMedicalSalesIntakesByAffiliate(e){return W.select().from(qo).where(se(qo.assignedTo,e)).orderBy(ut(qo.createdAt))}async updateMedicalSalesIntake(e,t){let[r]=await W.update(qo).set({...t,updatedAt:new Date}).where(se(qo.id,e)).returning();return r||void 0}async createBusinessDevIntake(e){let[t]=await W.insert($o).values(e).returning();return t}async getAllBusinessDevIntakes(){return W.select().from($o).orderBy(ut($o.createdAt))}async getBusinessDevIntakesByAffiliate(e){return W.select().from($o).where(se($o.assignedTo,e)).orderBy(ut($o.createdAt))}async updateBusinessDevIntake(e,t){let[r]=await W.update($o).set({...t,updatedAt:new Date}).where(se($o.id,e)).returning();return r||void 0}async getUserById(e){return this.getUser(e)}async createCsuContractTemplate(e){let[t]=await W.insert($r).values(e).returning();return t}async getCsuContractTemplate(e){let[t]=await W.select().from($r).where(se($r.id,e));return t||void 0}async getAllCsuContractTemplates(){return W.select().from($r).orderBy(ut($r.createdAt))}async getActiveCsuContractTemplates(){return W.select().from($r).where(se($r.isActive,!0)).orderBy(ut($r.createdAt))}async updateCsuContractTemplate(e,t){let[r]=await W.update($r).set({...t,updatedAt:new Date}).where(se($r.id,e)).returning();return r||void 0}async getActiveTemplatesByPortal(e){return W.select().from($r).where(Sr(se($r.isActive,!0),od(se($r.portal,e),ml($r.portal)))).orderBy(ut($r.createdAt))}async deleteCsuContractTemplate(e){await W.delete($r).where(se($r.id,e))}async createCsuContractTemplateField(e){let[t]=await W.insert(Ua).values(e).returning();return t}async getCsuContractTemplateFields(e){return W.select().from(Ua).where(se(Ua.templateId,e)).orderBy(Ua.order)}async updateCsuContractTemplateField(e,t){let[r]=await W.update(Ua).set(t).where(se(Ua.id,e)).returning();return r||void 0}async deleteCsuContractTemplateField(e){await W.delete(Ua).where(se(Ua.id,e))}async deleteAllCsuContractTemplateFields(e){await W.delete(Ua).where(se(Ua.templateId,e))}async createCsuContractSend(e){let[t]=await W.insert(ga).values(e).returning();return t}async getCsuContractSend(e){let[t]=await W.select().from(ga).where(se(ga.id,e));return t||void 0}async getCsuContractSendByToken(e){let[t]=await W.select().from(ga).where(se(ga.signToken,e));return t||void 0}async getAllCsuContractSends(){return W.select().from(ga).orderBy(ut(ga.createdAt))}async updateCsuContractSend(e,t){let[r]=await W.update(ga).set(t).where(se(ga.id,e)).returning();return r||void 0}async createCsuSignedAgreement(e){let[t]=await W.insert(Cn).values(e).returning();return t}async getCsuSignedAgreement(e){let[t]=await W.select().from(Cn).where(se(Cn.id,e));return t||void 0}async getAllCsuSignedAgreements(){return await W.select({id:Cn.id,contractSendId:Cn.contractSendId,templateId:Cn.templateId,signerName:Cn.signerName,signerEmail:Cn.signerEmail,signerPhone:Cn.signerPhone,address:Cn.address,initials:Cn.initials,effectiveDate:Cn.effectiveDate,signatureData:Cn.signatureData,signedIpAddress:Cn.signedIpAddress,agreedToTerms:Cn.agreedToTerms,signedAt:Cn.signedAt,createdAt:Cn.createdAt,templateName:$r.name}).from(Cn).leftJoin($r,se(Cn.templateId,$r.id)).orderBy(ut(Cn.createdAt))}async createPortalActivity(e){let[t]=await W.insert(Cl).values(e).returning();return t}async getPortalActivity(e,t){return W.select().from(Cl).where(se(Cl.portal,e)).orderBy(ut(Cl.createdAt)).limit(t)}async getPortalStats(e){let t=await W.select().from(Cl).where(se(Cl.portal,e)),r=new Date;r.setHours(0,0,0,0);let s=t.filter(v=>new Date(v.createdAt)>=r),c=t.filter(v=>v.eventType==="page_view"),u=new Set(c.map(v=>v.ipAddress).filter(Boolean)),d=t.filter(v=>v.eventType==="contract_sent").length,m=t.filter(v=>v.eventType==="contract_signed").length;return{totalVisits:c.length,uniqueIps:u.size,contractsSent:d,contractsSigned:m,todayVisits:s.filter(v=>v.eventType==="page_view").length}}async createPasswordResetToken(e){let[t]=await W.insert(qa).values(e).returning();return t}async getValidPasswordResetToken(e){let t=new Date,[r]=await W.select().from(qa).where(Sr(se(qa.tokenHash,e),ml(qa.usedAt),cd(qa.expiresAt,t)));return r||void 0}async invalidatePasswordResetToken(e){await W.update(qa).set({usedAt:new Date}).where(se(qa.id,e))}async invalidateAllUserPasswordResetTokens(e){await W.update(qa).set({usedAt:new Date}).where(Sr(se(qa.userId,e),ml(qa.usedAt)))}async createPartnerSharingLog(e){let[t]=await W.insert(Fc).values(e).returning();return t}async getPartnerSharingLogsBySubmission(e,t){return await W.select().from(Fc).where(Sr(se(Fc.submissionType,e),se(Fc.submissionId,t))).orderBy(ut(Fc.sharedAt))}async getAllPartnerSharingLogs(){return await W.select().from(Fc).orderBy(ut(Fc.sharedAt))}async createConsentRecord(e){let[t]=await W.insert($a).values(e).returning();return t}async getConsentRecordsBySubmission(e,t){return await W.select().from($a).where(Sr(se($a.submissionType,e),se($a.submissionId,t))).orderBy(ut($a.submittedAt))}async getConsentRecordByEmail(e){return await W.select().from($a).where(se($a.email,e)).orderBy(ut($a.submittedAt))}async getAllConsentRecords(){return await W.select().from($a).orderBy(ut($a.submittedAt))}async createAffiliatedPartner(e){let[t]=await W.insert(Ha).values(e).returning();return t}async getActiveAffiliatedPartners(){return await W.select().from(Ha).where(se(Ha.isActive,!0)).orderBy(Ha.category,Ha.displayName)}async getAllAffiliatedPartners(){return await W.select().from(Ha).orderBy(Ha.category,Ha.displayName)}async updateAffiliatedPartner(e,t){let[r]=await W.update(Ha).set(t).where(se(Ha.id,e)).returning();return r||void 0}async createRangerTabApplication(e){let[t]=await W.insert(Bu).values(e).returning();return t}async getAllRangerTabApplications(){return W.select().from(Bu).orderBy(ut(Bu.createdAt))}async updateRangerTabApplication(e,t){let[r]=await W.update(Bu).set({...t,updatedAt:new Date}).where(se(Bu.id,e)).returning();return r||void 0}async createCsuEnvelope(e){let[t]=await W.insert(wo).values(e).returning();return t}async getCsuEnvelope(e){let[t]=await W.select().from(wo).where(se(wo.id,e));return t||void 0}async getAllCsuEnvelopes(){return W.select().from(wo).orderBy(ut(wo.createdAt))}async updateCsuEnvelope(e,t){let[r]=await W.update(wo).set({...t,updatedAt:new Date}).where(se(wo.id,e)).returning();return r||void 0}async createCsuEnvelopeRecipient(e){let[t]=await W.insert(ya).values(e).returning();return t}async getCsuEnvelopeRecipient(e){let[t]=await W.select().from(ya).where(se(ya.id,e));return t||void 0}async getCsuEnvelopeRecipientByToken(e){let[t]=await W.select().from(ya).where(se(ya.signToken,e));return t||void 0}async getEnvelopeRecipients(e){return W.select().from(ya).where(se(ya.envelopeId,e)).orderBy(ya.routingOrder)}async updateCsuEnvelopeRecipient(e,t){let[r]=await W.update(ya).set(t).where(se(ya.id,e)).returning();return r||void 0}async createCsuAuditTrail(e){let[t]=await W.insert(kc).values(e).returning();return t}async getAuditTrailForEnvelope(e){return W.select().from(kc).where(se(kc.envelopeId,e)).orderBy(ut(kc.createdAt))}async getAuditTrailForContractSend(e){return W.select().from(kc).where(se(kc.contractSendId,e)).orderBy(ut(kc.createdAt))}async createHipaaAuditLog(e){let[t]=await W.insert(Ri).values(e).returning();return t}async getHipaaAuditLogs(e=1e3){return W.select().from(Ri).orderBy(ut(Ri.timestamp)).limit(e)}async getHipaaAuditLogsByUser(e){return W.select().from(Ri).where(se(Ri.userId,e)).orderBy(ut(Ri.timestamp))}async getHipaaAuditLogsByResource(e,t){return t?W.select().from(Ri).where(Sr(se(Ri.resourceType,e),se(Ri.resourceId,t))).orderBy(ut(Ri.timestamp)):W.select().from(Ri).where(se(Ri.resourceType,e)).orderBy(ut(Ri.timestamp))}async getHipaaPhiAccessLogs(){return W.select().from(Ri).where(se(Ri.phiAccessed,!0)).orderBy(ut(Ri.timestamp))}async createHipaaTrainingRecord(e){let[t]=await W.insert(Va).values(e).returning();return t}async getHipaaTrainingRecordsByUser(e){return W.select().from(Va).where(se(Va.userId,e)).orderBy(ut(Va.completedAt))}async getAllHipaaTrainingRecords(){return W.select().from(Va).orderBy(ut(Va.completedAt))}async getExpiredTrainingRecords(){let e=new Date;return W.select().from(Va).where(Sr(se(Va.passed,!0),ld(Va.expiresAt,e))).orderBy(ut(Va.expiresAt))}async createBusinessAssociateAgreement(e){let[t]=await W.insert(Rc).values(e).returning();return t}async getBusinessAssociateAgreement(e){let[t]=await W.select().from(Rc).where(se(Rc.id,e));return t||void 0}async getAllBusinessAssociateAgreements(){return W.select().from(Rc).orderBy(ut(Rc.updatedAt))}async updateBusinessAssociateAgreement(e,t){let[r]=await W.update(Rc).set({...t,updatedAt:new Date}).where(se(Rc.id,e)).returning();return r||void 0}async createUserMfaConfig(e){let[t]=await W.insert(ju).values(e).returning();return t}async getUserMfaConfig(e){let[t]=await W.select().from(ju).where(se(ju.userId,e));return t||void 0}async updateUserMfaConfig(e,t){let[r]=await W.update(ju).set({...t,updatedAt:new Date}).where(se(ju.userId,e)).returning();return r||void 0}async getAuthRateLimit(e,t,r){let[s]=await W.select().from(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)));return s||void 0}async createOrUpdateAuthRateLimit(e){let t=await this.getAuthRateLimit(e.identifier,e.identifierType,e.attemptType);if(t){let[s]=await W.update(va).set({failedAttempts:e.failedAttempts,lastAttemptAt:new Date,lockedUntil:e.lockedUntil,updatedAt:new Date}).where(se(va.id,t.id)).returning();return s}let[r]=await W.insert(va).values({...e,lastAttemptAt:new Date}).returning();return r}async resetAuthRateLimit(e,t,r){await W.delete(va).where(Sr(se(va.identifier,e),se(va.identifierType,t),se(va.attemptType,r)))}async createAiGeneration(e){let[t]=await W.insert(ai).values(e).returning();return t}async getAiGeneration(e){let[t]=await W.select().from(ai).where(se(ai.id,e));return t||void 0}async getAiGenerationsByUser(e){return W.select().from(ai).where(se(ai.userId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsBySession(e){return W.select().from(ai).where(se(ai.sessionId,e)).orderBy(ut(ai.createdAt))}async getAiGenerationsByStatus(e){return W.select().from(ai).where(se(ai.status,e)).orderBy(ai.createdAt)}async updateAiGeneration(e,t){let[r]=await W.update(ai).set({...t,updatedAt:new Date}).where(se(ai.id,e)).returning();return r||void 0}async deleteAiGeneration(e){await W.delete(ai).where(se(ai.id,e))}async getAllAiGenerations(e=100){return W.select().from(ai).orderBy(ut(ai.createdAt)).limit(e)}async createAiTemplate(e){let[t]=await W.insert($n).values(e).returning();return t}async getAiTemplate(e){let[t]=await W.select().from($n).where(se($n.id,e));return t||void 0}async getAllAiTemplates(){return W.select().from($n).orderBy(ut($n.usageCount))}async getActiveAiTemplates(){return W.select().from($n).where(se($n.isActive,!0)).orderBy(ut($n.usageCount))}async getAiTemplatesByCategory(e){return W.select().from($n).where(Sr(se($n.category,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async getAiTemplatesByType(e){return W.select().from($n).where(Sr(se($n.type,e),se($n.isActive,!0))).orderBy(ut($n.usageCount))}async updateAiTemplate(e,t){let[r]=await W.update($n).set({...t,updatedAt:new Date}).where(se($n.id,e)).returning();return r||void 0}async incrementTemplateUsage(e){let t=await this.getAiTemplate(e);t&&await W.update($n).set({usageCount:(t.usageCount||0)+1,updatedAt:new Date}).where(se($n.id,e))}async saveOperatorAiMessage(e){let[t]=await W.insert(Ni).values(e).returning();return t}async getSessionMemory(e){return W.select().from(Ni).where(se(Ni.sessionId,e)).orderBy(Ni.messageOrder)}async getUserPersistentMemory(e){return W.select().from(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent"))).orderBy(Ni.messageOrder)}async clearSessionMemory(e){await W.delete(Ni).where(se(Ni.sessionId,e))}async clearUserPersistentMemory(e){await W.delete(Ni).where(Sr(se(Ni.userId,e),se(Ni.memoryMode,"persistent")))}async cleanupExpiredSessions(){await W.delete(Ni).where(Sr(se(Ni.memoryMode,"session"),ld(Ni.expiresAt,new Date)))}async getOrCreateAiUser(e,t){if(e){let s=await W.select().from(In).where(se(In.email,e));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}if(t){let s=await W.select().from(In).where(se(In.anonDeviceId,t));if(s[0])return await W.update(In).set({lastActiveAt:new Date}).where(se(In.id,s[0].id)),s[0]}let[r]=await W.insert(In).values({email:e||null,anonDeviceId:t||null,memoryMode:"OFF"}).returning();return r}async getAiUser(e){let[t]=await W.select().from(In).where(se(In.id,e));return t||void 0}async getAiUserByEmail(e){let[t]=await W.select().from(In).where(se(In.email,e));return t||void 0}async updateAiUserMemoryMode(e,t){let[r]=await W.update(In).set({memoryMode:t,lastActiveAt:new Date}).where(se(In.id,e)).returning();return r||void 0}async deleteAiUser(e){await W.delete(In).where(se(In.id,e))}async createAiSession(e){let[t]=await W.insert(oi).values(e).returning();return t}async getAiSession(e){let[t]=await W.select().from(oi).where(se(oi.id,e));return t||void 0}async getAiSessionByToken(e){let[t]=await W.select().from(oi).where(se(oi.sessionToken,e));return t||void 0}async getUserAiSessions(e){return W.select().from(oi).where(se(oi.userId,e)).orderBy(ut(oi.createdAt))}async endAiSession(e){await W.update(oi).set({endedAt:new Date}).where(se(oi.id,e))}async deleteAiSession(e){await W.delete(_o).where(se(_o.sessionId,e)),await W.delete(oi).where(se(oi.id,e))}async createAiMessage(e){let[t]=await W.insert(_o).values(e).returning();return await W.update(oi).set({lastMessageAt:new Date}).where(se(oi.id,e.sessionId)),t}async getAiSessionMessages(e){return W.select().from(_o).where(se(_o.sessionId,e)).orderBy(_o.createdAt)}async deleteAiSessionMessages(e){await W.delete(_o).where(se(_o.sessionId,e))}async createAiFile(e){let[t]=await W.insert(us).values(e).returning();return t}async getAiFile(e){let[t]=await W.select().from(us).where(Sr(se(us.id,e),ml(us.deletedAt)));return t||void 0}async getSessionAiFiles(e){return W.select().from(us).where(Sr(se(us.sessionId,e),ml(us.deletedAt)))}async getUserAiFiles(e){return W.select().from(us).where(Sr(se(us.ownerUserId,e),ml(us.deletedAt)))}async softDeleteAiFile(e){await W.update(us).set({deletedAt:new Date}).where(se(us.id,e))}async deleteSessionAiFiles(e){await W.update(us).set({deletedAt:new Date}).where(se(us.sessionId,e))}async setAiMemory(e,t,r,s){let c=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));if(c[0]){let[d]=await W.update(bi).set({value:r,sourceMessageId:s,updatedAt:new Date}).where(se(bi.id,c[0].id)).returning();return d}let[u]=await W.insert(bi).values({userId:e,key:t,value:r,sourceMessageId:s}).returning();return u}async getAiMemory(e,t){let[r]=await W.select().from(bi).where(Sr(se(bi.userId,e),se(bi.key,t)));return r||void 0}async getAllAiMemories(e){return W.select().from(bi).where(se(bi.userId,e)).orderBy(bi.key)}async deleteAiMemory(e,t){await W.delete(bi).where(Sr(se(bi.userId,e),se(bi.key,t)))}async clearAllAiMemories(e){await W.delete(bi).where(se(bi.userId,e))}async createAiJob(e){let[t]=await W.insert(Oi).values(e).returning();return t}async getAiJob(e){let[t]=await W.select().from(Oi).where(se(Oi.id,e));return t||void 0}async getUserAiJobs(e){return W.select().from(Oi).where(se(Oi.userId,e)).orderBy(ut(Oi.createdAt))}async getSessionAiJobs(e){return W.select().from(Oi).where(se(Oi.sessionId,e)).orderBy(ut(Oi.createdAt))}async getQueuedAiJobs(){return W.select().from(Oi).where(se(Oi.status,"QUEUED")).orderBy(Oi.createdAt)}async updateAiJobStatus(e,t,r,s){let c={status:t};t==="RUNNING"&&(c.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(c.completedAt=new Date,c.progress=t==="DONE"?100:void 0),r&&(c.output=r),s&&(c.errorMessage=s);let[u]=await W.update(Oi).set(c).where(se(Oi.id,e)).returning();return u||void 0}async updateAiJobProgress(e,t){await W.update(Oi).set({progress:Math.min(100,Math.max(0,t))}).where(se(Oi.id,e))}async createMediaPipeline(e){let[t]=await W.insert(fs).values(e).returning();return t}async getMediaPipeline(e){let[t]=await W.select().from(fs).where(se(fs.id,e));return t||void 0}async getUserPipelines(e){return W.select().from(fs).where(se(fs.userId,e)).orderBy(ut(fs.createdAt))}async updatePipelineStatus(e,t,r){let s={status:t};t==="RUNNING"&&(s.startedAt=new Date),(t==="DONE"||t==="FAILED")&&(s.completedAt=new Date),r&&(s.errorMessage=r),await W.update(fs).set(s).where(se(fs.id,e))}async updatePipelineProgress(e,t,r){await W.update(fs).set({completedSteps:t,progress:Math.min(100,Math.max(0,r))}).where(se(fs.id,e))}async updatePipelineFinalArtifact(e,t,r){await W.update(fs).set({finalArtifactUrl:t,finalArtifactType:r}).where(se(fs.id,e))}async createPipelineStep(e){let[t]=await W.insert(ks).values(e).returning();return t}async getPipelineSteps(e){return W.select().from(ks).where(se(ks.pipelineId,e)).orderBy(ks.stepOrder)}async updatePipelineStepStatus(e,t){let r={status:t};t==="RUNNING"&&(r.startedAt=new Date),(t==="DONE"||t==="FAILED"||t==="SKIPPED")&&(r.completedAt=new Date),await W.update(ks).set(r).where(se(ks.id,e))}async updatePipelineStepProgress(e,t){await W.update(ks).set({progress:Math.min(100,Math.max(0,t))}).where(se(ks.id,e))}async updatePipelineStepComplete(e,t,r){await W.update(ks).set({status:"DONE",progress:100,completedAt:new Date,outputData:t?JSON.stringify(t):null,artifactUrls:r?JSON.stringify(r):null}).where(se(ks.id,e))}async updatePipelineStepFailed(e,t){await W.update(ks).set({status:"FAILED",completedAt:new Date,errorMessage:t}).where(se(ks.id,e))}async createPipelineArtifact(e){let[t]=await W.insert(Nc).values(e).returning();return t}async getPipelineArtifacts(e){return W.select().from(Nc).where(se(Nc.pipelineId,e)).orderBy(Nc.createdAt)}async getFinalArtifact(e){let[t]=await W.select().from(Nc).where(Sr(se(Nc.pipelineId,e),se(Nc.isFinal,!0)));return t||void 0}async getClaimCasesByUserId(e){return W.select().from(Di).where(se(Di.veteranUserId,e)).orderBy(ut(Di.createdAt))}async getClaimCaseById(e){let[t]=await W.select().from(Di).where(se(Di.id,e));return t||void 0}async createClaimCase(e){let[t]=await W.insert(Di).values(e).returning();return t}async updateClaimCase(e,t){let[r]=await W.update(Di).set({...t,updatedAt:new Date}).where(se(Di.id,e)).returning();return r||void 0}async getClaimTasksByCaseId(e){return W.select().from(zo).where(se(zo.caseId,e)).orderBy(zo.sortOrder)}async getClaimTaskById(e){let[t]=await W.select().from(zo).where(se(zo.id,e));return t||void 0}async createClaimTask(e){let[t]=await W.insert(zo).values(e).returning();return t}async updateClaimTask(e,t){let[r]=await W.update(zo).set(t).where(se(zo.id,e)).returning();return r||void 0}async getCaseNotesByCaseId(e){return W.select().from(Pd).where(se(Pd.caseId,e)).orderBy(ut(Pd.createdAt))}async createCaseNote(e){let[t]=await W.insert(Pd).values(e).returning();return t}async getCaseDeadlinesByCaseId(e){return W.select().from(Pl).where(se(Pl.caseId,e)).orderBy(Pl.dueDate)}async createCaseDeadline(e){let[t]=await W.insert(Pl).values(e).returning();return t}async updateCaseDeadline(e,t){let[r]=await W.update(Pl).set(t).where(se(Pl.id,e)).returning();return r||void 0}async getClaimFilesByCaseId(e){return W.select().from(Il).where(se(Il.caseId,e)).orderBy(ut(Il.createdAt))}async createClaimFile(e){let[t]=await W.insert(Il).values(e).returning();return t}async getCaseSharesByCaseId(e){return W.select().from(es).where(se(es.caseId,e)).orderBy(ut(es.createdAt))}async getCaseShareByEmail(e,t){let[r]=await W.select().from(es).where(Sr(se(es.caseId,e),se(es.email,t)));return r}async getAllCaseShares(){return W.select().from(es).orderBy(ut(es.createdAt))}async upsertCaseShare(e){let t=await this.getCaseShareByEmail(e.caseId,e.email);if(t){let[s]=await W.update(es).set({role:e.role}).where(se(es.id,t.id)).returning();return s}let[r]=await W.insert(es).values(e).returning();return r}async getCaseShareById(e){let[t]=await W.select().from(es).where(se(es.id,e));return t}async deleteCaseShare(e){await W.delete(es).where(se(es.id,e))}async getEvidenceRequirements(e,t){return W.select().from(Go).where(Sr(se(Go.track,e),se(Go.purpose,t))).orderBy(Go.priority)}async getAllEvidenceRequirements(){return W.select().from(Go).orderBy(Go.track,Go.purpose,Go.priority)}async updateClaimFileEvidence(e,t){let[r]=await W.update(Il).set(t).where(se(Il.id,e)).returning();return r}async createVendorMagicLink(e){let[t]=await W.insert(Ao).values(e).returning();return t}async getVendorMagicLinkByToken(e){let[t]=await W.select().from(Ao).where(Sr(se(Ao.token,e),se(Ao.used,!1),cd(Ao.expiresAt,new Date)));return t}async markMagicLinkUsed(e){await W.update(Ao).set({used:!0}).where(se(Ao.id,e))}async createVendorSession(e){let[t]=await W.insert(Wo).values(e).returning();return t}async getVendorSessionByToken(e){let[t]=await W.select().from(Wo).where(Sr(se(Wo.sessionToken,e),cd(Wo.expiresAt,new Date)));return t}async deleteVendorSession(e){await W.delete(Wo).where(se(Wo.sessionToken,e))}async deleteExpiredMagicLinks(){await W.delete(Ao).where(ld(Ao.expiresAt,new Date))}async deleteExpiredVendorSessions(){await W.delete(Wo).where(ld(Wo.expiresAt,new Date))}async createAffiliateActivity(e){let[t]=await W.insert(Ho).values(e).returning();return t}async getAffiliateActivityByHash(e){let[t]=await W.select().from(Ho).where(se(Ho.hash,e));return t}async getAllAffiliateActivities(){return W.select().from(Ho).orderBy(ut(Ho.createdAt))}async getAffiliateActivitiesByActorEmail(e){return W.select().from(Ho).where(se(Ho.actorEmail,e)).orderBy(ut(Ho.createdAt))}async getNotificationSettings(e){let[t]=await W.select().from(Mu).where(se(Mu.userId,e));return t}async createNotificationSettings(e){let[t]=await W.insert(Mu).values(e).returning();return t}async updateNotificationSettings(e,t){let[r]=await W.update(Mu).set({...t,updatedAt:new Date}).where(se(Mu.userId,e)).returning();return r}async ensureNotificationSettings(e){let t=await this.getNotificationSettings(e);if(t)return t;let r={SITE_VISIT:!0,CONTRACT_VIEW:!0,CONTRACT_SIGNED:!0,INFO_REQUEST:!0,AFFILIATE_CLICK:!0,AFFILIATE_SIGNUP:!0},{encrypt:s}=await Promise.resolve().then(()=>(Iv(),Cv));return this.createNotificationSettings({userId:e,enabled:!0,emailsEnc:s(JSON.stringify([])),events:JSON.stringify(r),delivery:"instant"})}async createRepairLog(e){let[t]=await W.insert(Oc).values(e).returning();return t}async getRepairLogs(e=20){return W.select().from(Oc).orderBy(ut(Oc.createdAt)).limit(e)}async getRepairLogById(e){let[t]=await W.select().from(Oc).where(se(Oc.id,e));return t||void 0}async updateRepairLogStatus(e,t){let[r]=await W.update(Oc).set({status:t}).where(se(Oc.id,e)).returning();return r||void 0}async createCriticalIncident(e){let[t]=await W.insert(za).values(e).returning();return t}async getCriticalIncidentByIncidentId(e){let[t]=await W.select().from(za).where(se(za.incidentId,e));return t||void 0}async getCriticalIncidents(e,t=20){return e?W.select().from(za).where(se(za.status,e)).orderBy(ut(za.createdAt)).limit(t):W.select().from(za).orderBy(ut(za.createdAt)).limit(t)}async updateCriticalIncident(e,t){let[r]=await W.update(za).set(t).where(se(za.incidentId,e)).returning();return r||void 0}async createIncidentAuditLog(e){let[t]=await W.insert(kd).values(e).returning();return t}async getIncidentAuditLogs(e){return W.select().from(kd).where(se(kd.incidentId,e)).orderBy(kd.timestamp)}},q=new WR});var lX={};jr(lX,{LEGAL_DOCS:()=>nn,createLegalOverride:()=>KR,generateEvidenceBundle:()=>QR,getLegalStatus:()=>jd,hasSignedLegalDoc:()=>$_,hashDocument:()=>xm,healLegalStateOnLogin:()=>R5e,legalSystemHealthCheck:()=>wm,processExternalEsignCallback:()=>YR,requireLegalClearance:()=>F5e,runLegalTestBot:()=>XR,signLegalDocumentAtomic:()=>Pv,signLegalDocumentCore:()=>bm});function xm(n){return aX.default.createHash("sha256").update(n).digest("hex")}async function $_(n,e){let[t]=await W.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e.type),se(Kr.documentVersion,e.version)));return!!t}async function bm({userId:n,documentType:e,documentVersion:t,documentHash:r,ipAddress:s,userAgent:c}){return await W.transaction(async u=>{let[d]=await u.select().from(Kr).where(Sr(se(Kr.userId,n),se(Kr.documentType,e),se(Kr.documentVersion,t)));return d?{success:!0,alreadySigned:!0}:(await u.insert(Kr).values({userId:n,documentType:e,documentVersion:t,documentHash:r||null,ipAddress:s,userAgent:c}),{success:!0,alreadySigned:!1})})}async function Pv({userId:n,doc:e,docHash:t,req:r,provider:s=null,envelopeId:c=null}){let u=r.headers["x-forwarded-for"]?.toString().split(",")[0]||r.socket.remoteAddress||"unknown",d=r.headers["user-agent"]||"unknown";return bm({userId:n,documentType:e.type,documentVersion:e.version,documentHash:t,ipAddress:u,userAgent:d})}function F5e(){return async(n,e,t)=>{let r=n.session;if(!r?.userId||!r?.userRole)return e.status(401).json({message:"Unauthorized"});for(let s of Object.keys(nn)){let c=nn[s];if(!c.requiredFor.includes(r.userRole))continue;if(!await $_(r.userId,c))return e.status(403).json({required:c.type,redirectTo:c.path})}t()}}async function jd(n,e){let t={};for(let r of Object.keys(nn)){let s=nn[r];if(!s.requiredFor.includes(e)){t[r]=!0;continue}t[r]=await $_(n,s)}return t}async function R5e(n,e){for(let t of Object.keys(nn)){let r=nn[t];if(!r.requiredFor.includes(e))continue;if(!await $_(n,r))return{redirectTo:r.path}}return{ok:!0}}async function KR({adminId:n,userId:e,documentType:t,reason:r,req:s}){let c=s.headers["x-forwarded-for"]?.toString().split(",")[0]||s.socket.remoteAddress||"unknown",u=s.headers["user-agent"]||"unknown";await W.transaction(async d=>{await d.insert(Kr).values({userId:e,documentType:t,documentVersion:"ADMIN_OVERRIDE",documentHash:"OVERRIDE",ipAddress:c,userAgent:u}),await d.insert(x_).values({adminId:n,userId:e,documentType:t,reason:r})})}async function QR(n){let t=(await W.select().from(Kr).where(se(Kr.userId,n))).map(s=>`DOC: ${s.documentType}
                                                                                                                                                                                                                                                                                                                                                                                                                   ^
    at /app/dist/index.cjs:87:410
    at /app/dist/index.cjs:1:231
    at /app/dist/index.cjs:87:1374
    at Object.<anonymous> (/app/dist/index.cjs:599:517)
    at Object..js (node:internal/modules/cjs/loader:1839:10)
    at Module.load (node:internal/modules/cjs/loader:1441:32)
    at Function._load (node:internal/modules/cjs/loader:1263:12)
Node.js v22.22.0
npm warn config production Use `--omit=dev` instead.
> NODE_ENV=production node dist/index.cjs