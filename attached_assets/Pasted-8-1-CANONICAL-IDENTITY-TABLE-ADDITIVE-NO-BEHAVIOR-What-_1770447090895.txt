8.1 ‚Äî CANONICAL IDENTITY TABLE (ADDITIVE, NO BEHAVIOR)
What this stage IS

Introduce a canonical identity mapping

WITHOUT removing legacy identity systems

WITHOUT changing auth or sessions

What this stage is NOT

Not a login rewrite

Not a session rewrite

Not an authorization rewrite

8.1A ‚Äî Create identity mapping table
‚úÖ SCHEMA (additive only)
CREATE TABLE identity_map (
  identity_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- source system
  source TEXT NOT NULL CHECK (
    source IN (
      'user',
      'vlt_affiliate',
      'veteran_oidc',
      'ai',
      'internal_service'
    )
  ),

  -- legacy identifier (string to unify types)
  legacy_id TEXT NOT NULL,

  created_at TIMESTAMP NOT NULL DEFAULT now(),

  UNIQUE (source, legacy_id)
);


Notes

legacy_id is string to support:

numeric users

UUID veterans

synthetic internal IDs

This table is not referenced anywhere yet

üõë PAUSE & VERIFY

No reads depend on this table

No writes depend on this table

No auth code changed

‚ùì QUESTIONS TO ASK REPLIT
1. Confirm all legacy identity sources and their PK formats.
2. Confirm no legacy ID collisions across sources.

8.2 ‚Äî SHADOW IDENTITY RESOLUTION (READ + WRITE, NO ENFORCEMENT)
Why

You want to observe identity unification before enforcing it.

8.2A ‚Äî Extend identity resolver to shadow-write
Conceptual behavior

Identity is resolved as in Phase 7

Mapping is created if missing

Mapping is never required

‚úÖ MODIFY identity resolver (conceptual)
// pseudo-shape
const identity = resolveIdentity(req);

// async, fire-and-forget
ensureIdentityMap(identity);


Where ensureIdentityMap:

inserts (source, legacy_id) if not present

never throws

never blocks request

üõë PAUSE & VERIFY

Identity map fills gradually

No auth behavior changes

No performance regressions

‚ùì QUESTIONS TO ASK REPLIT
1. Is background DB write latency acceptable here?
2. Any endpoints with extreme request volume that should skip shadow writes?

8.3 ‚Äî SESSION CANONICALIZATION (DUAL MODE)
What changes

Sessions begin carrying identityId

Legacy session fields remain intact

8.3A ‚Äî Extend session helper
Behavior

After login:

session.identityId = mapped canonical ID

legacy fields still set (userId, vltAffiliateId, etc.)

No reads change yet.

üõë PAUSE & VERIFY

Sessions still deserialize correctly

No consumer expects identityId

No serialization size issues

‚ùì QUESTIONS TO ASK REPLIT
1. Any code serializing session explicitly?
2. Any session size limits enforced by infra?

8.4 ‚Äî POLICY ENFORCEMENT MIGRATION (DOMAIN BY DOMAIN)
Rule

Never enforce globally first.
Migrate one domain at a time.

8.4A ‚Äî Claims domain (first)
Why

Clean ownership model

Veteran-only access

Already centralized checks

APPLY

Replace:

manual ownership checks

With:

requireIdentity

policy checks using canonical identity + MFA

Behavior must be identical.

üõë PAUSE & VERIFY

Veteran access unchanged

Admin/internal service behavior unchanged

MFA enforcement unchanged

‚ùì QUESTIONS TO ASK REPLIT
1. Any claim routes accessed by non-veterans?
2. Any claim routes bypassing ownership checks today?

8.4B ‚Äî Affiliate domain (second)
Why

Composite identity (user + vlt)

NDA + contract gating

Higher risk

APPLY

Policy checks must:

require role === affiliate

enforce MFA

enforce NDA/contract

explicitly block admin

üõë PAUSE & VERIFY

Admins cannot access affiliate-only routes

VLT composite identity still works

NDA enforcement unchanged

‚ùì QUESTIONS TO ASK REPLIT
1. Which affiliate routes are intentionally admin-accessible?
2. Any affiliate routes skipping NDA today?

8.4C ‚Äî Admin domain (last)
Why last

Highest blast radius

Internal service exceptions

APPLY

Enforce:

admin role

MFA

internal service override

üõë PAUSE & VERIFY

Internal service still bypasses MFA

Admin MFA still enforced

No lockouts

8.5 ‚Äî SCHEMA ENFORCEMENT (ONLY AFTER OBSERVATION)
Important

You are on drizzle push.
This is dangerous if rushed.

8.5A ‚Äî Observability pass

Before adding any FK:

Query for orphaned legacy rows

Verify identity_map coverage

Confirm no mixed ownership

üõë PAUSE & VERIFY

All rows have identity mappings

No write paths bypass mapping

Staging validation passes

8.5B ‚Äî Enforce constraints (incrementally)

Examples:

claims ‚Üí identity_map

commissions ‚Üí identity_map

signed agreements ‚Üí identity_map

One table at a time.

8.6 ‚Äî DELETE LEGACY CODE (CONTROLLED)
What you delete

Role string checks

Legacy ownership checks

Duplicate commission math

Old auth middleware

Dead helpers

Rule

If a piece of code:

is unused

has no callers

is superseded by policy

‚Üí delete it

üõë PAUSE & VERIFY

Manual smoke test:

login

veteran claims

affiliate NDA

admin dashboard

No warnings in logs

PHASE 8 SUMMARY (LIKE PHASE 6 & 7)
Stage	Purpose	Behavior Change
8.1 Identity map	Canonical identity	‚ùå
8.2 Shadow resolution	Observe mapping	‚ùå
8.3 Session dual-mode	Prepare sessions	‚ùå
8.4 Policy migration	Enforce correctly	‚úÖ (gradual)
8.5 Schema enforcement	Hard correctness	‚ùå‚Üí‚úÖ
8.6 Deletion	Remove entropy	‚ùå
Final architect clarity

Total phases: 8

Phase 8 is the finish line

After Phase 8:

identity is unambiguous

auth is centralized

schema reflects reality

legacy drift is gone