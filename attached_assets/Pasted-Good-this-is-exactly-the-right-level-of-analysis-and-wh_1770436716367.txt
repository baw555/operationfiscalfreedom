Good — this is exactly the right level of analysis, and what you wrote shows you (and Replit) now actually understand the system as it exists, not an abstract ideal.

I’m going to do three things, in order:

Validate the analysis you just laid out (sanity check)

Answer the implied question: what actually needs to change vs stay

Lay out the minimal, non-destructive refactor that truly “fixes the code”

No yes-man answers here.

1️⃣ Sanity check: is your current picture correct?

Yes. What you described is internally consistent and, importantly, already production-safe in several key ways.

Current transaction (re-stated cleanly)

Inside withIdempotency transaction:

idempotency_keys — INSERT (claim)

users — UPDATE (referral code)

affiliate_nda — INSERT

events — INSERT (NDA_SUBMITTED)

events — INSERT (NDA_SUBMITTED_WITH_DEGRADATION, conditional)

idempotency_keys — UPDATE (entityId)

Then outside the transaction:

signLegalDocumentAtomic

degraded notification enqueue (fire-and-forget)

That is a good ordering.

Failure semantics (important)

Steps 1–6: atomic rollback → no partial NDA

Step 7: allowed to fail → documented acceptable degradation

Step 8: non-blocking → ops concern, not user concern

This is exactly how a regulated-but-user-friendly system should behave.

Replay safety

Your conclusions are also correct:

NDA insert: replay-safe

Legal mirror: replay-safe (idempotent by design)

Notifications: effectively replay-safe due to short-circuiting

There is no hidden double-sign bug lurking here.

So let’s be very clear:

The NDA flow is not broken.
It is structurally messy, but logically sound.

That distinction matters.

2️⃣ What not to change (this is where bad refactors happen)

Replit correctly identified several things that must not be dropped. I’ll go one level deeper and explain why.

❌ Do NOT drop validation

Your validation layer is part of your data contract. Removing it would:

allow invalid affiliate records

create compliance exposure

push complexity into the DB or legal layer (worse)

❌ Do NOT drop signLegalDocumentAtomic

This is not a “side effect” — it’s a parallel authoritative record.

Even if affiliate_nda is authoritative for onboarding, the legal system is authoritative for enforceability. They serve different purposes.

❌ Do NOT change signature storage shape casually

signatureData as a flat TEXT field is fine.
Changing this during a refactor creates migration risk for zero business gain.

❌ Do NOT strip required field capture

Your NDA is not just a signature — it’s an identity + consent artifact.
Dropping name, address, photos, etc. is a regression, not simplification.

3️⃣ What actually needs to change (minimal, correct refactor)

Here’s the key insight:

You do not need to redesign the NDA system.
You only need to move responsibilities to the right layer.

The real problems (as you correctly identified)

Route is doing too much

parsing

validation

logging

side effects

orchestration

Action layer is coupled to Express

req passed through just for IP/UA

makes it untestable outside HTTP

Duplicate degraded logging

route logs

action emits events

two sources of truth

These are structural problems, not logic problems.

4️⃣ The correct minimal refactor (no regressions)

This is the answer to Replit’s question — and yours.

✅ Keep ALL existing behavior

same schema

same validation

same legal mirror

same side effects

same replay semantics

✅ Change ONLY structure and boundaries
A. Thin route (this is safe and valuable)

The route should:

authenticate

extract IP / UA

validate request (existing validators)

call one action

return result

No DB writes. No business logic.

B. Action becomes the single orchestrator

The action should:

accept plain data, not req

run inside withIdempotency

write affiliate_nda

emit events

return a clean result

C. Legal mirror stays outside transaction, but inside action

Exactly as you have now — this is correct.

D. Remove duplicated logging from the route

Events already capture degradation.
Having route-level logs is redundant and risks divergence.

5️⃣ What this buys you (and what it doesn’t)
What you gain

Testable action logic

Cleaner routes.ts (or extracted routes)

Clear ownership of NDA truth

No loss of compliance

No data migrations required

No behavior changes for users

What you do NOT gain (yet)

New features

Schema improvements

Legal versioning

Better analytics

And that’s fine — this refactor is about stability, not expansion.

6️⃣ The honest bottom line

You are not deciding whether to “rewrite the NDA system.”

You are deciding whether to:

keep a correct system that is hard to reason about, or

have the same system, but with clear seams and ownership

The right answer is the second — without changing what the system does.

Replit’s instinct to ask before changing schema was correct.
Your instinct to demand the full picture first was also correct.