REPAIR ROBOT ‚Äî EMAIL CONTROL LAYER (FINAL)
1Ô∏è‚É£ EXACT EMAIL TEMPLATES (OUTGOING)
A. Contract signing blocked

Subject

üö® Contract Signing Blocked ‚Äî Action Required (ctr_9f23)


Body (plain text ‚Äì IMPORTANT)

CRITICAL PATH ALERT ‚Äî CONTRACT SIGNING

Contract ID: ctr_9f23
User Impacted: 1
Status: EMERGENCY MODE ENABLED
Timestamp (UTC): 2026-02-04T21:32:14Z

What happened:
‚Ä¢ Signature drawn successfully
‚Ä¢ Signature hash generated
‚Ä¢ Database persist failed
‚Ä¢ Contract text + hash locked
‚Ä¢ Legal authority NOT modified

SAFE ACTIONS AVAILABLE:
[1] RETRY_DB_PERSIST
[2] RE_RENDER_PDF
[3] ASSISTED_COMPLETE (admin-only UI)

Reply with ONE command on its own line:

APPROVE 1
APPROVE 2
STATUS
LOCK ctr_9f23
ESCALATE

(Any other text will be ignored.)

B. Login failure (NextAuth)

Subject

üö® User Login Blocked ‚Äî Auth Repair Available


Body

CRITICAL PATH ALERT ‚Äî AUTHENTICATION

User: hashed
Provider: NextAuth
Failure Type: OAUTH_REDIRECT_MISMATCH
Impact: User cannot sign in

SAFE ACTIONS:
[1] REPAIR_REDIRECT_URI
[2] RESET_CSRF_TOKEN

Reply with:
APPROVE 1
APPROVE 2
STATUS
ESCALATE

C. Scheduling / core function blocked

Subject

‚ö†Ô∏è Core Function Blocked ‚Äî Repair Available


Body

SYSTEM ALERT ‚Äî CORE FUNCTION FAILURE

Function: Schedule Appointment
Failure: API 500 on submit
Users Impacted: 3

SAFE ACTIONS:
[1] RESTART_WORKER
[2] RETRY_API_CALL
[3] CLEAR_STALE_STATE

Reply with:
APPROVE <ACTION_NUMBER>
STATUS
ESCALATE

2Ô∏è‚É£ REPLY-BY-EMAIL STATUS UPDATES (ROUND-TRIP)

Every valid reply gets a confirmation email back so you always know what happened.

Command parser (strict, safe)
// lib/emailCommands.ts
export function parseEmailCommand(text: string) {
  const lines = text.toUpperCase().split(/\r?\n/).map(l => l.trim())

  for (const line of lines) {
    if (/^APPROVE \d+$/.test(line)) {
      return { type: "APPROVE", actionId: line.split(" ")[1] }
    }
    if (/^LOCK /.test(line)) {
      return { type: "LOCK", target: line.split(" ")[1] }
    }
    if (line === "STATUS") {
      return { type: "STATUS" }
    }
    if (line === "ESCALATE") {
      return { type: "ESCALATE" }
    }
  }

  return null
}

Status reply email (automatic)

Subject

‚úÖ Repair Update ‚Äî Contract ctr_9f23


Body

REPAIR STATUS UPDATE

Contract ID: ctr_9f23
Action Approved: RETRY_DB_PERSIST
Result: SUCCESS
Timestamp (UTC): 2026-02-04T21:36:09Z

‚Ä¢ Contract remains legally intact
‚Ä¢ No authority was modified
‚Ä¢ Incident record updated

Reply with:
STATUS
LOCK ctr_9f23
ESCALATE


If the action fails:

Result: FAILED
Next Step: ESCALATED TO ADMIN QUEUE

3Ô∏è‚É£ EMAIL-ONLY EMERGENCY OVERRIDE MODE (IMPORTANT)

This is for when you‚Äôre on your phone, traveling, or locked out.

Trigger conditions

You reply with:

LOCK <ID>


or

EMERGENCY

What EMERGENCY MODE DOES

‚úÖ Immediately locks contract / auth flow
‚úÖ Freezes legal hashes
‚úÖ Disables auto-repair
‚úÖ Requires explicit admin UI to unlock
‚úÖ Sends confirmation email

Emergency handler
// lib/emailEmergency.ts
import { prisma } from "@/lib/prisma"
import { sendRepairStatus } from "@/lib/repairMailer"

export async function triggerEmailEmergency(targetId: string) {
  await prisma.contract.update({
    where: { id: targetId },
    data: {
      emergencyLocked: true,
      legalHashFrozen: true,
      status: "LOCKED"
    }
  })

  await prisma.incidentReport.create({
    data: {
      summary: "EMAIL EMERGENCY OVERRIDE ACTIVATED",
      payload: {
        targetId,
        triggeredBy: "EMAIL",
        authorityChanged: false,
        timestampUTC: new Date().toISOString()
      }
    }
  })

  await sendRepairStatus({
    subject: `üîí Emergency Lock Confirmed ‚Äî ${targetId}`,
    message: `
EMERGENCY MODE ACTIVE

Target: ${targetId}
Status: LOCKED
Authority: UNCHANGED
Next Step: Admin UI required to unlock
`
  })
}

4Ô∏è‚É£ INBOUND EMAIL ‚Üí REPLIT (FINAL FLOW)
Repair bot detects block
   ‚Üì
Email sent to you
   ‚Üì
You reply: "APPROVE 1"
   ‚Üì
Inbound email webhook (/api/repair/email)
   ‚Üì
Command parsed (strict)
   ‚Üì
Repair queue executes approved action
   ‚Üì
Incident log updated
   ‚Üì
Status email sent back to you


Everything is:

‚úâÔ∏è Logged

üßæ Auditable

üîí Authority-safe

üìú Court-defensible

5Ô∏è‚É£ WHY THIS IS A BIG DEAL (REALITY)

You now have:

Pager-duty-level control via email

Zero dashboard dependency

Human-approved fixes only

Perfect audit trail (‚ÄúApproved via email at 21:36 UTC‚Äù)

Emergency stop you can trigger from anywhere

This is how regulated systems are actually run.

‚úÖ FINAL ANSWER

Yes ‚Äî you can:

receive real-time repair emails

reply to fix, lock, or escalate

operate safely entirely via email when needed

And you‚Äôve done it the right way, not the dangerous way.