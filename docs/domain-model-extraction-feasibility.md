# Domain Model Extraction Feasibility Report

**Generated:** 2026-02-08 (auto-generated by `scripts/audit-domain.ts`)  
**Sources:** `server/routes.ts`, `shared/schema.ts`, `server/actions/`, `server/storage.ts`

> Run `npx tsx scripts/audit-domain.ts` to regenerate this report.

---

## Quick Summary

| Metric | Count |
|---|---|
| **Total backend routes** | 327 |
| **Domain entities analyzed** | 8 |
| **Action files** | 7 |
| **Entities feasible for class extraction** | 2 |
| **Entities NOT feasible** | 4 |
| **Entities partially feasible** | 2 |

---

## Summary Table

| Entity | Tables | Mutating Routes | Reading Routes | Source of Truth | Lifecycle | Class Feasible? |
|---|---|---|---|---|---|---|
| **User / Affiliate Identity** | 5 | 15 | 6 | NO | YES | NO |
| **Legal Documents (NDA, Contracts, Signatures)** | 6 | 9 | 10 | PARTIAL | YES | PARTIAL |
| **Claim Case** | 9 | 6 | 19 | YES | MODERATE | YES IF REFACTORED |
| **Commission / Sale** | 4 | 7 | 3 | NO | YES | NO |
| **CSU Contract / Envelope** | 7 | 19 | 12 | NO | YES | NO |
| **AI Session / Generation** | 9 | 14 | 7 | NO | YES | PARTIAL |
| **VLT Affiliate Hierarchy** | 6 | 5 | 3 | NO | MODERATE | NO |
| **Sailor Man AI Assistant** | 3 | 4 | 2 | YES | LOW | YES |

---

## Entity: User / Affiliate Identity

### Tables Spanned
- `users`
- `vlt_affiliates`
- `veteran_auth_users`
- `ai_users`
- `password_reset_tokens`

### Routes That Mutate (15)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/affiliate-signup` | 430 | New affiliate self-signup - creates account and logs in immediately |
| POST | `/api/admin/vlt-affiliates` | 1558 | Create VLT affiliate |
| PATCH | `/api/admin/vlt-affiliates/:id` | 1603 | Update VLT affiliate |
| DELETE | `/api/admin/vlt-affiliates/:id` | 1617 | Delete VLT affiliate |
| POST | `/api/vlt-affiliate/login` | 1630 | ===== VLT AFFILIATE PORTAL ===== |
| POST | `/api/vlt-affiliate/logout` | 1670 | VLT Affiliate logout |
| POST | `/api/auth/login` | 1734 | ===== AUTH ROUTES ===== |
| POST | `/api/auth/logout` | 1857 | Logout |
| POST | `/api/auth/init-admin` | 1883 | Initialize admin (one-time setup) |
| POST | `/api/auth/register` | 1911 | Register new user (public registration) |
| POST | `/api/auth/forgot-password` | 1955 | Request password reset |
| POST | `/api/auth/reset-password` | 2049 | Reset password with token |
| POST | `/api/admin/affiliates` | 2178 | Create affiliate user |
| PATCH | `/api/admin/affiliates/:id/password` | 2204 | Reset affiliate password |
| DELETE | `/api/admin/affiliates/:id` | 2227 | Delete affiliate |

### Routes That Read (6)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/admin/vlt-affiliates` | 1548 | ===== VLT AFFILIATE MANAGEMENT (Admin) ===== |
| GET | `/api/vlt-affiliate/me` | 1676 | VLT Affiliate logout |
| GET | `/api/vlt-affiliate/leads` | 1719 | Get VLT affiliate's leads |
| GET | `/api/auth/me` | 1867 | Get current user |
| GET | `/api/auth/validate-reset-token` | 2086 | Validate reset token (for UI) |
| GET | `/api/admin/affiliates` | 2162 | Get all affiliates |

### Single Source of Truth?
**NO.** 4 separate identity tables (users, vlt_affiliates, veteran_auth_users, ai_users) with no FK relationships between them

### Lifecycle Fragmented?
**YES.** User creation scattered across 4+ routes. Session management duplicated in 4 places with nested callbacks.

### Can It Be Represented as a Stable Class Object Today?
**NO.** Identity split across 4 unlinked tables. PK types incompatible (serial vs varchar UUID). Polymorphic IDs prevent type-safe traversal.

---

## Entity: Legal Documents (NDA, Contracts, Signatures)

### Tables Spanned
- `affiliate_nda`
- `legal_signatures`
- `contract_templates`
- `signed_agreements`
- `legal_override_audit`
- `signature_metrics`

### Routes That Mutate (9)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/legal/sign/:type` | 2652 | Sign a legal document (generic handler) |
| POST | `/api/legal/esign-callback` | 2709 | External e-sign callback (for DocuSign/HelloSign style integrations) |
| POST | `/api/metrics/signature-event` | 2795 | Signature metrics tracking endpoint (public for funnel tracking) |
| POST | `/api/contracts/seed-mah` | 4096 | ===== CONTRACT MANAGEMENT ROUTES ===== |
| POST | `/api/contracts/seed-all-services` | 4204 | Seed all MAH service contracts |
| POST | `/api/contracts/seed-icc` | 4284 | Seed ICC Logistics service contract (legacy endpoint) |
| POST | `/api/contracts/templates` | 4394 | Create contract template (admin only) |
| PATCH | `/api/contracts/templates/:id` | 4408 | Update contract template (admin only) |
| POST | `/api/contracts/sign` | 4452 | Sign a contract |

### Routes That Read (10)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/legal/status` | 2641 | ===== GLOBAL LEGAL SYSTEM ROUTES ===== |
| GET | `/api/contracts/templates` | 4360 | Get all contract templates |
| GET | `/api/contracts/templates/active` | 4370 | Get active contract templates |
| GET | `/api/contracts/templates/:id` | 4380 | Get a single contract template |
| GET | `/api/contracts/signed` | 4419 | Get all signed agreements (admin/master) |
| GET | `/api/contracts/signed/affiliate/:affiliateId` | 4429 | Get signed agreements for a specific affiliate |
| GET | `/api/contracts/check/:affiliateId/:templateId` | 4440 | Check if affiliate has signed a specific contract |
| GET | `/api/contracts/pending/:affiliateId` | 4488 | Get pending contracts for an affiliate (contracts they haven't signed yet) |
| GET | `/api/contracts/my-signed` | 4502 | Get signed agreements for the current logged-in user |
| GET | `/api/contracts/signed/:id/download` | 4515 | Download signed agreement as HTML document |

### Single Source of Truth?
**PARTIAL.** 3 separate signature systems: affiliate_nda, legal_signatures, signed_agreements. legal_signatures acts as partial aggregator.

### Lifecycle Fragmented?
**YES.** 3 signing flows: NDA action file, signLegalDocumentAtomic (takes req object), contract inline handler.

### Can It Be Represented as a Stable Class Object Today?
**PARTIAL.** Could create LegalDocument class IF all signatures unified, polymorphic affiliate_id resolved, and signLegalDocumentAtomic decoupled from Express req.

---

## Entity: Claim Case

### Tables Spanned
- `claim_cases`
- `claim_tasks`
- `claim_files`
- `claim_sessions`
- `claim_answers`
- `case_shares`
- `case_notes`
- `case_deadlines`
- `evidence_requirements`

### Routes That Mutate (6)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/claims/cases` | 9337 | Create a new case with tasks |
| PATCH | `/api/claims/tasks/:id` | 9393 | Update a task status |
| POST | `/api/claims/cases/:id/notes` | 9444 | Add a note to a case |
| POST | `/api/claims/cases/:id/shares` | 9505 | Invite a vendor to a case (upsert) |
| DELETE | `/api/claims/shares/:id` | 9528 | Remove a vendor's access |
| PATCH | `/api/claims/files/:id/evidence` | 9744 | Update file evidence metadata |

### Routes That Read (19)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/claims/cases` | 9311 | ========================================== |
| GET | `/api/claims/cases/:id` | 9327 | Get a specific case |
| GET | `/api/claims/cases/:id/tasks` | 9381 | Get tasks for a case |
| GET | `/api/claims/cases/:id/notes` | 9432 | Get notes for a case |
| GET | `/api/claims/cases/:id/deadlines` | 9469 | Get deadlines for a case |
| GET | `/api/claims/cases/:id/files` | 9481 | Get files for a case |
| GET | `/api/claims/cases/:id/shares` | 9493 | Get shares for a case |
| GET | `/api/claims/evidence-requirements` | 9563 | EVIDENCE & COMPLETENESS ENDPOINTS |
| GET | `/api/claims/cases/:id/completeness` | 9583 | Get completeness analysis for a case |
| GET | `/api/claims/cases/:id/strength` | 9639 | Get evidence strength analysis for a case |
| GET | `/api/claims/cases/:id/lane-recommendation` | 9683 | Get lane recommendation for a case |
| GET | `/api/claims/cases/:id/vendor-metrics` | 9788 | ==================================================== |
| GET | `/api/claims/cases/:id/export` | 9868 | ==================================================== |
| GET | `/api/claims/cases/:id/heatmap` | 10004 | ==================================================== |
| GET | `/api/claims/cases/:id/suggestions` | 10057 | STAGE 7-10: INTELLIGENCE FEATURES |
| GET | `/api/claims/cases/:id/vendor-scorecards` | 10099 | Stage 8: Get vendor scorecards for a case |
| GET | `/api/claims/cases/:id/lane-confidence` | 10158 | Stage 9: Get VA lane confidence recommendation |
| GET | `/api/claims/cases/:id/upload-checklist` | 10222 | Stage 10: Get VA.gov upload checklist |
| GET | `/api/claims/cases/:id/export/download` | 10257 | ZIP EXPORT (PAID FEATURE) |

### Single Source of Truth?
**YES.** Claims domain owns 9 related tables with claim_cases as clear root aggregate. All child tables FK to claim_cases.id.

### Lifecycle Fragmented?
**MODERATE.** Case creation is atomic. Ownership verification copy-pasted across 7+ route handlers. No shared ownership guard.

### Can It Be Represented as a Stable Class Object Today?
**YES_IF_REFACTORED.** Most feasible entity. Single ownership model, complete FK chain, atomic creation. Needs ownership guard centralization and 2 FK fixes.

---

## Entity: Commission / Sale

### Tables Spanned
- `opportunities`
- `sales`
- `commissions`
- `commission_config`

### Routes That Mutate (7)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/opportunities` | 3783 | Create opportunity (admin only) |
| PATCH | `/api/opportunities/:id` | 3797 | Update opportunity (admin only) |
| POST | `/api/sales` | 3864 | Create sale with commission calculation |
| PATCH | `/api/sales/:id` | 3878 | Update sale status |
| POST | `/api/commission/calculate` | 4616 | - Producer: 69% base + 1% for each empty upline slot (up to 75% solo) |
| POST | `/api/commission/seed` | 4653 | Seed default commission config (simplified model) |
| POST | `/api/admin/send-commission-spreadsheet` | 4730 | Send commission spreadsheet email |

### Routes That Read (3)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/opportunities` | 3773 | ===== ECOSYSTEM / MASTER PORTAL ROUTES ===== |
| GET | `/api/commission/config` | 4626 | Get commission configuration (simplified model) |
| GET | `/api/admin/commissions` | 4708 | Get all commissions for admin dashboard |

### Single Source of Truth?
**NO.** Commission calculation embedded in route handler, hardcoded in email template, and duplicated in stress test. 7-level referral chain flattened with no FK.

### Lifecycle Fragmented?
**YES.** Commission calculation duplicated in 3 places: route handler, stress test, and email template.

### Can It Be Represented as a Stable Class Object Today?
**NO.** Cannot create stable class. Calculation logic not extracted. 14 nullable referral columns with no FK integrity. Booleans stored as text.

---

## Entity: CSU Contract / Envelope

### Tables Spanned
- `csu_contract_templates`
- `csu_contract_template_fields`
- `csu_contract_sends`
- `csu_signed_agreements`
- `csu_envelopes`
- `csu_envelope_recipients`
- `csu_audit_trail`

### Routes That Mutate (19)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/csu/scan-document` | 5813 | AI Document Scanner - Upload, extract text, and reformat documents |
| POST | `/api/csu/fix-template/:id` | 5862 | Fix an existing template using AI |
| PUT | `/api/csu/save-fixed-template/:id` | 5897 | Save fixed template content |
| POST | `/api/csu/ai-smart-extract` | 5931 | AI Smart Extract - Consolidated AI that extracts, formats, and triple-checks all fields in one call |
| POST | `/api/csu/ai-autofill` | 6072 | Legacy endpoint - redirect to smart extract |
| POST | `/api/csu/analyze-document` | 6128 | Upload and analyze a contract document to extract form fields |
| POST | `/api/csu/analyze-template-content` | 6174 | Analyze template content with AI (no file upload required) |
| POST | `/api/csu/send-contract` | 6264 | Send a contract to someone (admin) |
| POST | `/api/csu/send-contract-batch` | 6398 | Batch send contracts to multiple recipients (admin) |
| POST | `/api/csu/envelopes` | 6548 | CSU ENVELOPES - DocuSign-like multi-recipient signing |
| POST | `/api/csu/envelopes/:id/send` | 6639 | Send envelope (trigger emails based on routing order) |
| PUT | `/api/csu/envelopes/:id/recipients` | 6820 | Update envelope signing order (before sending) |
| POST | `/api/csu/envelopes/:id/void` | 6917 | Void envelope |
| POST | `/api/csu/contract-sends/:id/resend` | 6976 | Resend contract with new token (admin) |
| POST | `/api/csu/contract-sends/:id/void` | 7070 | Void/cancel a contract (admin) |
| POST | `/api/csu/templates` | 7136 | Create or update template with fields (admin) |
| PUT | `/api/csu/templates/:id` | 7203 | Update template with fields (admin) |
| DELETE | `/api/csu/templates/:id` | 7276 | Delete template (admin) |
| POST | `/api/csu/sign/:token` | 7375 | Public: Submit signed contract |

### Routes That Read (12)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/csu/templates` | 6253 | Get all CSU contract templates (admin) |
| GET | `/api/csu/contract-sends` | 6533 | Get all contract sends (admin) |
| GET | `/api/csu/envelopes` | 6789 | Get all envelopes |
| GET | `/api/csu/envelopes/:id` | 6800 | Get envelope with recipients |
| GET | `/api/csu/envelopes/:id/signing-order` | 6852 | Get signing order diagram preview |
| GET | `/api/csu/envelopes/:id/audit-trail` | 6899 | Get audit trail for envelope |
| GET | `/api/csu/signed-agreements` | 7110 | Get all signed agreements (admin) |
| GET | `/api/csu/templates/:id/fields` | 7121 | Get template fields for a specific template (admin) |
| GET | `/api/csu/templates/:id` | 7297 | Get single template with fields (admin) |
| GET | `/api/csu/contract/:token` | 7319 | Public: Get contract by token (for signing page) |
| GET | `/api/csu/signed-agreements/:id/pdf/public` | 7480 | Public: Download signed agreement PDF (for immediate download after signing) |
| GET | `/api/csu/signed-agreements/:id/pdf` | 7545 | Admin: Download signed agreement PDF |

### Single Source of Truth?
**NO.** Two parallel signing systems: legacy single-send (csu_contract_sends → csu_signed_agreements) and new envelope system (csu_envelopes → csu_envelope_recipients).

### Lifecycle Fragmented?
**YES.** Signing workflow duplicated across single-send and envelope flows. Both write to csu_audit_trail with different FK columns.

### Can It Be Represented as a Stable Class Object Today?
**NO.** Cannot create unified class. Two parallel signing systems with no shared abstraction. Polymorphic audit trail.

---

## Entity: AI Session / Generation

### Tables Spanned
- `ai_users`
- `ai_sessions`
- `ai_messages`
- `ai_files`
- `ai_memory`
- `ai_jobs`
- `ai_generations`
- `ai_templates`
- `operator_ai_memory`

### Routes That Mutate (14)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/ai/generate` | 8460 | 1 minute |
| DELETE | `/api/ai/generation/:id` | 8555 | Delete an AI generation |
| POST | `/api/ai/templates` | 8578 | Admin: Create a new AI template |
| PATCH | `/api/ai/templates/:id` | 8589 | Admin: Update an AI template |
| POST | `/api/operator-ai/chat` | 8611 | Operator AI Chat endpoint with 3 memory modes |
| DELETE | `/api/operator-ai/session/:sessionId` | 8787 | Clear session memory (Forget Session button) |
| DELETE | `/api/operator-ai/persistent/:userId` | 8799 | Clear persistent memory (Wipe Memory button - requires user auth) |
| POST | `/api/operator-ai/documents` | 8839 | Upload documents endpoint |
| DELETE | `/api/operator-ai/documents/:sessionId` | 8913 | Clear session documents |
| POST | `/api/orchestration/route` | 8966 | Route user intent to optimal model(s) |
| POST | `/api/orchestration/execute` | 9035 | Execute an orchestration pipeline |
| POST | `/api/ai/generate-image` | 9071 | Image Generation endpoint - real GPT-4o Image API |
| POST | `/api/ai/text-to-speech` | 9130 | Text-to-Speech endpoint |
| POST | `/api/orchestration/fusion` | 9173 | Fusion endpoint - combine multiple media types |

### Routes That Read (7)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/ai/gallery` | 8367 | ========================================== |
| GET | `/api/ai/generation/:id` | 8400 | Get a specific AI generation |
| GET | `/api/ai/templates` | 8417 | Get all active AI templates |
| GET | `/api/ai/templates/category/:category` | 8428 | Get templates by category |
| GET | `/api/operator-ai/session/:sessionId` | 8811 | Get session memory history |
| GET | `/api/operator-ai/documents/:sessionId` | 8889 | Get uploaded documents for session |
| GET | `/api/orchestration/models` | 8930 | ========================================================================== |

### Single Source of Truth?
**NO.** Memory stored in 2 tables (operator_ai_memory FK to users, ai_memory FK to ai_users). ai_generations FK to users but other AI tables FK to ai_users.

### Lifecycle Fragmented?
**YES.** Chat logic embedded in route handler (~174 lines). Content filtering, memory mode logic, OpenAI API call all inline.

### Can It Be Represented as a Stable Class Object Today?
**PARTIAL.** Could create AiSession class IF memory tables unified, chat orchestration extracted, identity resolved between users and ai_users.

---

## Entity: VLT Affiliate Hierarchy

### Tables Spanned
- `vlt_affiliates`
- `sales`
- `commissions`
- `veteran_intake`
- `business_intake`
- `vlt_intake`

### Routes That Mutate (5)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/admin/vlt-affiliates` | 1558 | Create VLT affiliate |
| PATCH | `/api/admin/vlt-affiliates/:id` | 1603 | Update VLT affiliate |
| DELETE | `/api/admin/vlt-affiliates/:id` | 1617 | Delete VLT affiliate |
| POST | `/api/vlt-affiliate/login` | 1630 | ===== VLT AFFILIATE PORTAL ===== |
| POST | `/api/vlt-affiliate/logout` | 1670 | VLT Affiliate logout |

### Routes That Read (3)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/admin/vlt-affiliates` | 1548 | ===== VLT AFFILIATE MANAGEMENT (Admin) ===== |
| GET | `/api/vlt-affiliate/me` | 1676 | VLT Affiliate logout |
| GET | `/api/vlt-affiliate/leads` | 1719 | Get VLT affiliate's leads |

### Single Source of Truth?
**NO.** Hierarchy stored as 7 flat columns in vlt_affiliates, duplicated in sales and 3 intake tables. 34 referral columns, none with FK constraints.

### Lifecycle Fragmented?
**MODERATE.** Affiliate creation includes bcrypt + upline chain building inline. Hierarchy traversal rebuilt in each route with (data as any) casting.

### Can It Be Represented as a Stable Class Object Today?
**NO.** Cannot create tree structure. 8 missing FK constraints. Hierarchy duplicated in 5 tables. Booleans stored as text.

---

## Entity: Sailor Man AI Assistant

### Tables Spanned
- `sailor_conversations`
- `sailor_messages`
- `sailor_faq`

### Routes That Mutate (4)

| Method | Path | Line | Description |
|---|---|---|---|
| POST | `/api/sailor/conversation` | 10713 | 25MB limit for audio |
| POST | `/api/sailor/chat` | 10743 | Send a text message and get AI response |
| POST | `/api/sailor/transcribe` | 10782 | Voice transcription endpoint |
| POST | `/api/sailor/voice-chat` | 10796 | Voice chat - transcribe and respond |

### Routes That Read (2)

| Method | Path | Line | Description |
|---|---|---|---|
| GET | `/api/sailor/conversation/:id/messages` | 10728 | Get conversation history |
| GET | `/api/sailor/tips` | 10770 | Get contextual tips for current page |

### Single Source of Truth?
**YES.** Self-contained domain. 3 tables with clear FK relationships. Service layer already extracted (sailor-chat.ts).

### Lifecycle Fragmented?
**LOW.** Chat logic lives in server/sailor-chat.ts. FAQ management is straightforward CRUD.

### Can It Be Represented as a Stable Class Object Today?
**YES.** Simplest candidate. 3 tables, clean FK chain, extracted service layer, no identity conflicts, no polymorphic references.

---

## Blocking Issues for Class Object Extraction

1. **5 entities lack a single source of truth**
2. **5 entities have fragmented lifecycle logic**
3. **4 entities are NOT feasible for class extraction today**
4. **4 disconnected identity systems** with no FK relationships between them
5. **52+ missing FK constraints** prevent safe relationship traversal
6. **Business logic embedded in route handlers** (commission calc, AI chat, email templates)
7. **Express `req` object passed to domain functions** (legal system coupling)

---

## Feasibility Conclusion

**Class objects are NOT feasible today for 4 out of 8 entities.**

**Extraction-ready entities:**
- **Claim Case** — Most feasible entity. Single ownership model, complete FK chain, atomic creation. Needs ownership guard centralization and 2 FK fixes.
- **Sailor Man AI Assistant** — Simplest candidate. 3 tables, clean FK chain, extracted service layer, no identity conflicts, no polymorphic references.

**Partially feasible entities:**
- **Legal Documents (NDA, Contracts, Signatures)** — Could create LegalDocument class IF all signatures unified, polymorphic affiliate_id resolved, and signLegalDocumentAtomic decoupled from Express req.
- **AI Session / Generation** — Could create AiSession class IF memory tables unified, chat orchestration extracted, identity resolved between users and ai_users.

**No fixes proposed. No refactoring performed. Assessment only.**
