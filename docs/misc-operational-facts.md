# Miscellaneous Operational Facts

**Generated:** 2026-02-07 (auto-generated by `scripts/audit-misc.ts`)  
**Purpose:** Phase 0 operational questions — file paths, line numbers, runtime facts

> Run `npx tsx scripts/audit-misc.ts` to regenerate this report.

---

## 1) Express App Creation & Route Mounting

| What | File | Line | Code |
|---|---|---|---|
| App created | `server/index.ts` | 11 | `const app = express();` |
| HTTP server | `server/index.ts` | 13 | `const httpServer = createServer(app);` |
| Trust proxy (index) | `server/index.ts` | 12 | `app.set("trust proxy", 1); // trust first proxy hop only (Replit load balancer)` |
| Routes mounted | `server/index.ts` | 3 | `import { registerRoutes } from "./routes";` |
| Routes mounted | `server/index.ts` | 118 | `await registerRoutes(httpServer, app);` |
| registerRoutes defined | `server/routes.ts` | 324 | `export async function registerRoutes(` |
| Trust proxy (routes) | `server/routes.ts` | 328 | `// trust proxy is set once in server/index.ts — do not duplicate here` |

> **Warning:** `trust proxy` is set twice — once in `index.ts` and once in `routes.ts`. The second call overwrites the first.

---

## 2) TanStack Query Client

**File:** `client/src/lib/queryClient.ts`

| Default | Value |
|---|---|
| `staleTime` | `Infinity` |
| `refetchOnWindowFocus` | `false` |
| `retry` | `false` |
| `on401` | `returnNull` |
| `refetchInterval` | `false` |

**Exports:**
- `apiRequest(method, url, data?)` — shared mutation fetch wrapper (credentials: include, throws on non-OK)
- `getQueryFn({ on401 })` — shared query function (reads queryKey as URL)

---

## 3) Runtime Configuration

| Setting | Value |
|---|---|
| Node version | unknown |
| Module system | module (`package.json "type"`) |
| TS module | ESNext |
| TS moduleResolution | bundler |
| TS strict | true |
| TS noEmit | true |
| TS execution | `tsx` (dev script: `NODE_ENV=development tsx server/index.ts`) |
| Env vars | Replit runtime-injected (no dotenv) |

---

## 4) HTTP Client Wrapper

**File:** `client/src/lib/queryClient.ts`

- `apiRequest()` exported: **YES**
- `getQueryFn()` exported: **YES**

- Pages using raw `fetch()` directly: **55**
- Pages importing `apiRequest`: **9**

Pages bypassing `apiRequest` with raw `fetch()`:
  - `admin-dashboard.tsx`
  - `admin-login.tsx`
  - `admin-repair-queue.tsx`
  - `admin-setup.tsx`
  - `admin.tsx`
  - `affiliate-apply.tsx`
  - `affiliate-dashboard.tsx`
  - `affiliate-login.tsx`
  - `affiliate-nda-panels.tsx`
  - `affiliate-nda.tsx`
  - `affiliate-portal.tsx`
  - `apply-startup-grant.tsx`
  - `apply-website.tsx`
  - `become-investor.tsx`
  - `business-development.tsx`
  - `business-intake.tsx`
  - `businesses.tsx`
  - `claims-navigator.tsx`
  - `contact.tsx`
  - `critical-flow.tsx`
  - `csu-portal.tsx`
  - `csu-sign.tsx`
  - `document-signature.tsx`
  - `forgot-password.tsx`
  - `get-help.tsx`
  - `hipaa-admin.tsx`
  - `index.tsx`
  - `insurance.tsx`
  - `intake-client.tsx`
  - `intake-refer.tsx`
  - `intake.tsx`
  - `investors.tsx`
  - `join.tsx`
  - `login.tsx`
  - `master-portal.tsx`
  - `medical-sales.tsx`
  - `merchant-services.tsx`
  - `my-locker.tsx`
  - `naval-intelligence.tsx`
  - `navigator-elite.tsx`
  - `new-home-furniture.tsx`
  - `notification-console.tsx`
  - `operator-ai.tsx`
  - `pay.tsx`
  - `private-doctor.tsx`
  - `ranger-tab-signup.tsx`
  - `reset-password.tsx`
  - `schedule-a.tsx`
  - `self-repair.tsx`
  - `sign-contract.tsx`
  - `stress-test.tsx`
  - `submaster-portal.tsx`
  - `vendor-portal.tsx`
  - `veteran-intake.tsx`
  - `vgift-cards.tsx`

---

## 5) Auth Guards

**File:** `server/middleware.ts`

| Guard | Line | Roles | MFA Check | Notes |
|---|---|---|---|---|
| `resolveClientIp` | 6 | `master`, `admin`, `affiliate` | YES | IP resolution utility, not an auth guard |
| `requireAdmin` | 10 | `master`, `admin`, `affiliate` | YES |  |
| `requireAffiliate` | 29 | `affiliate` | YES |  |
| `requireAffiliateWithNda` | 43 | `affiliate` | YES | Checks NDA + CONTRACT via getLegalStatus() |

**Note:** There is NO generic `requireAuth` middleware. Routes that need any-user auth check `req.session.userId` inline — **5 occurrences** in `routes.ts`.

---

## 6) Email Sender Helpers

### Defined Helpers

| File | Function | Description |
|---|---|---|
| `server/resendClient.ts` | `getResendClient()` | Returns `{ client: Resend, fromEmail }`. Creates fresh client per call (tokens expire). |
| `server/emailWithRetry.ts` | `sendEmailWithRetry()` | Convenience wrapper — calls getResendClient() + sendEmailWithRetryClient(). |
| `server/emailWithRetry.ts` | `sendEmailWithRetryClient()` | Wraps Resend with retry + exponential backoff (max 3 attempts). |
| `server/daily-digest.ts` | `sendDailyDigest()` | Uses getResendClient() directly for admin digest emails. |
| `server/repair-mailer.ts` | `sendRepairAlert()` | Uses getResendClient() directly for repair system alerts. |

### Usage in routes.ts

- Inline `getResendClient()` calls (no retry): **10** at lines 1474, 1540, 2100, 2700, 4811, 6400, 6504, 6759, 7105, 10829
- `sendEmailWithRetry()` calls (with retry): **3** at lines 187, 1026, 6767

> **Duplication:** `sendEmailWithRetry` exists but most call sites bypass it with direct `getResendClient()` + `resend.emails.send()` — no retry logic.

---

## 7) IP Extraction (req.ip / x-forwarded-for)

### Trust Proxy Status

| File | Line | Value |
|---|---|---|
| `server/index.ts` | 12 | `1);` |
| `server/routes.ts` | 328 | `?` |

> **Warning:** `trust proxy` set twice. The `routes.ts` call overwrites `index.ts`. Final effective value is from routes.ts.

### IP Extraction Patterns

| Pattern | Count | Locations |
|---|---|---|
| `req.ip` (Express built-in, trust-proxy aware) | 22 | `routes.ts:275`, `routes.ts:309`, `routes.ts:1812`, `routes.ts:1840`, `routes.ts:1911`, `routes.ts:3056`, `routes.ts:3113`, `routes.ts:3138`, `routes.ts:3594`, `routes.ts:3690`, `routes.ts:5552`, `routes.ts:6701`, `routes.ts:6808`, `routes.ts:6820`, `routes.ts:6843`, `routes.ts:7042`, `routes.ts:8183`, `routes.ts:8218`, `routes.ts:8281`, `routes.ts:8321`, `routes.ts:8388`, `routes.ts:8425` |
| Manual `x-forwarded-for` header parsing | 13 | `routes.ts:538`, `routes.ts:610`, `routes.ts:980`, `routes.ts:1262`, `routes.ts:3832`, `routes.ts:4480`, `routes.ts:5008`, `routes.ts:5551`, `routes.ts:7507`, `routes.ts:7710`, `routes.ts:7835`, `legal-system.ts:103`, `legal-system.ts:186` |
| `resolveClientIp()` helper | 1 | `routes.ts:21` |

> **Redundancy:** Since `trust proxy` is set, `req.ip` already parses `x-forwarded-for`. The 13 manual extraction sites are redundant and may return different values in edge cases. `resolveClientIp()` exists in middleware.ts but is rarely used.

---

## 8) Drizzle DB Init & Migrations

**File:** `server/db.ts`

| What | Line | Detail |
|---|---|---|
| Schema import | 4 | `import * as schema from "@shared/schema";` |
| Pool created | 14 | `export const pool = new Pool({ connectionString: process.env.DATABASE_URL });` |
| Drizzle init | 15 | `export const db = drizzle({ client: pool, schema });` |

**Exports:** `pool` (raw Neon Pool), `db` (Drizzle client with schema)

**Migration strategy:**
- `db:push` script: **YES** (drizzle-kit push — schema sync without migration files)
- `db:migrate` script: **NO**
- Migration files directory: **NONE** (no versioned migration history)

---

## 9) Test Runner

**None.** No vitest, no jest. Neither is installed in `node_modules` or listed in `package.json`.

---

*No fixes proposed. Report complete. All findings are operational observations.*
